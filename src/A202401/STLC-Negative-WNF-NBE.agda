----------------------------------------------------------------------------------------------------

-- normalization-by-evaluation to Î²-short weak normal form

module A202401.STLC-Negative-WNF-NBE where

open import A202401.STLC-Negative-WNF public
open import A202401.Kit4 public


----------------------------------------------------------------------------------------------------

infix 3 _âŠ©_
_âŠ©_ : Ctx â†’ Ty â†’ Set
W âŠ© A âŒœâŠƒâŒ B = âˆ€ {Wâ€²} â†’ W âŠ‘ Wâ€² â†’ Wâ€² âŠ© A â†’ Wâ€² âŠ© B
W âŠ© A âŒœâˆ§âŒ B = W âŠ© A Ã— W âŠ© B
W âŠ© âŒœğŸ™âŒ     = ğŸ™

vren : âˆ€ {A W Wâ€²} â†’ W âŠ‘ Wâ€² â†’ W âŠ© A â†’ Wâ€² âŠ© A
vren {A âŒœâŠƒâŒ B} Ï± v         = Î» Ï±â€² â†’ v (transâŠ‘ Ï± Ï±â€²)
vren {A âŒœâˆ§âŒ B} Ï± (vâ‚ , vâ‚‚) = vren Ï± vâ‚ , vren Ï± vâ‚‚
vren {âŒœğŸ™âŒ}     Ï± unit      = unit

open ValKit (kit _âŠ©_ vren) public

âŸ¦_âŸ§ : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A â†’ Î“ âŠ¨ A
âŸ¦ var i     âŸ§ Î³ = âŸ¦ i âŸ§âˆ‹ Î³
âŸ¦ âŒœÎ»âŒ t     âŸ§ Î³ = Î» Ï± v â†’ âŸ¦ t âŸ§ (vrenÂ§ Ï± Î³ , v)
âŸ¦ tâ‚ âŒœ$âŒ tâ‚‚ âŸ§ Î³ = âŸ¦ tâ‚ âŸ§ Î³ idâŠ‘ $ âŸ¦ tâ‚‚ âŸ§ Î³
âŸ¦ tâ‚ âŒœ,âŒ tâ‚‚ âŸ§ Î³ = âŸ¦ tâ‚ âŸ§ Î³ , âŸ¦ tâ‚‚ âŸ§ Î³
âŸ¦ âŒœfstâŒ t   âŸ§ Î³ = fst (âŸ¦ t âŸ§ Î³)
âŸ¦ âŒœsndâŒ t   âŸ§ Î³ = snd (âŸ¦ t âŸ§ Î³)
âŸ¦ âŒœunitâŒ    âŸ§ Î³ = unit


----------------------------------------------------------------------------------------------------

mutual
  â†‘ : âˆ€ {A Î“} â†’ Î£ (Î“ âŠ¢ A) NNF â†’ Î“ âŠ© A
  â†‘ {A âŒœâŠƒâŒ B} (_ , pâ‚) = Î» Ï± vâ‚‚ â†’ let _ , pâ‚‚ = â†“ vâ‚‚
                                     in â†‘ (_ , renNNF Ï± pâ‚ âŒœ$âŒ pâ‚‚)
  â†‘ {A âŒœâˆ§âŒ B} (_ , p)  = â†‘ (_ , âŒœfstâŒ p) , â†‘ (_ , âŒœsndâŒ p)
  â†‘ {âŒœğŸ™âŒ}     (_ , p)  = unit

  â†“ : âˆ€ {A Î“} â†’ Î“ âŠ© A â†’ Î£ (Î“ âŠ¢ A) NF
  â†“ {A âŒœâŠƒâŒ B} v         = let t , p = â†“ (v (wkâŠ‘ idâŠ‘) (â†‘ (var zero , var-)))
                            in âŒœÎ»âŒ t , âŒœÎ»âŒ-
  â†“ {A âŒœâˆ§âŒ B} (vâ‚ , vâ‚‚) = let tâ‚ , pâ‚ = â†“ vâ‚
                              tâ‚‚ , pâ‚‚ = â†“ vâ‚‚
                            in tâ‚ âŒœ,âŒ tâ‚‚ , -âŒœ,âŒ-
  â†“ {âŒœğŸ™âŒ}     unit        = _ , âŒœunitâŒ

vidÂ§ : âˆ€ {Î“} â†’ Î“ âŠ©Â§ Î“
vidÂ§ {âˆ™}     = âˆ™
vidÂ§ {Î“ , A} = vrenÂ§ (wkâŠ‘ idâŠ‘) vidÂ§ , â†‘ (var zero , var-)

âŸ¦_âŸ§â»Â¹ : âˆ€ {Î“ A} â†’ Î“ âŠ¨ A â†’ Î£ (Î“ âŠ¢ A) NF
âŸ¦ v âŸ§â»Â¹ = â†“ (v vidÂ§)

nbe : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A â†’ Î£ (Î“ âŠ¢ A) NF
nbe t = âŸ¦ âŸ¦ t âŸ§ âŸ§â»Â¹


----------------------------------------------------------------------------------------------------
