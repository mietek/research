----------------------------------------------------------------------------------------------------

-- normalization-by-evaluation to Î²-short weak normal form, with explicit model

module A202401.STLC-Base-WNF-NBE2 where

open import A202401.STLC-Base-WNF public
open import A202401.Kit4 public


----------------------------------------------------------------------------------------------------

record Model : Setâ‚ where
  field
    World  : Set
    _â‰¤_    : World â†’ World â†’ Set
    reflâ‰¤  : âˆ€ {W} â†’ W â‰¤ W
    transâ‰¤ : âˆ€ {W Wâ€² Wâ€³} â†’ W â‰¤ Wâ€² â†’ Wâ€² â‰¤ Wâ€³ â†’ W â‰¤ Wâ€³
    âŸ¦â—¦âŸ§    : World â†’ Set
    renâŸ¦â—¦âŸ§ : âˆ€ {W Wâ€²} â†’ W â‰¤ Wâ€² â†’ âŸ¦â—¦âŸ§ W â†’ âŸ¦â—¦âŸ§ Wâ€²

open Model public

module _ {â„³ : Model} where
  private
    module â„³ = Model â„³

  infix 3 _âŠ©_
  _âŠ©_ : â„³.World â†’ Ty â†’ Set
  W âŠ© âŒœâ—¦âŒ     = â„³.âŸ¦â—¦âŸ§ W
  W âŠ© A âŒœâŠƒâŒ B = âˆ€ {Wâ€²} â†’ W â„³.â‰¤ Wâ€² â†’ Wâ€² âŠ© A â†’ Wâ€² âŠ© B

  vren : âˆ€ {A W Wâ€²} â†’ W â„³.â‰¤ Wâ€² â†’ W âŠ© A â†’ Wâ€² âŠ© A
  vren {âŒœâ—¦âŒ}     Ï± v = â„³.renâŸ¦â—¦âŸ§ Ï± v
  vren {A âŒœâŠƒâŒ B} Ï± v = Î» Ï±â€² â†’ v (â„³.transâ‰¤ Ï± Ï±â€²)

open ModelKit (kit (Î» {â„³} â†’ _âŠ©_ {â„³}) (Î» {â„³} {A} â†’ vren {â„³} {A})) public

âŸ¦_âŸ§ : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A â†’ Î“ âŠ¨ A
âŸ¦ var i     âŸ§     Î³ = âŸ¦ i âŸ§âˆ‹ Î³
âŸ¦ âŒœÎ»âŒ t     âŸ§     Î³ = Î» Ï± v â†’ âŸ¦ t âŸ§ (vrenÂ§ Ï± Î³ , v)
âŸ¦ tâ‚ âŒœ$âŒ tâ‚‚ âŸ§ {â„³} Î³ = âŸ¦ tâ‚ âŸ§ Î³ (reflâ‰¤ â„³) $ âŸ¦ tâ‚‚ âŸ§ Î³


----------------------------------------------------------------------------------------------------

ğ’ : Model
ğ’ = record
      { World  = Ctx
      ; _â‰¤_    = _âŠ‘_
      ; reflâ‰¤  = reflâŠ‘
      ; transâ‰¤ = transâŠ‘
      ; âŸ¦â—¦âŸ§    = Î» Î“ â†’ Î£ (Î“ âŠ¢ âŒœâ—¦âŒ) NNF
      ; renâŸ¦â—¦âŸ§ = Î» { Ï± (_ , p) â†’ _ , renNNF Ï± p }
      }

mutual
  â†‘ : âˆ€ {A Î“} â†’ Î£ (Î“ âŠ¢ A) NNF â†’ ğ’ / Î“ âŠ© A
  â†‘ {âŒœâ—¦âŒ}     (_ , p)  = _ , p
  â†‘ {A âŒœâŠƒâŒ B} (_ , pâ‚) = Î» Ï± vâ‚‚ â†’ let _ , pâ‚‚ = â†“ vâ‚‚
                                     in â†‘ (_ , renNNF Ï± pâ‚ âŒœ$âŒ pâ‚‚)

  â†“ : âˆ€ {A Î“} â†’ ğ’ / Î“ âŠ© A â†’ Î£ (Î“ âŠ¢ A) NF
  â†“ {âŒœâ—¦âŒ}     (_ , p) = _ , nnf p
  â†“ {A âŒœâŠƒâŒ B} v       = let t , p = â†“ (v (wkâŠ‘ idâŠ‘) (â†‘ {A} (var zero , var-)))
                          in âŒœÎ»âŒ t , âŒœÎ»âŒ-

vidÂ§ : âˆ€ {Î“} â†’ ğ’ / Î“ âŠ©Â§ Î“
vidÂ§ {âˆ™}     = âˆ™
vidÂ§ {Î“ , A} = vrenÂ§ (wkâŠ‘ idâŠ‘) vidÂ§ , â†‘ {A} (var zero , var-)

âŸ¦_âŸ§â»Â¹ : âˆ€ {Î“ A} â†’ Î“ âŠ¨ A â†’ Î£ (Î“ âŠ¢ A) NF
âŸ¦ v âŸ§â»Â¹ = â†“ (v vidÂ§)

nbe : âˆ€ {Î“ A} â†’ Î“ âŠ¢ A â†’ Î£ (Î“ âŠ¢ A) NF
nbe t = âŸ¦ âŸ¦ t âŸ§ âŸ§â»Â¹


----------------------------------------------------------------------------------------------------
