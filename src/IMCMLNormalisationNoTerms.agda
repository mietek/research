module IMCMLNormalisationNoTerms where

open import IMCMLSemanticsNoTerms public


-- TODO
postulate
  â— : âˆ€ {â„“} {X : Set â„“} â†’ X


-- Absolute values.

infix 3 _âŠ¨_
_âŠ¨_ : Cx â†’ Ty â†’ Setâ‚
Î” â Î“ âŠ¨ A = âˆ€ {{_ : Model}} {w : World} â†’
               (âˆ€ {wâ€² : World} â†’ wâ€² Ğ¯ w â†’ wâ€² âŸªâŠ¢âŸ«â‹† âŒˆ Î” âŒ‰) â†’
               (âˆ€ {wâ€² : World} â†’ wâ€² Ğ¯ w â†’ wâ€² âŸªâŠ©âŸ«â‹† âŒˆ Î” âŒ‰) â†’
               w âŠ©â‹† Î“ â†’
               w âŠ© A

infix 3 _âŠ¨â‹†_
_âŠ¨â‹†_ : Cx â†’ Tyâ‹† â†’ Setâ‚
Î” â Î“ âŠ¨â‹† Î = âˆ€ {{_ : Model}} {w : World} â†’
                (âˆ€ {wâ€² : World} â†’ wâ€² Ğ¯ w â†’ wâ€² âŸªâŠ¢âŸ«â‹† âŒˆ Î” âŒ‰) â†’
                (âˆ€ {wâ€² : World} â†’ wâ€² Ğ¯ w â†’ wâ€² âŸªâŠ©âŸ«â‹† âŒˆ Î” âŒ‰) â†’
                w âŠ©â‹† Î“ â†’
                w âŠ©â‹† Î


-- Soundness.

mutual
  âŸ¦_âŸ§ : âˆ€ {Î” Î“ A} â†’ Î” â Î“ âŠ¢ A â†’ Î” â Î“ âŠ¨ A
  âŸ¦ var ğ’¾ âŸ§                       Î´â‚ Î´â‚‚ Î³ = lookupâŠ© Î³ ğ’¾
  âŸ¦ mvar ğ’¾ âŸ§                      Î´â‚ Î´â‚‚ Î³ = mlookupâŸªâŠ©âŸ« (Î´â‚‚ reflĞ¯) (âˆ‹â†’âŒˆâˆ‹âŒ‰ ğ’¾) reflĞ¯ âˆ…
  âŸ¦ lam {A = A} {B} ğ’Ÿ âŸ§           Î´â‚ Î´â‚‚ Î³ = return {A â‡’ B}
                                              Î» Î¸ a â†’
                                                âŸ¦ ğ’Ÿ âŸ§ (Î» Î¶ â†’ Î´â‚ (transĞ¯ Î¶ (âŠ’â†’Ğ¯ Î¸)))
                                                      (Î» Î¶ â†’ Î´â‚‚ (transĞ¯ Î¶ (âŠ’â†’Ğ¯ Î¸)))
                                                      (monoâŠ©â‹† Î¸ Î³ , a)
  âŸ¦ app {A = A} {B} ğ’Ÿ â„° âŸ§         Î´â‚ Î´â‚‚ Î³ = bind {A â‡’ B} {B} (âŸ¦ ğ’Ÿ âŸ§ Î´â‚ Î´â‚‚ Î³)
                                              Î» Î¸ f â†’
                                                f reflâŠ’ (monoâŠ© {A} Î¸ (âŸ¦ â„° âŸ§ Î´â‚ Î´â‚‚ Î³))
  âŸ¦ box {Î¦ = Î¦} {A} ğ’Ÿ âŸ§           Î´â‚ Î´â‚‚ Î³ = return {[ Î¦ ] A}
                                              Î» Î¶ â†’
                                                mgraftâŠ¢ (concatâŸ¨âŠ¢âŸ©â‹† {Î¦} (Î´â‚ Î¶) mreflâŸ¨âŠ¢âŸ©â‹†) ğ’Ÿ ,
                                                Î» Î¶â€² Ï† â†’
                                                  â—
  âŸ¦ unbox {Î¦ = Î¦} {A} {C} Ï† ğ’Ÿ â„° âŸ§ Î´â‚ Î´â‚‚ Î³ = bind {[ Î¦ ] A} {C} (âŸ¦ ğ’Ÿ âŸ§ Î´â‚ Î´â‚‚ Î³)
                                              Î» Î¸ q â†’
                                                âŸ¦ â„° âŸ§ (Î» Î¶ â†’ Î´â‚ (transĞ¯ Î¶ (âŠ’â†’Ğ¯ Î¸)) , â—)
                                                      (Î» Î¶ â†’ Î´â‚‚ (transĞ¯ Î¶ (âŠ’â†’Ğ¯ Î¸)) , â—)
                                                      (monoâŠ©â‹† Î¸ Î³)

  âŸ¦_âŸ§â‹† : âˆ€ {Î” Î“ Î} â†’ Î” â Î“ âŠ¢â‹† Î â†’ Î” â Î“ âŠ¨â‹† Î
  âŸ¦ âˆ… âŸ§â‹†     Î´â‚ Î´â‚‚ Î³ = âˆ…
  âŸ¦ Î¾ , ğ’Ÿ âŸ§â‹† Î´â‚ Î´â‚‚ Î³ = âŸ¦ Î¾ âŸ§â‹† Î´â‚ Î´â‚‚ Î³ , âŸ¦ ğ’Ÿ âŸ§ Î´â‚ Î´â‚‚ Î³


-- Canonical model.

instance
  canon : Model
  canon = record
    { World  = Cx
    ; _âŠ’_    = Î» { (Î”â€² â Î“â€²) (Î” â Î“) â†’ Î”â€² âŠ‡ Î” âˆ§ Î“â€² âŠ‡ Î“ }
    ; reflâŠ’  = reflâŠ‡ , reflâŠ‡
    ; transâŠ’ = Î» { (Î¶â€² , Î·â€²) (Î¶ , Î·) â†’ transâŠ‡ Î¶â€² Î¶ , transâŠ‡ Î·â€² Î· }
    ; _Ğ¯_    = Î» { (Î”â€² â Î“â€²) (Î” â Î“) â†’ Î”â€² âŠ‡ Î” }
    ; reflĞ¯  = reflâŠ‡
    ; transĞ¯ = transâŠ‡
    ; G      = _âŠ¢â¿áµ‰ â€¢
    ; monoG  = Î» { (Î¶ , Î·) ğ’Ÿ â†’ monoâŠ¢â¿áµ‰ Î¶ Î· ğ’Ÿ }
    ; âŠ’â†’Ğ¯   = Ï€â‚
    ; peek   = id
    }

mutual
  reifyá¶œ : âˆ€ {A Î” Î“} â†’ Î” â Î“ âŠ© A â†’ Î” â Î“ âŠ¢â¿á¶  A
  reifyá¶œ {â€¢}       Îº = Îº (reflâŠ‡ , reflâŠ‡)
                         Î» Î¸ a â†’
                           neâ¿á¶  a
  reifyá¶œ {A â‡’ B}  Îº = Îº (reflâŠ‡ , reflâŠ‡)
                         Î» Î¸ f â†’
                           lamâ¿á¶  (reifyá¶œ (f (reflâŠ‡ , weak reflâŠ‡) âŸ¦ varâ¿áµ‰ zero âŸ§á¶œ))
  reifyá¶œ {[ Î¨ ] A} Îº = Îº (reflâŠ‡ , reflâŠ‡)
                         Î» {wâ€³} Î¸ q â†’
                           boxâ¿á¶  (Ï€â‚ (q {wâ€² = wâ€³} reflâŠ‡))

  âŸ¨reifyâŸ©á¶œ : âˆ€ {Î“ Î¦ Î” A} â†’ Î” â Î“ âŸªâŠ©âŸ« [ Î¦ ] A â†’ Î” âŸ¨âŠ¢âŸ©â¿á¶  [ Î¦ ] A
  âŸ¨reifyâŸ©á¶œ {Î“} {Î¦} a = reifyá¶œ (a (weakâŠ‡â§ºâ‚‚ Î¦) (monoâŸ¨âŠ¢âŸ©â‹† (weakâŠ‡â§ºâ‚ Î¦) mreflâŸ¨âŠ¢âŸ©â‹†))

  âŸ¨reifyâŸ©â‹†á¶œ : âˆ€ {Î“ Î Î”} â†’ Î” â Î“ âŸªâŠ©âŸ«â‹† Î â†’ Î” âŸ¨âŠ¢âŸ©â‹†â¿á¶  Î
  âŸ¨reifyâŸ©â‹†á¶œ {Î“} {âˆ…}           âˆ…       = âˆ…
  âŸ¨reifyâŸ©â‹†á¶œ {Î“} {Î , [ Î¦ ] A} (Î¾ , a) = âŸ¨reifyâŸ©â‹†á¶œ {Î“} Î¾ , âŸ¨reifyâŸ©á¶œ {Î“} {Î¦} a

  âŸ¦_âŸ§á¶œ : âˆ€ {A Î” Î“} â†’ Î” â Î“ âŠ¢â¿áµ‰ A â†’ Î” â Î“ âŠ© A
  âŸ¦_âŸ§á¶œ {â€¢}       ğ’Ÿ = return {â€¢} ğ’Ÿ
  âŸ¦_âŸ§á¶œ {A â‡’ B}  ğ’Ÿ = return {A â‡’ B}
                       Î» { (Î¶ , Î·) a â†’
                         âŸ¦ appâ¿áµ‰ (monoâŠ¢â¿áµ‰ Î¶ Î· ğ’Ÿ) (reifyá¶œ a) âŸ§á¶œ }
  âŸ¦_âŸ§á¶œ {[ Î¨ ] A} ğ’Ÿ = Î» { (Î¶ , Î·) Îº â†’
                       neâ¿á¶  (unboxâ¿áµ‰ â—
                                     (monoâŠ¢â¿áµ‰ Î¶ Î· ğ’Ÿ)
                                     (Îº (weak reflâŠ‡ , reflâŠ‡)
                                        Î» Î¶â€² â†’
                                          â— ,
                                          â—)) }


-- TODO: Needs a name.

reflâŠ©â‹† : âˆ€ {Î“ Î” : Tyâ‹†} â†’ Î” â Î“ âŠ©â‹† Î“
reflâŠ©â‹† {âˆ…}     = âˆ…
reflâŠ©â‹† {Î“ , A} = monoâŠ©â‹† (reflâŠ‡ , weak reflâŠ‡) reflâŠ©â‹† , âŸ¦ varâ¿áµ‰ zero âŸ§á¶œ

mreflâŸªâŠ©âŸ«â‹† : âˆ€ {Î“ Î” : Tyâ‹†} â†’ Î” â Î“ âŸªâŠ©âŸ«â‹† âŒˆ Î” âŒ‰
mreflâŸªâŠ©âŸ«â‹† {Î“} {âˆ…}     = âˆ…
mreflâŸªâŠ©âŸ«â‹† {Î“} {Î” , A} = monoâŸªâŠ©âŸ«â‹† {w = _ â Î“} (weak reflâŠ‡ , reflâŠ‡) (mreflâŸªâŠ©âŸ«â‹† {Î“}) ,
                           Î» Î¶ Ï† â†’
                             âŸ¦ mvarâ¿áµ‰ (monoâˆ‹ Î¶ zero) âŸ§á¶œ


-- Completeness.

reify : âˆ€ {Î“ Î” A} â†’ Î” â Î“ âŠ¨ A â†’ Î” â Î“ âŠ¢â¿á¶  A
reify {Î“} ğ” = reifyá¶œ (ğ” (Î» Î¶ â†’ monoâŸ¨âŠ¢âŸ©â‹† Î¶ mreflâŸ¨âŠ¢âŸ©â‹†)
                     (Î» Î¶ â†’ monoâŸªâŠ©âŸ«â‹† {w = _ â Î“} (Î¶ , reflâŠ‡) (mreflâŸªâŠ©âŸ«â‹† {Î“}))
                     reflâŠ©â‹†)


-- Normalisation.

nbe : âˆ€ {Î” Î“ A} â†’ Î” â Î“ âŠ¢ A â†’ Î” â Î“ âŠ¢â¿á¶  A
nbe = reify âˆ˜ âŸ¦_âŸ§
