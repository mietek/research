module IS4NormalisationNoTerms where

open import IS4SemanticsNoTerms public


-- Absolute values.

infix 3 _âŠ¨_
_âŠ¨_ : Cx â†’ Ty â†’ Setâ‚
Î” â Î“ âŠ¨ A = âˆ€ {{_ : Model}} {w} â†’
               (âˆ€ {wâ€²} â†’ wâ€² Ğ¯ w â†’ wâ€² [âŠ©â‚]â‹† Î”) â†’
               (âˆ€ {wâ€²} â†’ wâ€² Ğ¯ w â†’ wâ€² [âŠ©â‚‚]â‹† Î”) â†’
               w âŠ©â‹† Î“ â†’
               w âŠ© A


-- Soundness.

âŸ¦_âŸ§ : âˆ€ {Î” Î“ A} â†’ Î” â Î“ âŠ¢ A â†’ Î” â Î“ âŠ¨ A
âŸ¦ var ğ’¾ âŸ§                 Î´â‚ Î´â‚‚ Î³ = lookupâŠ© Î³ ğ’¾
âŸ¦ mvar ğ’¾ âŸ§                Î´â‚ Î´â‚‚ Î³ = mlookup[âŠ©â‚‚] (Î´â‚‚ reflĞ¯) ğ’¾
âŸ¦ lam {A = A} {B} ğ’Ÿ âŸ§     Î´â‚ Î´â‚‚ Î³ = return {A â‡’ B}
                                      Î» Î¸ a â†’
                                        âŸ¦ ğ’Ÿ âŸ§ (Î» Î¶ â†’ Î´â‚ (transĞ¯ Î¶ (âŠ’â†’Ğ¯ Î¸)))
                                              (Î» Î¶ â†’ Î´â‚‚ (transĞ¯ Î¶ (âŠ’â†’Ğ¯ Î¸)))
                                              (monoâŠ©â‹† Î¸ Î³ , a)
âŸ¦ app {A = A} {B} ğ’Ÿ â„° âŸ§   Î´â‚ Î´â‚‚ Î³ = bind {A â‡’ B} {B} (âŸ¦ ğ’Ÿ âŸ§ Î´â‚ Î´â‚‚ Î³)
                                      Î» Î¸ f â†’
                                        f reflâŠ’ (monoâŠ© {A} Î¸ (âŸ¦ â„° âŸ§ Î´â‚ Î´â‚‚ Î³))
âŸ¦ box {A = A} ğ’Ÿ âŸ§         Î´â‚ Î´â‚‚ Î³ = return {â–¡ A}
                                      Î» Î¶ â†’
                                        mgraftâŠ¢ (Î´â‚ Î¶) ğ’Ÿ ,
                                        âŸ¦ ğ’Ÿ âŸ§ (Î» Î¶â€² â†’ Î´â‚ (transĞ¯ Î¶â€² Î¶))
                                              (Î» Î¶â€² â†’ Î´â‚‚ (transĞ¯ Î¶â€² Î¶))
                                              âˆ…
âŸ¦ unbox {A = A} {C} ğ’Ÿ â„° âŸ§ Î´â‚ Î´â‚‚ Î³ = bind {â–¡ A} {C} (âŸ¦ ğ’Ÿ âŸ§ Î´â‚ Î´â‚‚ Î³)
                                      Î» Î¸ q â†’
                                        âŸ¦ â„° âŸ§ (Î» Î¶ â†’ Î´â‚ (transĞ¯ Î¶ (âŠ’â†’Ğ¯ Î¸)) , Ï€â‚ (q Î¶))
                                              (Î» Î¶ â†’ Î´â‚‚ (transĞ¯ Î¶ (âŠ’â†’Ğ¯ Î¸)) , Ï€â‚‚ (q Î¶))
                                              (monoâŠ©â‹† Î¸ Î³)


-- Canonical model.

instance
  canon : Model
  canon = record
    { World  = Cx
    ; _âŠ’_    = Î» { (Î”â€² â Î“â€²) (Î” â Î“) â†’ Î”â€² âŠ‡ Î” âˆ§ Î“â€² âŠ‡ Î“ }
    ; reflâŠ’  = reflâŠ‡ , reflâŠ‡
    ; transâŠ’ = Î» { (Î¶â€² , Î·â€²) (Î¶ , Î·) â†’ transâŠ‡ Î¶â€² Î¶ , transâŠ‡ Î·â€² Î· }
    ; _Ğ¯_    = Î» { (Î”â€² â Î“â€²) (Î” â Î“) â†’ Î”â€² âŠ‡ Î” }
    ; reflĞ¯  = reflâŠ‡
    ; transĞ¯ = transâŠ‡
    ; G      = _âŠ¢â¿áµ‰ â€¢
    ; monoG  = Î» { (Î¶ , Î·) ğ’Ÿ â†’ monoâŠ¢â¿áµ‰ Î¶ Î· ğ’Ÿ }
    ; âŠ’â†’Ğ¯   = Ï€â‚
    ; peek   = id
    }

mutual
  reifyá¶œ : âˆ€ {A Î” Î“} â†’ Î” â Î“ âŠ© A â†’ Î” â Î“ âŠ¢â¿á¶  A
  reifyá¶œ {â€¢}      Îº = Îº (reflâŠ‡ , reflâŠ‡)
                        Î» Î¸ a â†’
                          neâ¿á¶  a
  reifyá¶œ {A â‡’ B} Îº = Îº (reflâŠ‡ , reflâŠ‡)
                        Î» Î¸ f â†’
                          lamâ¿á¶  (reifyá¶œ (f (reflâŠ‡ , weak reflâŠ‡) âŸ¦ varâ¿áµ‰ zero âŸ§á¶œ))
  reifyá¶œ {â–¡ A}    Îº = Îº (reflâŠ‡ , reflâŠ‡)
                        Î» {wâ€³} Î¸ q â†’
                          boxâ¿á¶  (Ï€â‚ (q {wâ€² = wâ€³} reflâŠ‡))

  âŸ¦_âŸ§á¶œ : âˆ€ {A Î” Î“} â†’ Î” â Î“ âŠ¢â¿áµ‰ A â†’ Î” â Î“ âŠ© A
  âŸ¦_âŸ§á¶œ {â€¢}      ğ’Ÿ = return {â€¢} ğ’Ÿ
  âŸ¦_âŸ§á¶œ {A â‡’ B} ğ’Ÿ = return {A â‡’ B}
                      Î» { (Î¶ , Î·) a â†’
                        âŸ¦ appâ¿áµ‰ (monoâŠ¢â¿áµ‰ Î¶ Î· ğ’Ÿ) (reifyá¶œ a) âŸ§á¶œ }
  âŸ¦_âŸ§á¶œ {â–¡ A}    ğ’Ÿ = Î» { (Î¶ , Î·) Îº â†’
                      neâ¿á¶  (unboxâ¿áµ‰ (monoâŠ¢â¿áµ‰ Î¶ Î· ğ’Ÿ)
                                    (Îº (weak reflâŠ‡ , reflâŠ‡)
                                       Î» Î¶â€² â†’
                                         monoâŠ¢ Î¶â€² reflâŠ‡ (mvar zero) ,
                                         âŸ¦ monoâŠ¢â¿áµ‰ Î¶â€² reflâŠ‡ (mvarâ¿áµ‰ zero) âŸ§á¶œ)) }

-- Lists of values, continued.

reflâŠ©â‹† : âˆ€ {Î” Î“} â†’ Î” â Î“ âŠ©â‹† Î“
reflâŠ©â‹† {Î“ = âˆ…}     = âˆ…
reflâŠ©â‹† {Î“ = Î“ , A} = monoâŠ©â‹† (reflâŠ‡ , weak reflâŠ‡) reflâŠ©â‹† , âŸ¦ varâ¿áµ‰ zero âŸ§á¶œ


-- TODO: Needs a name, continued.

mono[âŠ©â‚] : âˆ€ {w wâ€² A} â†’ wâ€² âŠ’ w â†’ w [âŠ©â‚] â–¡ A â†’ wâ€² [âŠ©â‚] â–¡ A
mono[âŠ©â‚] (Î¶ , Î·) ğ’Ÿ = mono[âŠ¢] Î¶ Î· ğ’Ÿ

mono[âŠ©â‚]â‹† : âˆ€ {w wâ€² Î} â†’ wâ€² âŠ’ w â†’ w [âŠ©â‚]â‹† Î â†’ wâ€² [âŠ©â‚]â‹† Î
mono[âŠ©â‚]â‹† (Î¶ , Î·) Î¾ = mono[âŠ¢]â‹† Î¶ Î· Î¾

mrefl[âŠ©â‚]â‹† : âˆ€ {w} â†’ w [âŠ©â‚]â‹† Ï€â‚ w
mrefl[âŠ©â‚]â‹† {w} = mrefl[âŠ¢]â‹† {Î“ = Ï€â‚‚ w}


-- TODO: Needs a name, continued.

mono[âŠ©â‚‚] : âˆ€ {A w wâ€²} â†’ wâ€² âŠ’ w â†’ w [âŠ©â‚‚] â–¡ A â†’ wâ€² [âŠ©â‚‚] â–¡ A
mono[âŠ©â‚‚] {A} Î¸ q = monoâŠ© {A} Î¸ q

mono[âŠ©â‚‚]â‹† : âˆ€ {Î w wâ€²} â†’ wâ€² âŠ’ w â†’ w [âŠ©â‚‚]â‹† Î â†’ wâ€² [âŠ©â‚‚]â‹† Î
mono[âŠ©â‚‚]â‹† {âˆ…}       Î¸ âˆ…       = âˆ…
mono[âŠ©â‚‚]â‹† {Î , â–¡ A} Î¸ (Î¾ , q) = mono[âŠ©â‚‚]â‹† Î¸ Î¾ , mono[âŠ©â‚‚] {A} Î¸ q
-- TODO: Equivalent using mapAll?

mrefl[âŠ©â‚‚]â‹† : âˆ€ {w} â†’ w [âŠ©â‚‚]â‹† Ï€â‚ w
mrefl[âŠ©â‚‚]â‹† {âˆ…       â Î“} = âˆ…
mrefl[âŠ©â‚‚]â‹† {Î” , â–¡ A â Î“} = mono[âŠ©â‚‚]â‹† (weak reflâŠ‡ , reflâŠ‡) mrefl[âŠ©â‚‚]â‹† ,
                            âŸ¦ mvarâ¿áµ‰ zero âŸ§á¶œ


-- Completeness.

reify : âˆ€ {Î” Î“ A} â†’ Î” â Î“ âŠ¨ A â†’ Î” â Î“ âŠ¢â¿á¶  A
reify ğ” = reifyá¶œ (ğ” (Î» { {_ â Î“Â°} Î¶ â†’
                       mono[âŠ©â‚]â‹† {w = _ â Î“Â°} (Î¶ , reflâŠ‡) (mrefl[âŠ©â‚]â‹† {w = _ â Î“Â°}) })
                    (Î» Î¶ â†’
                      mono[âŠ©â‚‚]â‹† (Î¶ , reflâŠ‡) mrefl[âŠ©â‚‚]â‹†)
                    reflâŠ©â‹†)


-- Normalisation.

nbe : âˆ€ {Î” Î“ A} â†’ Î” â Î“ âŠ¢ A â†’ Î” â Î“ âŠ¢â¿á¶  A
nbe = reify âˆ˜ âŸ¦_âŸ§
