module StdS4Semantics where

open import Prelude
open import List
open import StdS4
open import StdS4NormalForms


--------------------------------------------------------------------------------


record Model : Setâ‚
  where
    field
      World : Set

      Ground : World â†’ Set

      _â‰¥_ : World â†’ World â†’ Set

      idâ‰¥ : âˆ€ {W} â†’ W â‰¥ W

      _âˆ˜â‰¥_ : âˆ€ {W Wâ€² Wâ€³} â†’ Wâ€² â‰¥ W â†’ Wâ€³ â‰¥ Wâ€²
                         â†’ Wâ€³ â‰¥ W

      relG : âˆ€ {W Wâ€²} â†’ Wâ€² â‰¥ W â†’ Ground W
                      â†’ Ground Wâ€²

      âŒŠ_âŒ‹ : World â†’ Context

      âŒŠ_âŒ‹â‰¥ : âˆ€ {W Wâ€²} â†’ Wâ€² â‰¥ W
                      â†’ âŒŠ Wâ€² âŒ‹ âŠ‡Â² âŒŠ W âŒ‹

open Model {{...}}


--------------------------------------------------------------------------------


âŒŠ_âŒ‹â‚ : âˆ€ {{_ : Model}} â†’ World â†’ List Validity
âŒŠ W âŒ‹â‚ = Context.Î” âŒŠ W âŒ‹


âŒŠ_âŒ‹â‰¥â‚ : âˆ€ {{_ : Model}} {W Wâ€²} â†’ Wâ€² â‰¥ W
                               â†’ âŒŠ Wâ€² âŒ‹â‚ âŠ‡ âŒŠ W âŒ‹â‚
âŒŠ Î· âŒ‹â‰¥â‚ = projâ‚ âŒŠ Î· âŒ‹â‰¥


--------------------------------------------------------------------------------


mutual
  infix 3 _âŠ©_
  _âŠ©_ : âˆ€ {{_ : Model}} â†’ World â†’ Truth â†’ Set
  W âŠ© BASE true  = Ground W
  W âŠ© A âŠƒ B true = âˆ€ {Wâ€²} â†’ Wâ€² â‰¥ W â†’ Wâ€² âŠª A true
                           â†’ Wâ€² âŠª B true
  W âŠ© â–¡ A true   = W âŠªâ‚ A valid

  infix 3 _âŠª_
  _âŠª_ : âˆ€ {{_ : Model}} â†’ World â†’ Truth â†’ Set
  W âŠª A true = âˆ€ {B Wâ€²} â†’ Wâ€² â‰¥ W â†’ (âˆ€ {Wâ€³} â†’ Wâ€³ â‰¥ Wâ€² â†’ Wâ€³ âŠ© A true
                                              â†’ âŒŠ Wâ€³ âŒ‹ âŠ¢â‚™â‚˜ B)
                         â†’ âŒŠ Wâ€² âŒ‹ âŠ¢â‚™â‚˜ B

  infix 3 _âŠªâ‚_
  _âŠªâ‚_ : âˆ€ {{_ : Model}} â†’ World â†’ Validity â†’ Set
  W âŠªâ‚ A valid = âŒŠ W âŒ‹â‚ âŠ¢â‚ A valid Ã— W âŠª A true


syn : âˆ€ {{_ : Model}} {A W} â†’ W âŠªâ‚ A valid
                            â†’ âŒŠ W âŒ‹â‚ âŠ¢â‚ A valid
syn v = projâ‚ v


sem : âˆ€ {{_ : Model}} {A W} â†’ W âŠªâ‚ A valid
                           â†’ W âŠª A true
sem v = projâ‚‚ v


--------------------------------------------------------------------------------


mutual
  rel : âˆ€ {{_ : Model}} {Aâ‚œ W Wâ€²} â†’ Wâ€² â‰¥ W â†’ W âŠ© Aâ‚œ
                                  â†’ Wâ€² âŠ© Aâ‚œ
  rel {BASE true}  Î· ğ’Ÿ = relG Î· ğ’Ÿ
  rel {A âŠƒ B true} Î· f = \ Î·â€² k â†’ f (Î· âˆ˜â‰¥ Î·â€²) k
  rel {â–¡ A true}   Î· v = crelâ‚ Î· v

  crel : âˆ€ {{_ : Model}} {Aâ‚œ W Wâ€²} â†’ Wâ€² â‰¥ W â†’ W âŠª Aâ‚œ
                                   â†’ Wâ€² âŠª Aâ‚œ
  crel Î· k = \ Î·â€² f â†’ k (Î· âˆ˜â‰¥ Î·â€²) f

  crelâ‚ : âˆ€ {{_ : Model}} {Aáµ¥ W Wâ€²} â†’ Wâ€² â‰¥ W â†’ W âŠªâ‚ Aáµ¥
                                    â†’ Wâ€² âŠªâ‚ Aáµ¥
  crelâ‚ {A valid} Î· v = mren âŒŠ Î· âŒ‹â‰¥â‚ (syn v) ,
                        crel {A true} Î· (sem v)


--------------------------------------------------------------------------------


infix 3 _âŠªâ‹†_
_âŠªâ‹†_ : âˆ€ {{_ : Model}} â†’ World â†’ List Truth â†’ Set
W âŠªâ‹† Î“ = All (W âŠª_) Î“


infix 3 _âŠªâ‹†â‚_
_âŠªâ‹†â‚_ : âˆ€ {{_ : Model}} â†’ World â†’ List Validity â†’ Set
W âŠªâ‹†â‚ Î” = All (W âŠªâ‚_) Î”


syns : âˆ€ {{_ : Model}} {Î” W} â†’ W âŠªâ‹†â‚ Î”
                             â†’ âŒŠ W âŒ‹â‚ âŠ¢â‹†â‚ Î”
syns Î´ = mapAll syn Î´


--------------------------------------------------------------------------------


crels : âˆ€ {{_ : Model}} {Î“ W Wâ€²} â†’ Wâ€² â‰¥ W â†’ W âŠªâ‹† Î“
                                 â†’ Wâ€² âŠªâ‹† Î“
crels Î· Î³ = mapAll (\ {Aâ‚œ} k {B} {Wâ€²} â†’ crel {Aâ‚œ} Î· (\ {C} {Wâ€³} â†’ k {C} {Wâ€³})) Î³
-- NOTE: Equivalent to
-- crels Î· Î³ = mapAll (crel Î·) Î³


crelsâ‚ : âˆ€ {{_ : Model}} {Î” W Wâ€²} â†’ Wâ€² â‰¥ W â†’ W âŠªâ‹†â‚ Î”
                                  â†’ Wâ€² âŠªâ‹†â‚ Î”
crelsâ‚ Î· Î´ = mapAll (crelâ‚ Î·) Î´


--------------------------------------------------------------------------------


return : âˆ€ {{_ : Model}} {A W} â†’ W âŠ© A true
                               â†’ W âŠª A true
return {A} a = \ Î· f â†’ f idâ‰¥ (rel {A true} Î· a)


bind : âˆ€ {{_ : Model}} {A B W} â†’ W âŠª A true â†’ (âˆ€ {Wâ€²} â†’ Wâ€² â‰¥ W â†’ Wâ€² âŠ© A true
                                                         â†’ Wâ€² âŠª B true)
                               â†’ W âŠª B true
bind k f = \ Î· fâ€² â†’
             k Î· (\ Î·â€² a â†’
               f (Î· âˆ˜â‰¥ Î·â€²) a idâ‰¥ (\ Î·â€³ b â†’
                 fâ€² (Î·â€² âˆ˜â‰¥ Î·â€³) b))


--------------------------------------------------------------------------------


infix 3 _âŠ¨_
_âŠ¨_ : Context â†’ Truth â†’ Setâ‚
Î” â¨¾ Î“ âŠ¨ A true = âˆ€ {{_ : Model}} {W} â†’ W âŠªâ‹†â‚ Î” â†’ W âŠªâ‹† Î“
                                      â†’ W âŠª A true


â†“ : âˆ€ {Î” Î“ A} â†’ Î” â¨¾ Î“ âŠ¢ A true
              â†’ Î” â¨¾ Î“ âŠ¨ A true
â†“ (var ğ’¾)              Î´ Î³ = lookup Î³ ğ’¾
â†“ (lam {A} {B} ğ’Ÿ)      Î´ Î³ = return {A âŠƒ B} (\ Î· k â†’
                               â†“ ğ’Ÿ (crelsâ‚ Î· Î´) (crels Î· Î³ , k))
â†“ (app {A} {B} ğ’Ÿ â„°)    Î´ Î³ = bind {A âŠƒ B} {B} (â†“ ğ’Ÿ Î´ Î³) (\ Î· f â†’
                               f idâ‰¥ (â†“ â„° (crelsâ‚ Î· Î´) (crels Î· Î³)))
â†“ (mvar ğ’¾)             Î´ Î³ = sem (lookup Î´ ğ’¾)
â†“ (box {A} ğ’Ÿ)          Î´ Î³ = return {â–¡ A} (msub (syns Î´) ğ’Ÿ , â†“ ğ’Ÿ Î´ âˆ™)
â†“ (letbox {A} {B} ğ’Ÿ â„°) Î´ Î³ = bind {â–¡ A} {B} (â†“ ğ’Ÿ Î´ Î³) (\ Î· v â†’
                               â†“ â„° (crelsâ‚ Î· Î´ , v) (crels Î· Î³))


--------------------------------------------------------------------------------


instance
  canon : Model
  canon = record
            { World  = Context
            ; Ground = _âŠ¢â‚™â‚œ BASE true
            ; _â‰¥_    = _âŠ‡Â²_
            ; idâ‰¥    = idâŠ‡Â²
            ; _âˆ˜â‰¥_   = _âˆ˜âŠ‡Â²_
            ; relG   = renâ‚™â‚œÂ²
            ; âŒŠ_âŒ‹    = id
            ; âŒŠ_âŒ‹â‰¥   = id
            }


mutual
  â‡“ : âˆ€ {A Î” Î“} â†’ Î” â¨¾ Î“ âŠ¢â‚™â‚œ A true
                â†’ Î” â¨¾ Î“ âŠª A true
  â‡“ {BASE}  ğ’Ÿ = return {BASE} ğ’Ÿ
  â‡“ {A âŠƒ B} ğ’Ÿ = return {A âŠƒ B} (\ Î· k â†’ â‡“ (app (renâ‚™â‚œÂ² Î· ğ’Ÿ) (â‡‘ k)))
  â‡“ {â–¡ A}   ğ’Ÿ = \ Î· f â†’ letbox (renâ‚™â‚œÂ² Î· ğ’Ÿ) (f (mdropâŠ‡Â² idâŠ‡Â²) (mvz , â‡“ mvzâ‚™â‚œ))

  â‡‘ : âˆ€ {A Î” Î“} â†’ Î” â¨¾ Î“ âŠª A true
                â†’ Î” â¨¾ Î“ âŠ¢â‚™â‚˜ A true
  â‡‘ {BASE}  k = k idâŠ‡Â² (\ Î· ğ’Ÿ â†’ nt ğ’Ÿ)
  â‡‘ {A âŠƒ B} k = k idâŠ‡Â² (\ Î· f â†’ lam (â‡‘ (f (dropâŠ‡Â² idâŠ‡Â²) (â‡“ vzâ‚™â‚œ))))
  â‡‘ {â–¡ A}   k = k idâŠ‡Â² (\ Î· v â†’ box (syn v))


--------------------------------------------------------------------------------


swk : âˆ€ {A B Î” Î“} â†’ Î” â¨¾ Î“ âŠª A true
                  â†’ Î” â¨¾ Î“ , B true âŠª A true
swk {A} k = crel {A true} (dropâŠ‡Â² idâŠ‡Â²) k


svz : âˆ€ {A Î” Î“} â†’ Î” â¨¾ Î“ , A true âŠª A true
svz = â‡“ vzâ‚™â‚œ


--------------------------------------------------------------------------------


smwk : âˆ€ {A B Î” Î“} â†’ Î” â¨¾ Î“ âŠª A true
                   â†’ Î” , B valid â¨¾ Î“ âŠª A true
smwk {A} k = crel {A true} (mdropâŠ‡Â² idâŠ‡Â²) k


smvz : âˆ€ {A Î” Î“} â†’ Î” , A valid â¨¾ Î“ âŠª A true
smvz = â‡“ mvzâ‚™â‚œ


--------------------------------------------------------------------------------


swks : âˆ€ {A Î” Î“ Î} â†’ Î” â¨¾ Î“ âŠªâ‹† Î
                   â†’ Î” â¨¾ Î“ , A true âŠªâ‹† Î
swks Î¾ = crels (dropâŠ‡Â² idâŠ‡Â²) Î¾


slifts : âˆ€ {A Î” Î“ Î} â†’ Î” â¨¾ Î“ âŠªâ‹† Î
                     â†’ Î” â¨¾ Î“ , A true âŠªâ‹† Î , A true
slifts Î¾ = swks Î¾ , svz


sids : âˆ€ {Î” Î“} â†’ Î” â¨¾ Î“ âŠªâ‹† Î“
sids {Î“ = âˆ™}          = âˆ™
sids {Î“ = Î“ , A true} = slifts sids


--------------------------------------------------------------------------------


smwks : âˆ€ {A Î” Î“ Î} â†’ Î” â¨¾ Î“ âŠªâ‹† Î
                    â†’ Î” , A valid â¨¾ Î“ âŠªâ‹† Î
smwks Î¾ = crels (mdropâŠ‡Â² idâŠ‡Â²) Î¾


--------------------------------------------------------------------------------


smwksâ‚ : âˆ€ {A Î” Î“ Î} â†’ Î” â¨¾ Î“ âŠªâ‹†â‚ Î
                     â†’ Î” , A valid â¨¾ Î“ âŠªâ‹†â‚ Î
smwksâ‚ Î¾ = crelsâ‚ (mdropâŠ‡Â² idâŠ‡Â²) Î¾


smvzâ‚ : âˆ€ {A Î” Î“} â†’ Î” , A valid â¨¾ Î“ âŠªâ‚ A valid
smvzâ‚ = mvz , smvz


smliftsâ‚ : âˆ€ {A Î” Î“ Î} â†’ Î” â¨¾ Î“ âŠªâ‹†â‚ Î
                       â†’ Î” , A valid â¨¾ Î“ âŠªâ‹†â‚ Î , A valid
smliftsâ‚ Î¾ = smwksâ‚ Î¾ , smvzâ‚


smidsâ‚ : âˆ€ {Î” Î“} â†’ Î” â¨¾ Î“ âŠªâ‹†â‚ Î”
smidsâ‚ {âˆ™}           = âˆ™
smidsâ‚ {Î” , A valid} = smliftsâ‚ smidsâ‚


--------------------------------------------------------------------------------


â†‘ : âˆ€ {Î” Î“ A} â†’ Î” â¨¾ Î“ âŠ¨ A true
              â†’ Î” â¨¾ Î“ âŠ¢â‚™â‚˜ A true
â†‘ f = â‡‘ (f smidsâ‚ sids)


nbe : âˆ€ {Î” Î“ A} â†’ Î” â¨¾ Î“ âŠ¢ A true
                â†’ Î” â¨¾ Î“ âŠ¢â‚™â‚˜ A true
nbe ğ’Ÿ = â†‘ (â†“ ğ’Ÿ)


--------------------------------------------------------------------------------
