module StdCMLSemantics where

open import Prelude
open import Category
open import List
open import ListLemmas
open import AllList
open import StdCML
open import StdCMLNormalForms


--------------------------------------------------------------------------------


record Model : Setâ‚
  where
    field
      World : Set

      Ground : World â†’ Set

      _â‰¥_ : World â†’ World â†’ Set

      idâ‰¥ : âˆ€ {W} â†’ W â‰¥ W

      _âˆ˜â‰¥_ : âˆ€ {W Wâ€² Wâ€³} â†’ Wâ€² â‰¥ W â†’ Wâ€³ â‰¥ Wâ€²
                         â†’ Wâ€³ â‰¥ W

      relG : âˆ€ {W Wâ€²} â†’ Wâ€² â‰¥ W â†’ Ground W
                      â†’ Ground Wâ€²

      âŒŠ_âŒ‹ : World â†’ ListÂ² Validity Truth

      âŒŠ_âŒ‹â‰¥ : âˆ€ {W Wâ€²} â†’ Wâ€² â‰¥ W
                      â†’ âŒŠ Wâ€² âŒ‹ âŠ‡Â² âŒŠ W âŒ‹

open Model {{...}}


--------------------------------------------------------------------------------


âŒŠ_âŒ‹â‚ : âˆ€ {{_ : Model}} â†’ World â†’ List Validity
âŒŠ W âŒ‹â‚ = projâ‚ âŒŠ W âŒ‹


âŒŠ_âŒ‹â‰¥â‚ : âˆ€ {{_ : Model}} {W Wâ€²} â†’ Wâ€² â‰¥ W
                               â†’ âŒŠ Wâ€² âŒ‹â‚ âŠ‡ âŒŠ W âŒ‹â‚
âŒŠ Î· âŒ‹â‰¥â‚ = projâ‚ âŒŠ Î· âŒ‹â‰¥


--------------------------------------------------------------------------------


mutual
  infix 3 _âŠ©_
  _âŠ©_ : âˆ€ {{_ : Model}} â†’ World â†’ Truth â†’ Set
  W âŠ© BASE true    = Ground W
  W âŠ© A âŠƒ B true   = âˆ€ {Wâ€²} â†’ Wâ€² â‰¥ W â†’ Wâ€² âŠª A true
                             â†’ Wâ€² âŠª B true
  W âŠ© [ Î¨ ] A true = âˆ€ {Wâ€²} â†’ Wâ€² â‰¥ W â†’ Wâ€² âŠªâ‚ A valid[ Î¨ ]

  infix 3 _âŠª_
  _âŠª_ : âˆ€ {{_ : Model}} â†’ World â†’ Truth â†’ Set
  W âŠª A true = âˆ€ {B Wâ€²} â†’ Wâ€² â‰¥ W â†’ (âˆ€ {Wâ€³} â†’ Wâ€³ â‰¥ Wâ€² â†’ Wâ€³ âŠ© A true
                                              â†’ âŒŠ Wâ€³ âŒ‹ âŠ¢â‚™â‚˜ B)
                         â†’ âŒŠ Wâ€² âŒ‹ âŠ¢â‚™â‚˜ B

  infix 3 _âŠªâ‚_
  _âŠªâ‚_ : âˆ€ {{_ : Model}} â†’ World â†’ Validity â†’ Set
  W âŠªâ‚ A valid[ Î¨ ] = âŒŠ W âŒ‹â‚ âŠ¢â‚ A valid[ Î¨ ] Ã— (âˆ€ {Wâ€²} â†’ Wâ€² â‰¥ W â†’ Wâ€² âŠªâ‹† Î¨
                                                         â†’ Wâ€² âŠª A true)

  infix 3 _âŠªâ‹†_
  _âŠªâ‹†_ : âˆ€ {{_ : Model}} â†’ World â†’ List Truth â†’ Set
  W âŠªâ‹† âˆ™          = âŠ¤
  W âŠªâ‹† Î“ , A true = W âŠªâ‹† Î“ Ã— W âŠª A true
  -- NOTE: Equivalent to
  -- W âŠªâ‹† Î“ = All (W âŠª_) Î“


cget : âˆ€ {{_ : Model}} {Î“ A W} â†’ W âŠªâ‹† Î“ â†’ Î“ âˆ‹ A true
                               â†’ W âŠª A true
cget {Î“ , A true} (Î³ , a) zero    = a
cget {Î“ , B true} (Î³ , b) (suc ğ’¾) = cget Î³ ğ’¾
-- NOTE: Equivalent to get


syn : âˆ€ {{_ : Model}} {A Î¨ W} â†’ W âŠªâ‚ A valid[ Î¨ ]
                              â†’ âŒŠ W âŒ‹â‚ âŠ¢â‚ A valid[ Î¨ ]
syn v = projâ‚ v


sem : âˆ€ {{_ : Model}} {A Î¨ W} â†’ W âŠªâ‚ A valid[ Î¨ ]
                              â†’ (âˆ€ {Wâ€²} â†’ Wâ€² â‰¥ W â†’ Wâ€² âŠªâ‹† Î¨
                                         â†’ Wâ€² âŠª A true)
sem v = projâ‚‚ v


--------------------------------------------------------------------------------


mutual
  rel : âˆ€ {{_ : Model}} {Aâ‚œ W Wâ€²} â†’ Wâ€² â‰¥ W â†’ W âŠ© Aâ‚œ
                                  â†’ Wâ€² âŠ© Aâ‚œ
  rel {BASE true}    Î· ğ’Ÿ = relG Î· ğ’Ÿ
  rel {A âŠƒ B true}   Î· f = \ Î·â€² k â†’ f (Î· âˆ˜â‰¥ Î·â€²) k
  rel {[ Î¨ ] A true} Î· f = \ Î·â€² â†’ crelâ‚ (Î· âˆ˜â‰¥ Î·â€²) (f idâ‰¥)

  crel : âˆ€ {{_ : Model}} {Aâ‚œ W Wâ€²} â†’ Wâ€² â‰¥ W â†’ W âŠª Aâ‚œ
                                   â†’ Wâ€² âŠª Aâ‚œ
  crel Î· k = \ Î·â€² f â†’ k (Î· âˆ˜â‰¥ Î·â€²) f

  crelâ‚ : âˆ€ {{_ : Model}} {Aáµ¥ W Wâ€²} â†’ Wâ€² â‰¥ W â†’ W âŠªâ‚ Aáµ¥
                                    â†’ Wâ€² âŠªâ‚ Aáµ¥
  crelâ‚ {A valid[ Î¨ ]} Î· v = mren âŒŠ Î· âŒ‹â‰¥â‚ (syn v) ,
                             \ Î·â€² Ïˆ â†’ crel {A true} idâ‰¥ (sem v (Î· âˆ˜â‰¥ Î·â€²) Ïˆ)

  crels : âˆ€ {{_ : Model}} {Î“ W Wâ€²} â†’ Wâ€² â‰¥ W â†’ W âŠªâ‹† Î“
                                   â†’ Wâ€² âŠªâ‹† Î“
  crels {âˆ™}          Î· âˆ™       = âˆ™
  crels {Î“ , A true} Î· (Î³ , a) = crels Î· Î³ , crel {A true} Î· a
  -- NOTE: Equivalent to
  -- crels Î· Î³ = maps (crel Î·) Î³


--------------------------------------------------------------------------------


infix 3 _âŠªâ‹†â‚_
_âŠªâ‹†â‚_ : âˆ€ {{_ : Model}} â†’ World â†’ List Validity â†’ Set
W âŠªâ‹†â‚ Î” = All (W âŠªâ‚_) Î”


syns : âˆ€ {{_ : Model}} {Î” W} â†’ W âŠªâ‹†â‚ Î”
                             â†’ âŒŠ W âŒ‹â‚ âŠ¢â‹†â‚ Î”
syns Î´ = maps syn Î´


--------------------------------------------------------------------------------


crelsâ‚ : âˆ€ {{_ : Model}} {Î” W Wâ€²} â†’ Wâ€² â‰¥ W â†’ W âŠªâ‹†â‚ Î”
                                  â†’ Wâ€² âŠªâ‹†â‚ Î”
crelsâ‚ Î· Î´ = maps (crelâ‚ Î·) Î´


--------------------------------------------------------------------------------


return : âˆ€ {{_ : Model}} {A W} â†’ W âŠ© A true
                               â†’ W âŠª A true
return {A} a = \ Î· f â†’ f idâ‰¥ (rel {A true} Î· a)

bind : âˆ€ {{_ : Model}} {A B W} â†’ W âŠª A true â†’ (âˆ€ {Wâ€²} â†’ Wâ€² â‰¥ W â†’ Wâ€² âŠ© A true
                                                         â†’ Wâ€² âŠª B true)
                               â†’ W âŠª B true
bind k f = \ Î· fâ€² â†’
             k Î· (\ Î·â€² a â†’
               f (Î· âˆ˜â‰¥ Î·â€²) a idâ‰¥ (\ Î·â€³ b â†’
                 fâ€² (Î·â€² âˆ˜â‰¥ Î·â€³) b))


--------------------------------------------------------------------------------


infix 3 _âŠ¨_
_âŠ¨_ : ListÂ² Validity Truth â†’ Truth â†’ Setâ‚
Î” â¨¾ Î“ âŠ¨ A true = âˆ€ {{_ : Model}} {W} â†’ W âŠªâ‹†â‚ Î” â†’ W âŠªâ‹† Î“
                                      â†’ W âŠª A true

infix 3 _âŠ¨â‹†_
_âŠ¨â‹†_ : ListÂ² Validity Truth â†’ List Truth â†’ Setâ‚
Î” â¨¾ Î“ âŠ¨â‹† Î = âˆ€ {{_ : Model}} {W} â†’ W âŠªâ‹†â‚ Î” â†’ W âŠªâ‹† Î“
                                  â†’ W âŠªâ‹† Î


mutual
  â†“ : âˆ€ {Î” Î“ A} â†’ Î” â¨¾ Î“ âŠ¢ A true
                â†’ Î” â¨¾ Î“ âŠ¨ A true
  â†“ (var ğ’¾)                  Î´ Î³ = cget Î³ ğ’¾
  â†“ (lam {A} {B} ğ’Ÿ)          Î´ Î³ = return {A âŠƒ B} (\ Î· k â†’
                                     â†“ ğ’Ÿ (crelsâ‚ Î· Î´) (crels Î· Î³ , k))
  â†“ (app {A} {B} ğ’Ÿ â„°)        Î´ Î³ = bind {A âŠƒ B} {B} (â†“ ğ’Ÿ Î´ Î³) (\ Î· f â†’
                                     f idâ‰¥ (â†“ â„° (crelsâ‚ Î· Î´) (crels Î· Î³)))
  â†“ (mvar ğ’¾ Ïˆ)               Î´ Î³ = sem (get Î´ ğ’¾) idâ‰¥ (â†“â‹† Ïˆ Î´ Î³)
  â†“ (box {A} {Î¨} ğ’Ÿ)          Î´ Î³ = return {[ Î¨ ] A} (\ Î· â†’
                                     msub (syns (crelsâ‚ Î· Î´)) ğ’Ÿ ,
                                     \ Î·â€² Ïˆ â†’ â†“ ğ’Ÿ (crelsâ‚ (Î· âˆ˜â‰¥ Î·â€²) Î´) Ïˆ)
  â†“ (letbox {A} {B} {Î¨} ğ’Ÿ â„°) Î´ Î³ = bind {[ Î¨ ] A} {B} (â†“ ğ’Ÿ Î´ Î³) (\ Î· f â†’
                                     â†“ â„° (crelsâ‚ Î· Î´ , f idâ‰¥) (crels Î· Î³))

  â†“â‹† : âˆ€ {Î Î” Î“} â†’ Î” â¨¾ Î“ âŠ¢â‹† Î
                 â†’ Î” â¨¾ Î“ âŠ¨â‹† Î
  â†“â‹† âˆ™       Î´ Î³ = âˆ™
  â†“â‹† (Î¾ , ğ’Ÿ) Î´ Î³ = â†“â‹† Î¾ Î´ Î³ , â†“ ğ’Ÿ Î´ Î³


--------------------------------------------------------------------------------


instance
  canon : Model
  canon = record
            { World  = ListÂ² Validity Truth
            ; Ground = _âŠ¢â‚™â‚œ BASE true
            ; _â‰¥_    = _âŠ‡Â²_
            ; idâ‰¥    = id
            ; _âˆ˜â‰¥_   = _âˆ˜_
            ; relG   = renâ‚™â‚œÂ²
            ; âŒŠ_âŒ‹    = id
            ; âŒŠ_âŒ‹â‰¥   = id
            }


xmvz : âˆ€ {A Î¨ Î” Î”â€² Î“} â†’ Î”â€² âŠ‡ Î” , A valid[ Î¨ ] â†’ Î”â€² â¨¾ Î“ âŠ¢â‹† Î¨
                      â†’ Î”â€² â¨¾ Î“ âŠ¢ A true
xmvz Î· Ïˆ = mvar (renâˆ‹ Î· zero) Ïˆ


xmvzâ‚™â‚œ : âˆ€ {A Î¨ Î” Î”â€² Î“} â†’ Î”â€² âŠ‡ Î” , A valid[ Î¨ ] â†’ Î”â€² â¨¾ Î“ âŠ¢â‹†â‚™â‚˜ Î¨
                        â†’ Î”â€² â¨¾ Î“ âŠ¢â‚™â‚œ A true
xmvzâ‚™â‚œ Î· Ïˆ = mvar (renâˆ‹ Î· zero) Ïˆ


mutual
  â‡“ : âˆ€ {A Î” Î“} â†’ Î” â¨¾ Î“ âŠ¢â‚™â‚œ A true
                â†’ Î” â¨¾ Î“ âŠª A true
  â‡“ {BASE}    ğ’Ÿ = return {BASE} ğ’Ÿ
  â‡“ {A âŠƒ B}   ğ’Ÿ = return {A âŠƒ B} (\ Î· k â†’ â‡“ (app (renâ‚™â‚œÂ² Î· ğ’Ÿ) (â‡‘ k)))
  â‡“ {[ Î¨ ] A} ğ’Ÿ = \ Î· f â†’ letbox (renâ‚™â‚œÂ² Î· ğ’Ÿ) (f (dropâ‚ id) (\ Î·â€² â†’
                    xmvz (projâ‚ Î·â€²) ids ,
                    \ Î·â€³ Ïˆ â†’ â‡“ (xmvzâ‚™â‚œ (projâ‚ (Î·â€² âˆ˜ Î·â€³)) (â‡‘â‹† Ïˆ))))

  â‡‘ : âˆ€ {A Î” Î“} â†’ Î” â¨¾ Î“ âŠª A true
                â†’ Î” â¨¾ Î“ âŠ¢â‚™â‚˜ A true
  â‡‘ {BASE}    k = k id (\ Î· ğ’Ÿ â†’ nt ğ’Ÿ)
  â‡‘ {A âŠƒ B}   k = k id (\ Î· f â†’ lam (â‡‘ (f (dropâ‚‚ id) (â‡“ vzâ‚™â‚œ))))
  â‡‘ {[ Î¨ ] A} k = k id (\ Î· f â†’ box (syn (f id)))

  â‡‘â‹† : âˆ€ {Î Î” Î“} â†’ Î” â¨¾ Î“ âŠªâ‹† Î
                 â†’ Î” â¨¾ Î“ âŠ¢â‹†â‚™â‚˜ Î
  â‡‘â‹† {âˆ™}          âˆ™       = âˆ™
  â‡‘â‹† {Î , A true} (Î¾ , a) = â‡‘â‹† Î¾ , â‡‘ a


--------------------------------------------------------------------------------


swk : âˆ€ {A B Î” Î“} â†’ Î” â¨¾ Î“ âŠª A true
                  â†’ Î” â¨¾ Î“ , B true âŠª A true
swk {A} k = crel {A true} (dropâ‚‚ id) k


svz : âˆ€ {A Î” Î“} â†’ Î” â¨¾ Î“ , A true âŠª A true
svz = â‡“ vzâ‚™â‚œ


--------------------------------------------------------------------------------


smwk : âˆ€ {A B Î¨ Î” Î“} â†’ Î” â¨¾ Î“ âŠª A true
                     â†’ Î” , B valid[ Î¨ ] â¨¾ Î“ âŠª A true
smwk {A} k = crel {A true} (dropâ‚ id) k


smvz : âˆ€ {A Î¨ Î” Î“} â†’ Î” â¨¾ Î“ âŠ¢â‹†â‚™â‚˜ Î¨
                   â†’ Î” , A valid[ Î¨ ] â¨¾ Î“ âŠª A true
smvz Ïˆ = â‡“ (mvzâ‚™â‚œ Ïˆ)


--------------------------------------------------------------------------------


swks : âˆ€ {A Î” Î“ Î} â†’ Î” â¨¾ Î“ âŠªâ‹† Î
                   â†’ Î” â¨¾ Î“ , A true âŠªâ‹† Î
swks Î¾ = crels (dropâ‚‚ id) Î¾


slifts : âˆ€ {A Î” Î“ Î} â†’ Î” â¨¾ Î“ âŠªâ‹† Î
                     â†’ Î” â¨¾ Î“ , A true âŠªâ‹† Î , A true
slifts Î¾ = swks Î¾ , svz


svars : âˆ€ {Î” Î“ Î“â€²} â†’ Î“â€² âŠ‡ Î“
                   â†’ Î” â¨¾ Î“â€² âŠªâ‹† Î“
svars done     = âˆ™
svars (drop Î·) = swks (svars Î·)
svars (keep Î·) = slifts (svars Î·)


sids : âˆ€ {Î” Î“} â†’ Î” â¨¾ Î“ âŠªâ‹† Î“
sids = svars id


--------------------------------------------------------------------------------


smwks : âˆ€ {A Î¨ Î” Î“ Î} â†’ Î” â¨¾ Î“ âŠªâ‹† Î
                      â†’ Î” , A valid[ Î¨ ] â¨¾ Î“ âŠªâ‹† Î
smwks Î¾ = crels (dropâ‚ id) Î¾


--------------------------------------------------------------------------------


smwksâ‚ : âˆ€ {A Î¨ Î” Î“ Î} â†’ Î” â¨¾ Î“ âŠªâ‹†â‚ Î
                       â†’ Î” , A valid[ Î¨ ] â¨¾ Î“ âŠªâ‹†â‚ Î
smwksâ‚ Î¾ = crelsâ‚ (dropâ‚ id) Î¾


smvzâ‚ : âˆ€ {A Î¨ Î” Î“} â†’ Î” , A valid[ Î¨ ] â¨¾ Î“ âŠªâ‚ A valid[ Î¨ ]
smvzâ‚ = mvz ids ,
        \ Î· Ïˆ â†’ â‡“ (xmvzâ‚™â‚œ (projâ‚ Î·) (â‡‘â‹† Ïˆ))


smliftsâ‚ : âˆ€ {A Î¨ Î” Î“ Î} â†’ Î” â¨¾ Î“ âŠªâ‹†â‚ Î
                         â†’ Î” , A valid[ Î¨ ] â¨¾ Î“ âŠªâ‹†â‚ Î , A valid[ Î¨ ]
smliftsâ‚ Î¾ = smwksâ‚ Î¾ , smvzâ‚


smvarsâ‚ : âˆ€ {Î” Î”â€² Î“} â†’ Î”â€² âŠ‡ Î”
                     â†’ Î”â€² â¨¾ Î“ âŠªâ‹†â‚ Î”
smvarsâ‚ done     = âˆ™
smvarsâ‚ (drop Î·) = smwksâ‚ (smvarsâ‚ Î·)
smvarsâ‚ (keep Î·) = smliftsâ‚ (smvarsâ‚ Î·)


smidsâ‚ : âˆ€ {Î” Î“} â†’ Î” â¨¾ Î“ âŠªâ‹†â‚ Î”
smidsâ‚ = smvarsâ‚ id


--------------------------------------------------------------------------------


â†‘ : âˆ€ {Î” Î“ A} â†’ Î” â¨¾ Î“ âŠ¨ A true
              â†’ Î” â¨¾ Î“ âŠ¢â‚™â‚˜ A true
â†‘ f = â‡‘ (f smidsâ‚ sids)


nbe : âˆ€ {Î” Î“ A} â†’ Î” â¨¾ Î“ âŠ¢ A true
                â†’ Î” â¨¾ Î“ âŠ¢â‚™â‚˜ A true
nbe ğ’Ÿ = â†‘ (â†“ ğ’Ÿ)


--------------------------------------------------------------------------------
