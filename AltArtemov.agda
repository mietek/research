{-

An implementation of the Alt-ArtÃ«mov system Î»âˆ
==============================================

MiÃ«tek Bak  <mietek@bak.io>


Work in progress.  Checked with Agda 2.4.2.5.

For easy editing with Emacs agda-mode, add to your .emacs file:

'(agda-input-user-translations
   (quote
    (("imp" "âŠƒ") ("iff" "âŠƒâŠ‚") ("not" "Â¬") ("ent" "âŠ¢") ("thm" "âŠ©")
     ("s" "ğ¬") ("t" "ğ­") ("x" "ğ±") ("y" "ğ²") ("N" "â„•")
     ("v" "ğœˆ") ("v0" "ğœˆâ°") ("v1" "ğœˆ") ("v2" "ğœˆÂ²") ("vn" "ğœˆâ¿")
     ("l" "ğœ†") ("l0" "ğœ†â°") ("l1" "ğœ†") ("l2" "ğœ†Â²") ("ln" "ğœ†â¿") ("." "ï¼")
     ("o" "âˆ˜") ("o0" "âˆ˜â°") ("o1" "âˆ˜") ("o2" "âˆ˜Â²") ("on" "âˆ˜â¿")
     ("p" "ğ‘") ("p0" "ğ‘â°") ("p1" "ğ‘") ("p2" "ğ‘Â²") ("pn" "ğ‘â¿")
     ("1" "ğœ‹â‚€") ("10" "ğœ‹â‚€â°") ("11" "ğœ‹â‚€") ("12" "ğœ‹â‚€Â²") ("1n" "ğœ‹â‚€â¿")
     ("2" "ğœ‹â‚") ("20" "ğœ‹â‚â°") ("21" "ğœ‹â‚") ("12" "ğœ‹â‚Â²") ("2n" "ğœ‹â‚â¿")
     ("u" "â‡‘") ("u0" "â‡‘â°") ("u1" "â‡‘") ("u2" "â‡‘Â²") ("un" "â‡‘â¿")
     ("d" "â‡“") ("d0" "â‡“â°") ("d1" "â‡“") ("d2" "â‡“Â²") ("dn" "â‡“â¿"))))


[1]: Alt, J., ArtÃ«mov, S. (2001) Reflective Î»-calculus,
     Proceedings of the 2001 International Seminar on Proof Theory in
     Computer Science (PTCSâ€™01), Lecture Notes in Computer Science,
     vol. 2183, pp. 22â€“37.
     http://dx.doi.org/10.1007/3-540-45504-3_2

-}


module AltArtemov where

open import Data.Nat
  using (â„• ; zero ; suc)

open import Data.Product
  using (Î£ ; projâ‚‚)
  renaming (_,_ to âŸ¨_,_âŸ©)

open import Data.Vec
  using (Vec ; _âˆ·_ ; _âˆˆ_ ; foldr ; map ; zipWith)
  renaming ([] to âˆ… ; here to Z ; there to S)

infixl 9 !_ ğœˆ_
infixl 8 _âˆ˜_ _âˆ˜Â²_ _âˆ˜^[_]_
infixr 7 â‡‘_ â‡‘Â²_ â‡‘^[_]_ â‡“_ â‡“Â²_ â‡“^[_]_
infixr 6 ğœ†_ï¼_ ğœ†Â²_ï¼_ ğœ†^[_]_ï¼_
infixr 5 _âˆ¶_
infixr 4 Â¬_
infixl 3 _âˆ§_
infixl 2 _,_
infixr 1 _âŠƒ_ _âŠƒâŠ‚_
infixr 0 _âŠ¢_ âŠ©_


mutual

  Var : Set
  Var = â„•


  -- Term constructors

  data Tm : Set where
    ğœˆ_         : Var            â†’ Tm    -- Variable
    ğœ†^[_]_ï¼_   : â„•   â†’ Var â†’ Tm â†’ Tm    -- Abstraction
    _âˆ˜^[_]_    : Tm  â†’ â„•   â†’ Tm â†’ Tm    -- Application
    ğ‘^[_]âŸ¨_,_âŸ© : â„•   â†’ Tm  â†’ Tm â†’ Tm    -- Pairing
    ğœ‹â‚€^[_]_    : â„•   â†’ Tm       â†’ Tm    -- Left projection
    ğœ‹â‚^[_]_    : â„•   â†’ Tm       â†’ Tm    -- Right projection
    !_         : Tm             â†’ Tm    -- Proof checking
    â‡‘^[_]_     : â„•   â†’ Tm       â†’ Tm    -- Reification
    â‡“^[_]_     : â„•   â†’ Tm       â†’ Tm    -- Reflection


  -- Type constructors

  data Ty : Set where
    âŠ¥   :           Ty    -- Falsehood
    _âŠƒ_ : Ty â†’ Ty â†’ Ty    -- Implication
    _âˆ§_ : Ty â†’ Ty â†’ Ty    -- Conjunction
    _âˆ¶_ : Tm â†’ Ty â†’ Ty    -- Provability


-- Example types

âŠ¤      : Ty               -- Truth
âŠ¤      = âŠ¥ âŠƒ âŠ¥

Â¬_     : Ty â†’ Ty          -- Negation
Â¬ A    = A âŠƒ âŠ¥

_âŠƒâŠ‚_   : Ty â†’ Ty â†’ Ty     -- Equivalence
A âŠƒâŠ‚ B = A âŠƒ B âˆ§ B âŠƒ A


-- --------------------------------------------------------------------------

-- Vectors

ixMap : âˆ€{n} {X Y : Set}
      â†’ (â„• â†’ X â†’ Y) â†’ Vec X n â†’ Vec Y n
ixMap {zero}  f âˆ…       = âˆ…
ixMap {suc n} f (x âˆ· ğ±) = f (suc n) x âˆ· ixMap f ğ±

ixZipWith : âˆ€{n} {X Xâ€² Y : Set}
          â†’ (â„• â†’ X â†’ Xâ€² â†’ Y) â†’ Vec X n â†’ Vec Xâ€² n â†’ Vec Y n
ixZipWith {zero}  f âˆ…       âˆ…       = âˆ…
ixZipWith {suc n} f (x âˆ· ğ±) (y âˆ· ğ²) = f (suc n) x y âˆ· ixZipWith f ğ± ğ²


VVar : â„• â†’ Set
VVar = Vec Var

VTm  : â„• â†’ Set
VTm  = Vec Tm

VTy  : â„• â†’ Set
VTy  = Vec Ty


-- Vector notation for type constructors

*â¿_âˆ¶_          : âˆ€{n} â†’ VTm n â†’ Ty â†’ Ty
*â¿ ğ­ âˆ¶ A       = foldr (Î» _ â†’ Ty) _âˆ¶_ A ğ­

ğœˆâ¿_âˆ¶_          : âˆ€{n} â†’ VVar n â†’ Ty â†’ Ty
ğœˆâ¿ ğ± âˆ¶ A       = *â¿ (map ğœˆ_ ğ±) âˆ¶ A

ğœ†â¿_ï¼_âˆ¶_        : âˆ€{n} â†’ VVar n â†’ VTm n â†’ Ty â†’ Ty
ğœ†â¿ ğ± ï¼ ğ­ âˆ¶ A   = *â¿ (ixZipWith ğœ†^[_]_ï¼_ ğ± ğ­) âˆ¶ A

_âˆ˜â¿_âˆ¶_         : âˆ€{n} â†’ VTm n â†’ VTm n â†’ Ty â†’ Ty
ğ­ âˆ˜â¿ ğ¬ âˆ¶ A     = *â¿ (ixZipWith (Î» n t s â†’ t âˆ˜^[ n ] s) ğ­ ğ¬) âˆ¶ A

ğ‘â¿âŸ¨_,_âŸ©âˆ¶_      : âˆ€{n} â†’ VTm n â†’ VTm n â†’ Ty â†’ Ty
ğ‘â¿âŸ¨ ğ­ , ğ¬ âŸ©âˆ¶ A = *â¿ (ixZipWith ğ‘^[_]âŸ¨_,_âŸ© ğ­ ğ¬) âˆ¶ A

ğœ‹â‚€â¿_âˆ¶_         : âˆ€{n} â†’ VTm n â†’ Ty â†’ Ty
ğœ‹â‚€â¿ ğ­ âˆ¶ A      = *â¿ (ixMap ğœ‹â‚€^[_]_ ğ­) âˆ¶ A

ğœ‹â‚â¿_âˆ¶_         : âˆ€{n} â†’ VTm n â†’ Ty â†’ Ty
ğœ‹â‚â¿ ğ­ âˆ¶ A      = *â¿ (ixMap ğœ‹â‚^[_]_ ğ­) âˆ¶ A

â‡‘â¿_âˆ¶_          : âˆ€{n} â†’ VTm n â†’ Ty â†’ Ty
â‡‘â¿ ğ­ âˆ¶ A       = *â¿ (ixMap â‡‘^[_]_ ğ­) âˆ¶ A

â‡“â¿_âˆ¶_          : âˆ€{n} â†’ VTm n â†’ Ty â†’ Ty
â‡“â¿ ğ­ âˆ¶ A       = *â¿ (ixMap â‡“^[_]_ ğ­) âˆ¶ A


-- --------------------------------------------------------------------------

-- Typing contexts

Cx : â„• â†’ Set
Cx = Vec Ty

_,_ : {m : â„•} â†’ Cx m â†’ Ty â†’ Cx (suc m)
Î“ , A = A âˆ· Î“


-- Typing rules

data _âŠ¢_ {m : â„•} (Î“ : Cx m) : Ty â†’ Set where
  Rğœˆâ¿  : âˆ€{n} {ğ± : VVar n} {A : Ty}
       â†’ ğœˆâ¿ ğ± âˆ¶ A âˆˆ Î“
       â†’ Î“ âŠ¢ ğœˆâ¿ ğ± âˆ¶ A

  Rğœ†â¿  : âˆ€{n} {ğ± : VVar n} {ğ­ : VTm n} {A B : Ty}
       â†’ Î“ , ğœˆâ¿ ğ± âˆ¶ A âŠ¢ *â¿ ğ­ âˆ¶ B
       â†’ Î“ âŠ¢ ğœ†â¿ ğ± ï¼ ğ­ âˆ¶ (A âŠƒ B)

  Râˆ˜â¿  : âˆ€{n} {ğ­ ğ¬ : VTm n} {A B : Ty}
       â†’ Î“ âŠ¢ *â¿ ğ­ âˆ¶ (A âŠƒ B)    â†’ Î“ âŠ¢ *â¿ ğ¬ âˆ¶ A
       â†’ Î“ âŠ¢ ğ­ âˆ˜â¿ ğ¬ âˆ¶ B

  Rğ‘â¿  : âˆ€{n} {ğ­ ğ¬ : VTm n} {A B : Ty}
       â†’ Î“ âŠ¢ *â¿ ğ­ âˆ¶ A          â†’ Î“ âŠ¢ *â¿ ğ¬ âˆ¶ B
       â†’ Î“ âŠ¢ ğ‘â¿âŸ¨ ğ­ , ğ¬ âŸ©âˆ¶ (A âˆ§ B)

  Rğœ‹â‚€â¿ : âˆ€{n} {ğ­ : VTm n} {A B : Ty}
       â†’ Î“ âŠ¢ *â¿ ğ­ âˆ¶ (A âˆ§ B)
       â†’ Î“ âŠ¢ ğœ‹â‚€â¿ ğ­ âˆ¶ A

  Rğœ‹â‚â¿ : âˆ€{n} {ğ­ : VTm n} {A B : Ty}
       â†’ Î“ âŠ¢ *â¿ ğ­ âˆ¶ (A âˆ§ B)
       â†’ Î“ âŠ¢ ğœ‹â‚â¿ ğ­ âˆ¶ B

  Râ‡‘â¿  : âˆ€{n} {ğ­ : VTm n} {u : Tm} {A : Ty}
       â†’ Î“ âŠ¢ *â¿ ğ­ âˆ¶ (u âˆ¶ A)
       â†’ Î“ âŠ¢ â‡‘â¿ ğ­ âˆ¶ (! u âˆ¶ u âˆ¶ A)

  Râ‡“â¿  : âˆ€{n} {ğ­ : VTm n} {u : Tm} {A : Ty}
       â†’ Î“ âŠ¢ *â¿ ğ­ âˆ¶ (u âˆ¶ A)
       â†’ Î“ âŠ¢ â‡“â¿ ğ­ âˆ¶ A


âŠ©_  : Ty â†’ Set
âŠ© A = âˆ€{m} {Î“ : Cx m} â†’ Î“ âŠ¢ A


-- --------------------------------------------------------------------------

-- Simplified notation for level 0 typing rules

Rğœˆâ°  : âˆ€{A m} {Î“ : Cx m}
     â†’ A âˆˆ Î“
     â†’ Î“ âŠ¢ A
Rğœˆâ° = Rğœˆâ¿ {ğ± = âˆ…}

Rğœ†â°  : âˆ€{A B m} {Î“ : Cx m}
     â†’ Î“ , A âŠ¢ B
     â†’ Î“ âŠ¢ A âŠƒ B
Rğœ†â° = Rğœ†â¿ {ğ± = âˆ…} {ğ­ = âˆ…}

Râˆ˜â°  : âˆ€{A B m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ A âŠƒ B    â†’ Î“ âŠ¢ A
     â†’ Î“ âŠ¢ B
Râˆ˜â° = Râˆ˜â¿ {ğ­ = âˆ…} {ğ¬ = âˆ…}

Rğ‘â°  : âˆ€{A B m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ A        â†’ Î“ âŠ¢ B
     â†’ Î“ âŠ¢ A âˆ§ B
Rğ‘â° = Rğ‘â¿ {ğ­ = âˆ…} {ğ¬ = âˆ…}

Rğœ‹â‚€â° : âˆ€{A B m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ A âˆ§ B
     â†’ Î“ âŠ¢ A
Rğœ‹â‚€â° = Rğœ‹â‚€â¿ {ğ­ = âˆ…}

Rğœ‹â‚â° : âˆ€{A B m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ A âˆ§ B
     â†’ Î“ âŠ¢ B
Rğœ‹â‚â° = Rğœ‹â‚â¿ {ğ­ = âˆ…}

Râ‡‘â°  : âˆ€{u A m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ u âˆ¶ A
     â†’ Î“ âŠ¢ ! u âˆ¶ u âˆ¶ A
Râ‡‘â° = Râ‡‘â¿ {ğ­ = âˆ…}

Râ‡“â°  : âˆ€{u A m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ u âˆ¶ A
     â†’ Î“ âŠ¢ A
Râ‡“â° = Râ‡“â¿ {ğ­ = âˆ…}


-- Level 0 examples

eIâ° : âˆ€{A}
    â†’ âŠ© A âŠƒ A
eIâ° = Rğœ†â° (Rğœˆâ° Z)


eKâ° : âˆ€{A B}
    â†’ âŠ© A âŠƒ B âŠƒ A
eKâ° = Rğœ†â° (Rğœ†â° (Rğœˆâ° (S Z)))


eSâ° : âˆ€{A B C}
    â†’ âŠ© (A âŠƒ B âŠƒ C) âŠƒ (A âŠƒ B) âŠƒ A âŠƒ C
eSâ° = Rğœ†â° (Rğœ†â° (Rğœ†â° (Râˆ˜â° (Râˆ˜â° (Rğœˆâ° (S (S Z)))
                              (Rğœˆâ° Z))
                         (Râˆ˜â° (Rğœˆâ° (S Z))
                              (Rğœˆâ° Z)))))


-- --------------------------------------------------------------------------

-- Simplified notation for level 1 term constructors

ğœ†_ï¼_       : Var â†’ Tm â†’ Tm
ğœ† x ï¼ t    = ğœ†^[ 1 ] x ï¼ t

_âˆ˜_        : Tm â†’ Tm â†’ Tm
t âˆ˜ s      = t âˆ˜^[ 1 ] s

ğ‘âŸ¨_,_âŸ©     : Tm â†’ Tm â†’ Tm
ğ‘âŸ¨ t , s âŸ© = ğ‘^[ 1 ]âŸ¨ t , s âŸ©

ğœ‹â‚€_        : Tm â†’ Tm
ğœ‹â‚€ t       = ğœ‹â‚€^[ 1 ] t

ğœ‹â‚_        : Tm â†’ Tm
ğœ‹â‚ t       = ğœ‹â‚^[ 1 ] t

â‡‘_         : Tm â†’ Tm
â‡‘ t        = â‡‘^[ 1 ] t

â‡“_         : Tm â†’ Tm
â‡“ t        = â‡“^[ 1 ] t


-- Simplified notation for level 1 typing rules

Rğœˆ  : âˆ€{x A m} {Î“ : Cx m}
    â†’ ğœˆ x âˆ¶ A âˆˆ Î“
    â†’ Î“ âŠ¢ ğœˆ x âˆ¶ A
Rğœˆ {x} = Rğœˆâ¿ {ğ± = x âˆ· âˆ…}

Rğœ†  : âˆ€{x t A B m} {Î“ : Cx m}
    â†’ Î“ , ğœˆ x âˆ¶ A âŠ¢ t âˆ¶ B
    â†’ Î“ âŠ¢ ğœ† x ï¼ t âˆ¶ (A âŠƒ B)
Rğœ† {x} {t} = Rğœ†â¿ {ğ± = x âˆ· âˆ…} {ğ­ = t âˆ· âˆ…}

Râˆ˜  : âˆ€{t s A B m} {Î“ : Cx m}
    â†’ Î“ âŠ¢ t âˆ¶ (A âŠƒ B)    â†’ Î“ âŠ¢ s âˆ¶ A
    â†’ Î“ âŠ¢ t âˆ˜ s âˆ¶ B
Râˆ˜ {t} {s} = Râˆ˜â¿ {ğ­ = t âˆ· âˆ…} {ğ¬ = s âˆ· âˆ…}

Rğ‘  : âˆ€{t s A B m} {Î“ : Cx m}
    â†’ Î“ âŠ¢ t âˆ¶ A          â†’ Î“ âŠ¢ s âˆ¶ B
    â†’ Î“ âŠ¢ ğ‘âŸ¨ t , s âŸ© âˆ¶ (A âˆ§ B)
Rğ‘ {t} {s} = Rğ‘â¿ {ğ­ = t âˆ· âˆ…} {ğ¬ = s âˆ· âˆ…}

Rğœ‹â‚€ : âˆ€{t A B m} {Î“ : Cx m}
    â†’ Î“ âŠ¢ t âˆ¶ (A âˆ§ B)
    â†’ Î“ âŠ¢ ğœ‹â‚€ t âˆ¶ A
Rğœ‹â‚€ {t} = Rğœ‹â‚€â¿ {ğ­ = t âˆ· âˆ…}

Rğœ‹â‚ : âˆ€{t A B m} {Î“ : Cx m}
    â†’ Î“ âŠ¢ t âˆ¶ (A âˆ§ B)
    â†’ Î“ âŠ¢ ğœ‹â‚ t âˆ¶ B
Rğœ‹â‚ {t} = Rğœ‹â‚â¿ {ğ­ = t âˆ· âˆ…}

Râ‡‘  : âˆ€{t u A m} {Î“ : Cx m}
    â†’ Î“ âŠ¢ t âˆ¶ u âˆ¶ A
    â†’ Î“ âŠ¢ â‡‘ t âˆ¶ ! u âˆ¶ u âˆ¶ A
Râ‡‘ {t} = Râ‡‘â¿ {ğ­ = t âˆ· âˆ…}

Râ‡“  : âˆ€{t u A m} {Î“ : Cx m}
    â†’ Î“ âŠ¢ t âˆ¶ u âˆ¶ A
    â†’ Î“ âŠ¢ â‡“ t âˆ¶ A
Râ‡“ {t} = Râ‡“â¿ {ğ­ = t âˆ· âˆ…}


-- Level 1 examples

eI : âˆ€{x A}
   â†’ âŠ© ğœ† x ï¼ ğœˆ x
       âˆ¶ (A âŠƒ A)
eI = Rğœ† (Rğœˆ Z)


eK : âˆ€{x y A B}
   â†’ âŠ© ğœ† x ï¼ ğœ† y ï¼ ğœˆ x
       âˆ¶ (A âŠƒ B âŠƒ A)
eK = Rğœ† (Rğœ† (Rğœˆ (S Z)))


eS : âˆ€{f g x A B C}
   â†’ âŠ© ğœ† f ï¼ ğœ† g ï¼ ğœ† x ï¼ (ğœˆ f âˆ˜ ğœˆ x) âˆ˜ (ğœˆ g âˆ˜ ğœˆ x)
       âˆ¶ ((A âŠƒ B âŠƒ C) âŠƒ (A âŠƒ B) âŠƒ A âŠƒ C)
eS = Rğœ† (Rğœ† (Rğœ† (Râˆ˜ (Râˆ˜ (Rğœˆ (S (S Z)))
                        (Rğœˆ Z))
                    (Râˆ˜ (Rğœˆ (S Z))
                        (Rğœˆ Z)))))


-- --------------------------------------------------------------------------

-- Simplified notation for level 2 term constructors

ğœ†Â²_ï¼_       : Var â†’ Tm â†’ Tm
ğœ†Â² x ï¼ t    = ğœ†^[ 2 ] x ï¼ t

_âˆ˜Â²_        : Tm â†’ Tm â†’ Tm
t âˆ˜Â² s      = t âˆ˜^[ 2 ] s

ğ‘Â²âŸ¨_,_âŸ©     : Tm â†’ Tm â†’ Tm
ğ‘Â²âŸ¨ t , s âŸ© = ğ‘^[ 2 ]âŸ¨ t , s âŸ©

ğœ‹â‚€Â²_        : Tm â†’ Tm
ğœ‹â‚€Â² t       = ğœ‹â‚€^[ 2 ] t

ğœ‹â‚Â²_        : Tm â†’ Tm
ğœ‹â‚Â² t       = ğœ‹â‚^[ 2 ] t

â‡‘Â²_         : Tm â†’ Tm
â‡‘Â² t        = â‡‘^[ 2 ] t

â‡“Â²_         : Tm â†’ Tm
â‡“Â² t        = â‡“^[ 2 ] t


-- Simplified notation for level 2 typing rules

RğœˆÂ²  : âˆ€{xâ‚‚ xâ‚ A m} {Î“ : Cx m}
     â†’ ğœˆ xâ‚‚ âˆ¶ ğœˆ xâ‚ âˆ¶ A âˆˆ Î“
     â†’ Î“ âŠ¢ ğœˆ xâ‚‚ âˆ¶ ğœˆ xâ‚ âˆ¶ A
RğœˆÂ² {xâ‚‚} {xâ‚} = Rğœˆâ¿ {ğ± = xâ‚‚ âˆ· xâ‚ âˆ· âˆ…}

Rğœ†Â²  : âˆ€{xâ‚‚ xâ‚ tâ‚‚ tâ‚ A B m} {Î“ : Cx m}
     â†’ Î“ , ğœˆ xâ‚‚ âˆ¶ ğœˆ xâ‚ âˆ¶ A âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ B
     â†’ Î“ âŠ¢ ğœ†Â² xâ‚‚ ï¼ tâ‚‚ âˆ¶ ğœ† xâ‚ ï¼ tâ‚ âˆ¶ (A âŠƒ B)
Rğœ†Â² {xâ‚‚} {xâ‚} {tâ‚‚} {tâ‚} = Rğœ†â¿ {ğ± = xâ‚‚ âˆ· xâ‚ âˆ· âˆ…} {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…}

Râˆ˜Â²  : âˆ€{tâ‚‚ tâ‚ sâ‚‚ sâ‚ A B m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ (A âŠƒ B)    â†’ Î“ âŠ¢ sâ‚‚ âˆ¶ sâ‚ âˆ¶ A
     â†’ Î“ âŠ¢ tâ‚‚ âˆ˜Â² sâ‚‚ âˆ¶ tâ‚ âˆ˜ sâ‚ âˆ¶ B
Râˆ˜Â² {tâ‚‚} {tâ‚} {sâ‚‚} {sâ‚} = Râˆ˜â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…} {ğ¬ = sâ‚‚ âˆ· sâ‚ âˆ· âˆ…}

Rğ‘Â²  : âˆ€{tâ‚‚ tâ‚ sâ‚‚ sâ‚ A B m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ A          â†’ Î“ âŠ¢ sâ‚‚ âˆ¶ sâ‚ âˆ¶ B
     â†’ Î“ âŠ¢ ğ‘Â²âŸ¨ tâ‚‚ , sâ‚‚ âŸ© âˆ¶ ğ‘âŸ¨ tâ‚ , sâ‚ âŸ© âˆ¶ (A âˆ§ B)
Rğ‘Â² {tâ‚‚} {tâ‚} {sâ‚‚} {sâ‚} = Rğ‘â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…} {ğ¬ = sâ‚‚ âˆ· sâ‚ âˆ· âˆ…}

Rğœ‹â‚€Â² : âˆ€{tâ‚‚ tâ‚ A B m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ (A âˆ§ B)
     â†’ Î“ âŠ¢ ğœ‹â‚€Â² tâ‚‚ âˆ¶ ğœ‹â‚€ tâ‚ âˆ¶ A
Rğœ‹â‚€Â² {tâ‚‚} {tâ‚} = Rğœ‹â‚€â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…}

Rğœ‹â‚Â² : âˆ€{tâ‚‚ tâ‚ A B m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ (A âˆ§ B)
     â†’ Î“ âŠ¢ ğœ‹â‚Â² tâ‚‚ âˆ¶ ğœ‹â‚ tâ‚ âˆ¶ B
Rğœ‹â‚Â² {tâ‚‚} {tâ‚} = Rğœ‹â‚â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…}

Râ‡‘Â²  : âˆ€{tâ‚‚ tâ‚ u A m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ u âˆ¶ A
     â†’ Î“ âŠ¢ â‡‘Â² tâ‚‚ âˆ¶ â‡‘ tâ‚ âˆ¶ ! u âˆ¶ u âˆ¶ A
Râ‡‘Â² {tâ‚‚} {tâ‚} = Râ‡‘â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…}

Râ‡“Â²  : âˆ€{tâ‚‚ tâ‚ u A m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ u âˆ¶ A
     â†’ Î“ âŠ¢ â‡“Â² tâ‚‚ âˆ¶ â‡“ tâ‚ âˆ¶ A
Râ‡“Â² {tâ‚‚} {tâ‚} = Râ‡“â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…}


-- Level 2 examples

eIÂ² : âˆ€{u x A}
    â†’ âŠ© ğœ†Â² u ï¼ ğœˆ u
        âˆ¶ ğœ† x ï¼ ğœˆ x
          âˆ¶ (A âŠƒ A)
eIÂ² = Rğœ†Â² (RğœˆÂ² Z)


eKÂ² : âˆ€{u x v y A B}
    â†’ âŠ© ğœ†Â² u ï¼ ğœ†Â² v ï¼ ğœˆ u
        âˆ¶ ğœ† x ï¼ ğœ† y ï¼ ğœˆ x
          âˆ¶ (A âŠƒ B âŠƒ A)
eKÂ² = Rğœ†Â² (Rğœ†Â² (RğœˆÂ² (S Z)))


eSÂ² : âˆ€{f g x A B C}
    â†’ âŠ© ğœ†Â² f ï¼ ğœ†Â² g ï¼ ğœ†Â² x ï¼ (ğœˆ f âˆ˜Â² ğœˆ x) âˆ˜Â² (ğœˆ g âˆ˜Â² ğœˆ x)
        âˆ¶ ğœ† f ï¼ ğœ† g ï¼ ğœ† x ï¼ (ğœˆ f âˆ˜ ğœˆ x) âˆ˜ (ğœˆ g âˆ˜ ğœˆ x)
          âˆ¶ ((A âŠƒ B âŠƒ C) âŠƒ (A âŠƒ B) âŠƒ A âŠƒ C)
eSÂ² = Rğœ†Â² (Rğœ†Â² (Rğœ†Â² (Râˆ˜Â² (Râˆ˜Â² (RğœˆÂ² (S (S Z)))
                              (RğœˆÂ² Z))
                         (Râˆ˜Â² (RğœˆÂ² (S Z))
                              (RğœˆÂ² Z)))))


-- --------------------------------------------------------------------------

-- Example 1, p. 28 [1]

e11 : âˆ€{x y A}
    â†’ âŠ© ğœ† y ï¼ â‡“ ğœˆ y
        âˆ¶ (ğœˆ x âˆ¶ A âŠƒ A)
e11 = Rğœ† (Râ‡“ (Rğœˆ Z))

e12 : âˆ€{x y A}
    â†’ âŠ© ğœ† y ï¼ â‡‘ ğœˆ y
        âˆ¶ (ğœˆ x âˆ¶ A âŠƒ ! ğœˆ x âˆ¶ ğœˆ x âˆ¶ A)
e12 = Rğœ† (Râ‡‘ (Rğœˆ Z))

e13 : âˆ€{u x v y A B}
    â†’ âŠ© ğœ†Â² u ï¼ ğœ†Â² v ï¼ ğ‘Â²âŸ¨ ğœˆ u , ğœˆ v âŸ©
        âˆ¶ ğœ† x ï¼ ğœ† y ï¼ ğ‘âŸ¨ ğœˆ x , ğœˆ y âŸ©
          âˆ¶ (A âŠƒ B âŠƒ A âˆ§ B)
e13 = Rğœ†Â² (Rğœ†Â² (Rğ‘Â² (RğœˆÂ² (S Z))
                    (RğœˆÂ² Z)))

e14 : âˆ€{u x v y A B}
    â†’ âŠ© ğœ† u ï¼ ğœ† v ï¼ â‡‘ ğ‘Â²âŸ¨ ğœˆ u , ğœˆ v âŸ©
        âˆ¶ (ğœˆ x âˆ¶ A âŠƒ ğœˆ y âˆ¶ B âŠƒ ! ğ‘âŸ¨ ğœˆ x , ğœˆ y âŸ© âˆ¶ ğ‘âŸ¨ ğœˆ x , ğœˆ y âŸ© âˆ¶ (A âˆ§ B))
e14 = Rğœ† (Rğœ† (Râ‡‘ (Rğ‘Â² (Rğœˆ (S Z))
                      (Rğœˆ Z))))


-- Example 2, pp. 31â€“32 [1]

e2 : âˆ€{xâ‚ƒ xâ‚‚ xâ‚ A}
   â†’ âŠ© ğœ†Â² xâ‚ƒ ï¼ â‡“Â² â‡‘Â² ğœˆ xâ‚ƒ
       âˆ¶ ğœ† xâ‚‚ ï¼ â‡“ â‡‘ ğœˆ xâ‚‚
         âˆ¶ (ğœˆ xâ‚ âˆ¶ A âŠƒ ğœˆ xâ‚ âˆ¶ A)
e2 = Rğœ†Â² (Râ‡“Â² (Râ‡‘Â² (RğœˆÂ² Z)))

e2â€² : âˆ€{xâ‚ƒ xâ‚‚ xâ‚ A}
    â†’ âŠ© ğœ†Â² xâ‚ƒ ï¼ ğœˆ xâ‚ƒ
        âˆ¶ ğœ† xâ‚‚ ï¼ ğœˆ xâ‚‚
          âˆ¶ (ğœˆ xâ‚ âˆ¶ A âŠƒ ğœˆ xâ‚ âˆ¶ A)
e2â€² = Rğœ†Â² (RğœˆÂ² Z)


-- --------------------------------------------------------------------------

-- Weakening

data _â‰²_ : âˆ€{m mâ€²} â†’ Cx m â†’ Cx mâ€² â†’ Set where
  base : âˆ… â‰² âˆ…

  keep : âˆ€{A m mâ€²} {Î“ : Cx m} {Î“â€² : Cx mâ€²}
       â†’ Î“ â‰² Î“â€²
       â†’ (Î“ , A) â‰² (Î“â€² , A)

  drop : âˆ€{A m mâ€²} {Î“ : Cx m} {Î“â€² : Cx mâ€²}
       â†’ Î“ â‰² Î“â€²
       â†’ Î“ â‰² (Î“â€² , A)


wkâˆˆ : âˆ€{A m mâ€²} {Î“ : Cx m} {Î“â€² : Cx mâ€²}
    â†’ Î“ â‰² Î“â€²    â†’ A âˆˆ Î“
    â†’ A âˆˆ Î“â€²
wkâˆˆ base     ()
wkâˆˆ (keep P) Z     = Z
wkâˆˆ (keep P) (S i) = S (wkâˆˆ P i)
wkâˆˆ (drop P) i     = S (wkâˆˆ P i)


wkâŠ¢ : âˆ€{A m mâ€²} {Î“ : Cx m} {Î“â€² : Cx mâ€²}
    â†’ Î“ â‰² Î“â€²    â†’ Î“ âŠ¢ A
    â†’ Î“â€² âŠ¢ A
wkâŠ¢ P (Rğœˆâ¿  {ğ± = ğ±} i)         = Rğœˆâ¿  {ğ± = ğ±} (wkâˆˆ P i)
wkâŠ¢ P (Rğœ†â¿  {ğ± = ğ±} {ğ­} D)     = Rğœ†â¿  {ğ± = ğ±} {ğ­} (wkâŠ¢ (keep P) D)
wkâŠ¢ P (Râˆ˜â¿  {ğ­ = ğ­} {ğ¬} Dâ‚œ Dâ‚›) = Râˆ˜â¿  {ğ­ = ğ­} {ğ¬} (wkâŠ¢ P Dâ‚œ) (wkâŠ¢ P Dâ‚›)
wkâŠ¢ P (Rğ‘â¿  {ğ­ = ğ­} {ğ¬} Dâ‚œ Dâ‚›) = Rğ‘â¿  {ğ­ = ğ­} {ğ¬} (wkâŠ¢ P Dâ‚œ) (wkâŠ¢ P Dâ‚›)
wkâŠ¢ P (Rğœ‹â‚€â¿ {ğ­ = ğ­} D)         = Rğœ‹â‚€â¿ {ğ­ = ğ­} (wkâŠ¢ P D)
wkâŠ¢ P (Rğœ‹â‚â¿ {ğ­ = ğ­} D)         = Rğœ‹â‚â¿ {ğ­ = ğ­} (wkâŠ¢ P D)
wkâŠ¢ P (Râ‡‘â¿  {ğ­ = ğ­} D)         = Râ‡‘â¿  {ğ­ = ğ­} (wkâŠ¢ P D)
wkâŠ¢ P (Râ‡“â¿  {ğ­ = ğ­} D)         = Râ‡“â¿  {ğ­ = ğ­} (wkâŠ¢ P D)


-- --------------------------------------------------------------------------

-- Contraction

data _â‰³_ : âˆ€{m mâ€²} â†’ Cx m â†’ Cx mâ€² â†’ Set where
  base : âˆ… â‰³ âˆ…

  once : âˆ€{A m mâ€²} {Î“ : Cx m} {Î“â€² : Cx mâ€²}
       â†’ Î“ â‰³ Î“â€²
       â†’ (Î“ , A) â‰³ (Î“â€² , A)

  more : âˆ€{A m mâ€²} {Î“ : Cx m} {Î“â€² : Cx mâ€²}
       â†’ Î“ â‰³ Î“â€²
       â†’ (Î“ , A , A) â‰³ (Î“â€² , A)


cnâˆˆ : âˆ€{A m mâ€²} {Î“ : Cx m} {Î“â€² : Cx mâ€²}
    â†’ Î“ â‰³ Î“â€²    â†’ A âˆˆ Î“
    â†’ A âˆˆ Î“â€²
cnâˆˆ base     ()
cnâˆˆ (once P) Z     = Z
cnâˆˆ (once P) (S i) = S (cnâˆˆ P i)
cnâˆˆ (more P) Z     = Z
cnâˆˆ (more P) (S i) = cnâˆˆ (once P) i


cnâŠ¢ : âˆ€{A m mâ€²} {Î“ : Cx m} {Î“â€² : Cx mâ€²}
    â†’ Î“ â‰³ Î“â€²    â†’ Î“ âŠ¢ A
    â†’ Î“â€² âŠ¢ A
cnâŠ¢ P (Rğœˆâ¿  {ğ± = ğ±} i)         = Rğœˆâ¿  {ğ± = ğ±} (cnâˆˆ P i)
cnâŠ¢ P (Rğœ†â¿  {ğ± = ğ±} {ğ­} D)     = Rğœ†â¿  {ğ± = ğ±} {ğ­} (cnâŠ¢ (once P) D)
cnâŠ¢ P (Râˆ˜â¿  {ğ­ = ğ­} {ğ¬} Dâ‚œ Dâ‚›) = Râˆ˜â¿  {ğ­ = ğ­} {ğ¬} (cnâŠ¢ P Dâ‚œ) (cnâŠ¢ P Dâ‚›)
cnâŠ¢ P (Rğ‘â¿  {ğ­ = ğ­} {ğ¬} Dâ‚œ Dâ‚›) = Rğ‘â¿  {ğ­ = ğ­} {ğ¬} (cnâŠ¢ P Dâ‚œ) (cnâŠ¢ P Dâ‚›)
cnâŠ¢ P (Rğœ‹â‚€â¿ {ğ­ = ğ­} D)         = Rğœ‹â‚€â¿ {ğ­ = ğ­} (cnâŠ¢ P D)
cnâŠ¢ P (Rğœ‹â‚â¿ {ğ­ = ğ­} D)         = Rğœ‹â‚â¿ {ğ­ = ğ­} (cnâŠ¢ P D)
cnâŠ¢ P (Râ‡‘â¿  {ğ­ = ğ­} D)         = Râ‡‘â¿  {ğ­ = ğ­} (cnâŠ¢ P D)
cnâŠ¢ P (Râ‡“â¿  {ğ­ = ğ­} D)         = Râ‡“â¿  {ğ­ = ğ­} (cnâŠ¢ P D)


-- --------------------------------------------------------------------------

-- Exchange

data _â‰ˆ_ : âˆ€{m} â†’ Cx m â†’ Cx m â†’ Set where
  base : âˆ… â‰ˆ âˆ…

  just : âˆ€{A m} {Î“ Î“â€² : Cx m}
       â†’ Î“ â‰ˆ Î“â€²
       â†’ (Î“ , A) â‰ˆ (Î“â€² , A)

  same : âˆ€{A B m} {Î“ Î“â€² : Cx m}
       â†’ Î“ â‰ˆ Î“â€²
       â†’ (Î“ , A , B) â‰ˆ (Î“â€² , A , B)

  diff : âˆ€{A B m} {Î“ Î“â€² : Cx m}
       â†’ Î“ â‰ˆ Î“â€²
       â†’ (Î“ , B , A) â‰ˆ (Î“â€² , A , B)


exâˆˆ : âˆ€{A m} {Î“ Î“â€² : Cx m}
    â†’ Î“ â‰ˆ Î“â€²    â†’ A âˆˆ Î“
    â†’ A âˆˆ Î“â€²
exâˆˆ base     ()
exâˆˆ (just P) Z         = Z
exâˆˆ (just P) (S i)     = S (exâˆˆ P i)
exâˆˆ (same P) Z         = Z
exâˆˆ (same P) (S Z)     = S Z
exâˆˆ (same P) (S (S i)) = S (S (exâˆˆ P i))
exâˆˆ (diff P) Z         = S Z
exâˆˆ (diff P) (S Z)     = Z
exâˆˆ (diff P) (S (S i)) = S (S (exâˆˆ P i))


exâŠ¢ : âˆ€{A m} {Î“ Î“â€² : Cx m}
    â†’ Î“ â‰ˆ Î“â€²    â†’ Î“ âŠ¢ A
    â†’ Î“â€² âŠ¢ A
exâŠ¢ P (Rğœˆâ¿  {ğ± = ğ±} i)         = Rğœˆâ¿  {ğ± = ğ±} (exâˆˆ P i)
exâŠ¢ P (Rğœ†â¿  {ğ± = ğ±} {ğ­} D)     = Rğœ†â¿  {ğ± = ğ±} {ğ­} (exâŠ¢ (just P) D)
exâŠ¢ P (Râˆ˜â¿  {ğ­ = ğ­} {ğ¬} Dâ‚œ Dâ‚›) = Râˆ˜â¿  {ğ­ = ğ­} {ğ¬} (exâŠ¢ P Dâ‚œ) (exâŠ¢ P Dâ‚›)
exâŠ¢ P (Rğ‘â¿  {ğ­ = ğ­} {ğ¬} Dâ‚œ Dâ‚›) = Rğ‘â¿  {ğ­ = ğ­} {ğ¬} (exâŠ¢ P Dâ‚œ) (exâŠ¢ P Dâ‚›)
exâŠ¢ P (Rğœ‹â‚€â¿ {ğ­ = ğ­} D)         = Rğœ‹â‚€â¿ {ğ­ = ğ­} (exâŠ¢ P D)
exâŠ¢ P (Rğœ‹â‚â¿ {ğ­ = ğ­} D)         = Rğœ‹â‚â¿ {ğ­ = ğ­} (exâŠ¢ P D)
exâŠ¢ P (Râ‡‘â¿  {ğ­ = ğ­} D)         = Râ‡‘â¿  {ğ­ = ğ­} (exâŠ¢ P D)
exâŠ¢ P (Râ‡“â¿  {ğ­ = ğ­} D)         = Râ‡“â¿  {ğ­ = ğ­} (exâŠ¢ P D)


-- --------------------------------------------------------------------------

-- Theorem 1 (Internalisation principle), p. 29 [1]

{- â€œLet Î»âˆ derive
        Aâ‚, Aâ‚‚, â€¦, Aâ‚˜ âŠ¢ B.
    Then one can build a well-defined term t(xâ‚, xâ‚‚, â€¦, xâ‚˜) with fresh
    variables ğ± such that Î»âˆ also derives
        xâ‚ âˆ¶ Aâ‚, xâ‚‚ âˆ¶ Aâ‚‚, â€¦, xâ‚˜ âˆ¶ Aâ‚˜ âŠ¢ t(xâ‚, xâ‚‚, â€¦, xâ‚˜) âˆ¶ B.â€ -}

postulate fresh : Var    -- XXX: Fix this!


data _â…‹_~_ : âˆ€{m} â†’ VVar m â†’ Cx m â†’ Cx m â†’ Set where
  base : âˆ… â…‹ âˆ… ~ âˆ…

  step : âˆ€{x A m} {ğ± : VVar m} {Î“ Î“â€² : Cx m}
       â†’ ğ± â…‹ Î“ ~ Î“â€²
       â†’ (x âˆ· ğ±) â…‹ (Î“ , A) ~ (Î“â€² , ğœˆ x âˆ¶ A)


inâˆˆ : âˆ€{A m} {ğ± : VVar m} {Î“ Î“â€² : Cx m}
    â†’ ğ± â…‹ Î“ ~ Î“â€²    â†’ A âˆˆ Î“
    â†’ Î£ Var (Î» x â†’ ğœˆ x âˆ¶ A âˆˆ Î“â€²)
inâˆˆ {ğ± = âˆ…}              base     ()
inâˆˆ {ğ± = x âˆ· _} (step P) Z     = âŸ¨ x , Z âŸ©
inâˆˆ {ğ± = _ âˆ· ğ±} (step P) (S i) = let âŸ¨ y , j âŸ© = inâˆˆ {ğ± = ğ±} P i
                                 in
                                   âŸ¨ y , S j âŸ©


inâŠ¢ : âˆ€{B m} {ğ± : VVar m} {Î“ Î“â€² : Cx m}
    â†’ ğ± â…‹ Î“ ~ Î“â€²    â†’ Î“ âŠ¢ B
    â†’ Î£ (VVar m â†’ Tm) (Î» t â†’ Î“â€² âŠ¢ t ğ± âˆ¶ B)

inâŠ¢ {ğ± = ğ±} P (Rğœˆâ¿ {ğ± = ğ²} i)
    = let âŸ¨ x , j âŸ© = inâˆˆ {ğ± = ğ±} P i
      in
        âŸ¨ (Î» _ â†’ ğœˆ x)
        , Rğœˆâ¿ {ğ± = x âˆ· ğ²} j
        âŸ©

inâŠ¢ {ğ± = ğ±} P (Rğœ†â¿ {n} {ğ± = ğ²} {ğ­} D)
    = let xâ‚˜â‚Šâ‚      = fresh
          âŸ¨ s , C âŸ© = inâŠ¢ {ğ± = xâ‚˜â‚Šâ‚ âˆ· ğ±} (step P) D
      in
        âŸ¨ (Î» ğ± â†’ ğœ†^[ suc n ] xâ‚˜â‚Šâ‚ ï¼ s (xâ‚˜â‚Šâ‚ âˆ· ğ±))
        , Rğœ†â¿ {ğ± = xâ‚˜â‚Šâ‚ âˆ· ğ²} {ğ­ = s (xâ‚˜â‚Šâ‚ âˆ· ğ±) âˆ· ğ­} C
        âŸ©

inâŠ¢ {ğ± = ğ±} P (Râˆ˜â¿ {n} {ğ­} {ğ¬} Dâ‚œ Dâ‚›)
    = let âŸ¨ sâ‚œ , Câ‚œ âŸ© = inâŠ¢ {ğ± = ğ±} P Dâ‚œ
          âŸ¨ sâ‚› , Câ‚› âŸ© = inâŠ¢ {ğ± = ğ±} P Dâ‚›
      in
        âŸ¨ (Î» ğ± â†’ sâ‚œ ğ± âˆ˜^[ suc n ] sâ‚› ğ±)
        , Râˆ˜â¿ {ğ­ = sâ‚œ ğ± âˆ· ğ­} {ğ¬ = sâ‚› ğ± âˆ· ğ¬} Câ‚œ Câ‚›
        âŸ©

inâŠ¢ {ğ± = ğ±} P (Rğ‘â¿ {n} {ğ­} {ğ¬} Dâ‚œ Dâ‚›)
    = let âŸ¨ sâ‚œ , Câ‚œ âŸ© = inâŠ¢ {ğ± = ğ±} P Dâ‚œ
          âŸ¨ sâ‚› , Câ‚› âŸ© = inâŠ¢ {ğ± = ğ±} P Dâ‚›
      in
        âŸ¨ (Î» ğ± â†’ ğ‘^[ suc n ]âŸ¨ sâ‚œ ğ± , sâ‚› ğ± âŸ©)
        , Rğ‘â¿ {ğ­ = sâ‚œ ğ± âˆ· ğ­} {ğ¬ = sâ‚› ğ± âˆ· ğ¬} Câ‚œ Câ‚›
        âŸ©

inâŠ¢ {ğ± = ğ±} P (Rğœ‹â‚€â¿ {n} {ğ­} D)
    = let âŸ¨ s , C âŸ© = inâŠ¢ {ğ± = ğ±} P D
      in
        âŸ¨ (Î» ğ± â†’ ğœ‹â‚€^[ suc n ] s ğ±)
        , Rğœ‹â‚€â¿ {ğ­ = s ğ± âˆ· ğ­} C
        âŸ©

inâŠ¢ {ğ± = ğ±} P (Rğœ‹â‚â¿ {n} {ğ­} D)
    = let âŸ¨ s , C âŸ© = inâŠ¢ {ğ± = ğ±} P D
      in
        âŸ¨ (Î» ğ± â†’ ğœ‹â‚^[ suc n ] s ğ±)
        , Rğœ‹â‚â¿ {ğ­ = s ğ± âˆ· ğ­} C
        âŸ©

inâŠ¢ {ğ± = ğ±} P (Râ‡‘â¿ {n} {ğ­} D)
    = let âŸ¨ s , C âŸ© = inâŠ¢ {ğ± = ğ±} P D
      in
        âŸ¨ (Î» ğ± â†’ â‡‘^[ suc n ] s ğ±)
        , Râ‡‘â¿ {ğ­ = s ğ± âˆ· ğ­} C
        âŸ©

inâŠ¢ {ğ± = ğ±} P (Râ‡“â¿ {n} {ğ­} D)
    = let âŸ¨ s , C âŸ© = inâŠ¢ {ğ± = ğ±} P D
      in
        âŸ¨ (Î» ğ± â†’ â‡“^[ suc n ] s ğ±)
        , Râ‡“â¿ {ğ­ = s ğ± âˆ· ğ­} C
        âŸ©


-- --------------------------------------------------------------------------

-- Work in progress

mkâ‰² : âˆ€{m} {Î“ : Cx m} â†’ âˆ… â‰² Î“
mkâ‰² {Î“ = âˆ…}     = base
mkâ‰² {Î“ = x âˆ· Î“} = drop (mkâ‰² {Î“ = Î“})


_â…‹_ : âˆ€{m} â†’ VVar m â†’ Cx m â†’ Cx m
ğ± â…‹ Î“ = zipWith _âˆ¶_ (map ğœˆ_ ğ±) Î“


mk~ : âˆ€{m} {ğ± : VVar m} {Î“ : Cx m} â†’ ğ± â…‹ Î“ ~ (ğ± â…‹ Î“)
mk~ {ğ± = âˆ…}     {Î“ = âˆ…}     = base
mk~ {ğ± = x âˆ· ğ±} {Î“ = A âˆ· Î“} = step (mk~ {ğ± = ğ±} {Î“ = Î“})


int : âˆ€{B m} {ğ± : VVar m} {Î“ : Cx m}
    â†’ Î“ âŠ¢ B
    â†’ Î£ (VVar m â†’ Tm) (Î» t â†’ ğ± â…‹ Î“ âŠ¢ t ğ± âˆ¶ B)
int D = inâŠ¢ mk~ D


nec : âˆ€{B}
    â†’ âˆ… âŠ¢ B
    â†’ Î£ Tm (Î» t â†’ âˆ€{m} {Î“ : Cx m} â†’ Î“ âŠ¢ t âˆ¶ B)
nec D = let âŸ¨ s , C âŸ© = int D
        in
          âŸ¨ s âˆ… , wkâŠ¢ mkâ‰² C âŸ©


eIâ€²  : âˆ€{A m} {Î“ : Cx m}
     â†’ Î£ Tm (Î» t â†’ âŠ© t âˆ¶ (A âŠƒ A))
eIâ€²  = nec eIâ°

eIÂ²â€² : âˆ€{x A m} {Î“ : Cx m}
     â†’ Î£ Tm (Î» t â†’ âŠ© t âˆ¶ ğœ† x ï¼ ğœˆ x âˆ¶ (A âŠƒ A))
eIÂ²â€² = nec eI

eIÂ³â€² : âˆ€{u x A m} {Î“ : Cx m}
     â†’ Î£ Tm (Î» t â†’ âŠ© t âˆ¶ ğœ†Â² u ï¼ ğœˆ u âˆ¶ ğœ† x ï¼ ğœˆ x âˆ¶ (A âŠƒ A))
eIÂ³â€² = nec eIÂ²


eIÂ²â€³ : âˆ€{A m} {Î“ : Cx m}
     â†’ Î£ Tm (Î» t â†’ âŠ© t âˆ¶ ğœ† fresh ï¼ ğœˆ fresh âˆ¶ (A âŠƒ A))    -- XXX: Fix this!
eIÂ²â€³ {Î“ = Î“} = nec (projâ‚‚ (eIâ€² {Î“ = Î“}))

eIÂ³â€³ : âˆ€{A m} {Î“ : Cx m}
     â†’ Î£ Tm (Î» t â†’ âŠ© t âˆ¶ ğœ†Â² fresh ï¼ ğœˆ fresh âˆ¶ ğœ† fresh ï¼ ğœˆ fresh âˆ¶ (A âŠƒ A))    -- XXX: Fix this!
eIÂ³â€³ {Î“ = Î“} = nec (projâ‚‚ (eIÂ²â€² {Î“ = Î“}))
