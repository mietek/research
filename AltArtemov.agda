{-

An implementation of the Alt-ArtÃ«mov system Î»âˆ
==============================================

MiÃ«tek Bak  <mietek@bak.io>


Work in progress.  Checked with Agda 2.4.2.5.

For easy editing with Emacs agda-mode, add to your .emacs file:

'(agda-input-user-translations
   (quote
    (("N" "â„•")
     ("not" "Â¬") ("imp" "âŠƒ") ("iff" "âŠƒâŠ‚") ("ent" "âŠ¢") ("thm" "âŠ©")
     ("A" "ğ€") ("a" "ğš") ("s" "ğ¬") ("t" "ğ­") ("x" "ğ±") ("y" "ğ²")
     ("v" "ğœˆ") ("v0" "ğœˆâ°") ("v1" "ğœˆ") ("v2" "ğœˆÂ²") ("vn" "ğœˆâ¿")
     ("l" "ğœ†") ("l0" "ğœ†â°") ("l1" "ğœ†") ("l2" "ğœ†Â²") ("ln" "ğœ†â¿") ("." "ï¼")
     ("o" "âˆ˜") ("o0" "âˆ˜â°") ("o1" "âˆ˜") ("o2" "âˆ˜Â²") ("on" "âˆ˜â¿")
     ("p" "ğ‘") ("p0" "ğ‘â°") ("p1" "ğ‘") ("p2" "ğ‘Â²") ("pn" "ğ‘â¿")
     ("1" "ğœ‹â‚€") ("10" "ğœ‹â‚€â°") ("11" "ğœ‹â‚€") ("12" "ğœ‹â‚€Â²") ("1n" "ğœ‹â‚€â¿")
     ("2" "ğœ‹â‚") ("20" "ğœ‹â‚â°") ("21" "ğœ‹â‚") ("12" "ğœ‹â‚Â²") ("2n" "ğœ‹â‚â¿")
     ("u" "â‡‘") ("u0" "â‡‘â°") ("u1" "â‡‘") ("u2" "â‡‘Â²") ("un" "â‡‘â¿")
     ("d" "â‡“") ("d0" "â‡“â°") ("d1" "â‡“") ("d2" "â‡“Â²") ("dn" "â‡“â¿"))))


[1]: Alt, J., ArtÃ«mov, S. (2001) Reflective Î»-calculus, Proceedings of the
     2001 International Seminar on Proof Theory in Computer Science (PTCSâ€™01),
     Lecture Notes in Computer Science, vol. 2183, pp. 22â€“37.
     http://dx.doi.org/10.1007/3-540-45504-3_2

-}


module AltArtemov where

open import Data.Nat
  using (â„• ; zero ; suc ; _+_)

open import Data.Product
  using (Î£ ; _Ã—_)
  renaming (_,_ to _âˆ™_)

open import Data.Vec
  using (Vec ; _âˆ·_ ; _âˆˆ_ ; _[_]=_ ; foldl ; foldr ; map ; zipWith)
  renaming ([] to âˆ… ; here to Z ; there to S)

infixl 9 !_ ğœˆ_
infixl 8 _âˆ˜_ _âˆ˜Â²_ _âˆ˜^[_]_
infixr 7 â‡‘_ â‡‘Â²_ â‡‘^[_]_ â‡“_ â‡“Â²_ â‡“^[_]_
infixr 6 ğœ†_ï¼_ ğœ†Â²_ï¼_ ğœ†^[_]_ï¼_
infixr 5 _âˆ¶_
infixr 4 Â¬_
infixl 3 _âˆ§_
infixl 2 _,_
infixr 1 _âŠƒ_ _âŠƒâŠ‚_
infixr 0 _âŠ¢_ âŠ©_


mutual

  -- Variables

  Var : Set
  Var = â„•


  -- Term constructors

  data Tm : Set where
    ğœˆ_         : Var            â†’ Tm    -- Variable
    ğœ†^[_]_ï¼_   : â„•   â†’ Var â†’ Tm â†’ Tm    -- Abstraction
    _âˆ˜^[_]_    : Tm  â†’ â„•   â†’ Tm â†’ Tm    -- Application
    ğ‘^[_]âŸ¨_,_âŸ© : â„•   â†’ Tm  â†’ Tm â†’ Tm    -- Pairing
    ğœ‹â‚€^[_]_    : â„•   â†’ Tm       â†’ Tm    -- Left projection
    ğœ‹â‚^[_]_    : â„•   â†’ Tm       â†’ Tm    -- Right projection
    !_         : Tm             â†’ Tm    -- Proof checking
    â‡‘^[_]_     : â„•   â†’ Tm       â†’ Tm    -- Reification
    â‡“^[_]_     : â„•   â†’ Tm       â†’ Tm    -- Reflection


  -- Type constructors

  data Ty : Set where
    âŠ¥   :           Ty    -- Falsehood
    _âŠƒ_ : Ty â†’ Ty â†’ Ty    -- Implication
    _âˆ§_ : Ty â†’ Ty â†’ Ty    -- Conjunction
    _âˆ¶_ : Tm â†’ Ty â†’ Ty    -- Provability


-- Type examples

âŠ¤      : Ty               -- Truth
âŠ¤      = âŠ¥ âŠƒ âŠ¥

Â¬_     : Ty â†’ Ty          -- Negation
Â¬ A    = A âŠƒ âŠ¥

_âŠƒâŠ‚_   : Ty â†’ Ty â†’ Ty     -- Equivalence
A âŠƒâŠ‚ B = A âŠƒ B âˆ§ B âŠƒ A


-- ------------------------------------------------------------------------------------------------

-- Vectors

ixMap : âˆ€{n} {X Y : Set} â†’ (â„• â†’ X â†’ Y) â†’ Vec X n â†’ Vec Y n
ixMap {zero}  f âˆ…       = âˆ…
ixMap {suc n} f (x âˆ· ğ±) = f (suc n) x âˆ· ixMap f ğ±

ixZipWith : âˆ€{n} {X Xâ€² Y : Set} â†’ (â„• â†’ X â†’ Xâ€² â†’ Y) â†’ Vec X n â†’ Vec Xâ€² n â†’ Vec Y n
ixZipWith {zero}  f âˆ…       âˆ…       = âˆ…
ixZipWith {suc n} f (x âˆ· ğ±) (y âˆ· ğ²) = f (suc n) x y âˆ· ixZipWith f ğ± ğ²


-- Vector notation

VVar : â„• â†’ Set
VVar = Vec Var

VTm  : â„• â†’ Set
VTm  = Vec Tm

VTy  : â„• â†’ Set
VTy  = Vec Ty


*â¿_âˆ¶_          : âˆ€{n} â†’ VTm n â†’ Ty â†’ Ty
*â¿ ğ­ âˆ¶ A       = foldr (Î» _ â†’ Ty) _âˆ¶_ A ğ­

ğœˆâ¿_âˆ¶_          : âˆ€{n} â†’ VVar n â†’ Ty â†’ Ty
ğœˆâ¿ ğ± âˆ¶ A       = *â¿ (map ğœˆ_ ğ±) âˆ¶ A

ğœ†â¿_ï¼_âˆ¶_        : âˆ€{n} â†’ VVar n â†’ VTm n â†’ Ty â†’ Ty
ğœ†â¿ ğ± ï¼ ğ­ âˆ¶ A   = *â¿ (ixZipWith ğœ†^[_]_ï¼_ ğ± ğ­) âˆ¶ A

_âˆ˜â¿_âˆ¶_         : âˆ€{n} â†’ VTm n â†’ VTm n â†’ Ty â†’ Ty
ğ­ âˆ˜â¿ ğ¬ âˆ¶ A     = *â¿ (ixZipWith (Î» n t s â†’ t âˆ˜^[ n ] s) ğ­ ğ¬) âˆ¶ A

ğ‘â¿âŸ¨_,_âŸ©âˆ¶_      : âˆ€{n} â†’ VTm n â†’ VTm n â†’ Ty â†’ Ty
ğ‘â¿âŸ¨ ğ­ , ğ¬ âŸ©âˆ¶ A = *â¿ (ixZipWith ğ‘^[_]âŸ¨_,_âŸ© ğ­ ğ¬) âˆ¶ A

ğœ‹â‚€â¿_âˆ¶_         : âˆ€{n} â†’ VTm n â†’ Ty â†’ Ty
ğœ‹â‚€â¿ ğ­ âˆ¶ A      = *â¿ (ixMap ğœ‹â‚€^[_]_ ğ­) âˆ¶ A

ğœ‹â‚â¿_âˆ¶_         : âˆ€{n} â†’ VTm n â†’ Ty â†’ Ty
ğœ‹â‚â¿ ğ­ âˆ¶ A      = *â¿ (ixMap ğœ‹â‚^[_]_ ğ­) âˆ¶ A

â‡‘â¿_âˆ¶_          : âˆ€{n} â†’ VTm n â†’ Ty â†’ Ty
â‡‘â¿ ğ­ âˆ¶ A       = *â¿ (ixMap â‡‘^[_]_ ğ­) âˆ¶ A

â‡“â¿_âˆ¶_          : âˆ€{n} â†’ VTm n â†’ Ty â†’ Ty
â‡“â¿ ğ­ âˆ¶ A       = *â¿ (ixMap â‡“^[_]_ ğ­) âˆ¶ A


-- ------------------------------------------------------------------------------------------------

-- Typing contexts

Cx : â„• â†’ Set
Cx = Vec Ty

_,_ : {m : â„•} â†’ Cx m â†’ Ty â†’ Cx (suc m)
Î“ , A = A âˆ· Î“


-- Typing rules

data _âŠ¢_ {m : â„•} (Î“ : Cx m) : Ty â†’ Set where
  Rğœˆâ¿  : âˆ€{n} {ğ± : VVar n} {A : Ty}
       â†’ ğœˆâ¿ ğ± âˆ¶ A âˆˆ Î“
       â†’ Î“ âŠ¢ ğœˆâ¿ ğ± âˆ¶ A

  Rğœ†â¿  : âˆ€{n} {ğ± : VVar n} {ğ­ : VTm n} {A B : Ty}
       â†’ Î“ , ğœˆâ¿ ğ± âˆ¶ A âŠ¢ *â¿ ğ­ âˆ¶ B
       â†’ Î“ âŠ¢ ğœ†â¿ ğ± ï¼ ğ­ âˆ¶ (A âŠƒ B)

  Râˆ˜â¿  : âˆ€{n} {ğ­ ğ¬ : VTm n} {A B : Ty}
       â†’ Î“ âŠ¢ *â¿ ğ­ âˆ¶ (A âŠƒ B)    â†’ Î“ âŠ¢ *â¿ ğ¬ âˆ¶ A
       â†’ Î“ âŠ¢ ğ­ âˆ˜â¿ ğ¬ âˆ¶ B

  Rğ‘â¿  : âˆ€{n} {ğ­ ğ¬ : VTm n} {A B : Ty}
       â†’ Î“ âŠ¢ *â¿ ğ­ âˆ¶ A          â†’ Î“ âŠ¢ *â¿ ğ¬ âˆ¶ B
       â†’ Î“ âŠ¢ ğ‘â¿âŸ¨ ğ­ , ğ¬ âŸ©âˆ¶ (A âˆ§ B)

  Rğœ‹â‚€â¿ : âˆ€{n} {ğ­ : VTm n} {A B : Ty}
       â†’ Î“ âŠ¢ *â¿ ğ­ âˆ¶ (A âˆ§ B)
       â†’ Î“ âŠ¢ ğœ‹â‚€â¿ ğ­ âˆ¶ A

  Rğœ‹â‚â¿ : âˆ€{n} {ğ­ : VTm n} {A B : Ty}
       â†’ Î“ âŠ¢ *â¿ ğ­ âˆ¶ (A âˆ§ B)
       â†’ Î“ âŠ¢ ğœ‹â‚â¿ ğ­ âˆ¶ B

  Râ‡‘â¿  : âˆ€{n} {ğ­ : VTm n} {u : Tm} {A : Ty}
       â†’ Î“ âŠ¢ *â¿ ğ­ âˆ¶ (u âˆ¶ A)
       â†’ Î“ âŠ¢ â‡‘â¿ ğ­ âˆ¶ (! u âˆ¶ u âˆ¶ A)

  Râ‡“â¿  : âˆ€{n} {ğ­ : VTm n} {u : Tm} {A : Ty}
       â†’ Î“ âŠ¢ *â¿ ğ­ âˆ¶ (u âˆ¶ A)
       â†’ Î“ âŠ¢ â‡“â¿ ğ­ âˆ¶ A


-- Theorems

âŠ©_  : Ty â†’ Set
âŠ© A = âˆ€{m} {Î“ : Cx m} â†’ Î“ âŠ¢ A


-- ------------------------------------------------------------------------------------------------

-- Level 0: Simplified typing rules

Rğœˆâ°  : âˆ€{A m} {Î“ : Cx m}
     â†’ A âˆˆ Î“
     â†’ Î“ âŠ¢ A
Rğœˆâ° = Rğœˆâ¿ {ğ± = âˆ…}

Rğœ†â°  : âˆ€{A B m} {Î“ : Cx m}
     â†’ Î“ , A âŠ¢ B
     â†’ Î“ âŠ¢ A âŠƒ B
Rğœ†â° = Rğœ†â¿ {ğ± = âˆ…} {ğ­ = âˆ…}

Râˆ˜â°  : âˆ€{A B m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ A âŠƒ B    â†’ Î“ âŠ¢ A
     â†’ Î“ âŠ¢ B
Râˆ˜â° = Râˆ˜â¿ {ğ­ = âˆ…} {ğ¬ = âˆ…}

Rğ‘â°  : âˆ€{A B m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ A        â†’ Î“ âŠ¢ B
     â†’ Î“ âŠ¢ A âˆ§ B
Rğ‘â° = Rğ‘â¿ {ğ­ = âˆ…} {ğ¬ = âˆ…}

Rğœ‹â‚€â° : âˆ€{A B m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ A âˆ§ B
     â†’ Î“ âŠ¢ A
Rğœ‹â‚€â° = Rğœ‹â‚€â¿ {ğ­ = âˆ…}

Rğœ‹â‚â° : âˆ€{A B m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ A âˆ§ B
     â†’ Î“ âŠ¢ B
Rğœ‹â‚â° = Rğœ‹â‚â¿ {ğ­ = âˆ…}


-- Level 0: Example (I combinator)

eIâ° : âˆ€{A}
    â†’ âŠ© A âŠƒ A
eIâ° = Rğœ†â° (Rğœˆâ° Z)


-- Level 0: Example (K combinator)

eKâ° : âˆ€{A B}
    â†’ âŠ© A âŠƒ B âŠƒ A
eKâ° = Rğœ†â° (Rğœ†â° (Rğœˆâ° (S Z)))


-- Level 0: Example (S combinator)

eSâ° : âˆ€{A B C}
    â†’ âŠ© (A âŠƒ B âŠƒ C) âŠƒ (A âŠƒ B) âŠƒ A âŠƒ C
eSâ° = Rğœ†â° (Rğœ†â° (Rğœ†â° (Râˆ˜â° (Râˆ˜â° (Rğœˆâ° (S (S Z)))
                              (Rğœˆâ° Z))
                         (Râˆ˜â° (Rğœˆâ° (S Z))
                              (Rğœˆâ° Z)))))


-- ------------------------------------------------------------------------------------------------

-- Level 1: Simplified term constructors

ğœ†_ï¼_       : Var â†’ Tm â†’ Tm
ğœ† x ï¼ t    = ğœ†^[ 1 ] x ï¼ t

_âˆ˜_        : Tm â†’ Tm â†’ Tm
t âˆ˜ s      = t âˆ˜^[ 1 ] s

ğ‘âŸ¨_,_âŸ©     : Tm â†’ Tm â†’ Tm
ğ‘âŸ¨ t , s âŸ© = ğ‘^[ 1 ]âŸ¨ t , s âŸ©

ğœ‹â‚€_        : Tm â†’ Tm
ğœ‹â‚€ t       = ğœ‹â‚€^[ 1 ] t

ğœ‹â‚_        : Tm â†’ Tm
ğœ‹â‚ t       = ğœ‹â‚^[ 1 ] t

â‡‘_         : Tm â†’ Tm
â‡‘ t        = â‡‘^[ 1 ] t

â‡“_         : Tm â†’ Tm
â‡“ t        = â‡“^[ 1 ] t


-- Level 1: Simplified typing rules

Rğœˆ  : âˆ€{x A m} {Î“ : Cx m}
    â†’ ğœˆ x âˆ¶ A âˆˆ Î“
    â†’ Î“ âŠ¢ ğœˆ x âˆ¶ A
Rğœˆ {x} = Rğœˆâ¿ {ğ± = x âˆ· âˆ…}

Rğœ†  : âˆ€{x t A B m} {Î“ : Cx m}
    â†’ Î“ , ğœˆ x âˆ¶ A âŠ¢ t âˆ¶ B
    â†’ Î“ âŠ¢ ğœ† x ï¼ t âˆ¶ (A âŠƒ B)
Rğœ† {x} {t} = Rğœ†â¿ {ğ± = x âˆ· âˆ…} {ğ­ = t âˆ· âˆ…}

Râˆ˜  : âˆ€{t s A B m} {Î“ : Cx m}
    â†’ Î“ âŠ¢ t âˆ¶ (A âŠƒ B)    â†’ Î“ âŠ¢ s âˆ¶ A
    â†’ Î“ âŠ¢ t âˆ˜ s âˆ¶ B
Râˆ˜ {t} {s} = Râˆ˜â¿ {ğ­ = t âˆ· âˆ…} {ğ¬ = s âˆ· âˆ…}

Rğ‘  : âˆ€{t s A B m} {Î“ : Cx m}
    â†’ Î“ âŠ¢ t âˆ¶ A          â†’ Î“ âŠ¢ s âˆ¶ B
    â†’ Î“ âŠ¢ ğ‘âŸ¨ t , s âŸ© âˆ¶ (A âˆ§ B)
Rğ‘ {t} {s} = Rğ‘â¿ {ğ­ = t âˆ· âˆ…} {ğ¬ = s âˆ· âˆ…}

Rğœ‹â‚€ : âˆ€{t A B m} {Î“ : Cx m}
    â†’ Î“ âŠ¢ t âˆ¶ (A âˆ§ B)
    â†’ Î“ âŠ¢ ğœ‹â‚€ t âˆ¶ A
Rğœ‹â‚€ {t} = Rğœ‹â‚€â¿ {ğ­ = t âˆ· âˆ…}

Rğœ‹â‚ : âˆ€{t A B m} {Î“ : Cx m}
    â†’ Î“ âŠ¢ t âˆ¶ (A âˆ§ B)
    â†’ Î“ âŠ¢ ğœ‹â‚ t âˆ¶ B
Rğœ‹â‚ {t} = Rğœ‹â‚â¿ {ğ­ = t âˆ· âˆ…}

Râ‡‘  : âˆ€{t u A m} {Î“ : Cx m}
    â†’ Î“ âŠ¢ t âˆ¶ u âˆ¶ A
    â†’ Î“ âŠ¢ â‡‘ t âˆ¶ ! u âˆ¶ u âˆ¶ A
Râ‡‘ {t} = Râ‡‘â¿ {ğ­ = t âˆ· âˆ…}

Râ‡“  : âˆ€{t u A m} {Î“ : Cx m}
    â†’ Î“ âŠ¢ t âˆ¶ u âˆ¶ A
    â†’ Î“ âŠ¢ â‡“ t âˆ¶ A
Râ‡“ {t} = Râ‡“â¿ {ğ­ = t âˆ· âˆ…}


-- Level 1: Example (I combinator)

eI : âˆ€{x A}
   â†’ âŠ© ğœ† x ï¼ ğœˆ x
       âˆ¶ (A âŠƒ A)
eI = Rğœ† (Rğœˆ Z)


-- Level 1: Example (K combinator)

eK : âˆ€{x y A B}
   â†’ âŠ© ğœ† x ï¼ ğœ† y ï¼ ğœˆ x
       âˆ¶ (A âŠƒ B âŠƒ A)
eK = Rğœ† (Rğœ† (Rğœˆ (S Z)))


-- Level 1: Example (S combinator)

eS : âˆ€{f g x A B C}
   â†’ âŠ© ğœ† f ï¼ ğœ† g ï¼ ğœ† x ï¼ (ğœˆ f âˆ˜ ğœˆ x) âˆ˜ (ğœˆ g âˆ˜ ğœˆ x)
       âˆ¶ ((A âŠƒ B âŠƒ C) âŠƒ (A âŠƒ B) âŠƒ A âŠƒ C)
eS = Rğœ† (Rğœ† (Rğœ† (Râˆ˜ (Râˆ˜ (Rğœˆ (S (S Z)))
                        (Rğœˆ Z))
                    (Râˆ˜ (Rğœˆ (S Z))
                        (Rğœˆ Z)))))


-- ------------------------------------------------------------------------------------------------

-- Level 2: Simplified term constructors

ğœ†Â²_ï¼_       : Var â†’ Tm â†’ Tm
ğœ†Â² x ï¼ t    = ğœ†^[ 2 ] x ï¼ t

_âˆ˜Â²_        : Tm â†’ Tm â†’ Tm
t âˆ˜Â² s      = t âˆ˜^[ 2 ] s

ğ‘Â²âŸ¨_,_âŸ©     : Tm â†’ Tm â†’ Tm
ğ‘Â²âŸ¨ t , s âŸ© = ğ‘^[ 2 ]âŸ¨ t , s âŸ©

ğœ‹â‚€Â²_        : Tm â†’ Tm
ğœ‹â‚€Â² t       = ğœ‹â‚€^[ 2 ] t

ğœ‹â‚Â²_        : Tm â†’ Tm
ğœ‹â‚Â² t       = ğœ‹â‚^[ 2 ] t

â‡‘Â²_         : Tm â†’ Tm
â‡‘Â² t        = â‡‘^[ 2 ] t

â‡“Â²_         : Tm â†’ Tm
â‡“Â² t        = â‡“^[ 2 ] t


-- Level 2: Simplified typing rules

RğœˆÂ²  : âˆ€{xâ‚‚ xâ‚ A m} {Î“ : Cx m}
     â†’ ğœˆ xâ‚‚ âˆ¶ ğœˆ xâ‚ âˆ¶ A âˆˆ Î“
     â†’ Î“ âŠ¢ ğœˆ xâ‚‚ âˆ¶ ğœˆ xâ‚ âˆ¶ A
RğœˆÂ² {xâ‚‚} {xâ‚} = Rğœˆâ¿ {ğ± = xâ‚‚ âˆ· xâ‚ âˆ· âˆ…}

Rğœ†Â²  : âˆ€{xâ‚‚ xâ‚ tâ‚‚ tâ‚ A B m} {Î“ : Cx m}
     â†’ Î“ , ğœˆ xâ‚‚ âˆ¶ ğœˆ xâ‚ âˆ¶ A âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ B
     â†’ Î“ âŠ¢ ğœ†Â² xâ‚‚ ï¼ tâ‚‚ âˆ¶ ğœ† xâ‚ ï¼ tâ‚ âˆ¶ (A âŠƒ B)
Rğœ†Â² {xâ‚‚} {xâ‚} {tâ‚‚} {tâ‚} = Rğœ†â¿ {ğ± = xâ‚‚ âˆ· xâ‚ âˆ· âˆ…} {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…}

Râˆ˜Â²  : âˆ€{tâ‚‚ tâ‚ sâ‚‚ sâ‚ A B m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ (A âŠƒ B)    â†’ Î“ âŠ¢ sâ‚‚ âˆ¶ sâ‚ âˆ¶ A
     â†’ Î“ âŠ¢ tâ‚‚ âˆ˜Â² sâ‚‚ âˆ¶ tâ‚ âˆ˜ sâ‚ âˆ¶ B
Râˆ˜Â² {tâ‚‚} {tâ‚} {sâ‚‚} {sâ‚} = Râˆ˜â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…} {ğ¬ = sâ‚‚ âˆ· sâ‚ âˆ· âˆ…}

Rğ‘Â²  : âˆ€{tâ‚‚ tâ‚ sâ‚‚ sâ‚ A B m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ A          â†’ Î“ âŠ¢ sâ‚‚ âˆ¶ sâ‚ âˆ¶ B
     â†’ Î“ âŠ¢ ğ‘Â²âŸ¨ tâ‚‚ , sâ‚‚ âŸ© âˆ¶ ğ‘âŸ¨ tâ‚ , sâ‚ âŸ© âˆ¶ (A âˆ§ B)
Rğ‘Â² {tâ‚‚} {tâ‚} {sâ‚‚} {sâ‚} = Rğ‘â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…} {ğ¬ = sâ‚‚ âˆ· sâ‚ âˆ· âˆ…}

Rğœ‹â‚€Â² : âˆ€{tâ‚‚ tâ‚ A B m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ (A âˆ§ B)
     â†’ Î“ âŠ¢ ğœ‹â‚€Â² tâ‚‚ âˆ¶ ğœ‹â‚€ tâ‚ âˆ¶ A
Rğœ‹â‚€Â² {tâ‚‚} {tâ‚} = Rğœ‹â‚€â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…}

Rğœ‹â‚Â² : âˆ€{tâ‚‚ tâ‚ A B m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ (A âˆ§ B)
     â†’ Î“ âŠ¢ ğœ‹â‚Â² tâ‚‚ âˆ¶ ğœ‹â‚ tâ‚ âˆ¶ B
Rğœ‹â‚Â² {tâ‚‚} {tâ‚} = Rğœ‹â‚â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…}

Râ‡‘Â²  : âˆ€{tâ‚‚ tâ‚ u A m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ u âˆ¶ A
     â†’ Î“ âŠ¢ â‡‘Â² tâ‚‚ âˆ¶ â‡‘ tâ‚ âˆ¶ ! u âˆ¶ u âˆ¶ A
Râ‡‘Â² {tâ‚‚} {tâ‚} = Râ‡‘â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…}

Râ‡“Â²  : âˆ€{tâ‚‚ tâ‚ u A m} {Î“ : Cx m}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ u âˆ¶ A
     â†’ Î“ âŠ¢ â‡“Â² tâ‚‚ âˆ¶ â‡“ tâ‚ âˆ¶ A
Râ‡“Â² {tâ‚‚} {tâ‚} = Râ‡“â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…}


-- Level 2: Example (I combinator)

eIÂ² : âˆ€{u x A}
    â†’ âŠ© ğœ†Â² u ï¼ ğœˆ u
        âˆ¶ ğœ† x ï¼ ğœˆ x
          âˆ¶ (A âŠƒ A)
eIÂ² = Rğœ†Â² (RğœˆÂ² Z)


-- Level 2: Example (K combinator)

eKÂ² : âˆ€{u x v y A B}
    â†’ âŠ© ğœ†Â² u ï¼ ğœ†Â² v ï¼ ğœˆ u
        âˆ¶ ğœ† x ï¼ ğœ† y ï¼ ğœˆ x
          âˆ¶ (A âŠƒ B âŠƒ A)
eKÂ² = Rğœ†Â² (Rğœ†Â² (RğœˆÂ² (S Z)))


-- Level 2: Example (S combinator)

eSÂ² : âˆ€{f g x A B C}
    â†’ âŠ© ğœ†Â² f ï¼ ğœ†Â² g ï¼ ğœ†Â² x ï¼ (ğœˆ f âˆ˜Â² ğœˆ x) âˆ˜Â² (ğœˆ g âˆ˜Â² ğœˆ x)
        âˆ¶ ğœ† f ï¼ ğœ† g ï¼ ğœ† x ï¼ (ğœˆ f âˆ˜ ğœˆ x) âˆ˜ (ğœˆ g âˆ˜ ğœˆ x)
          âˆ¶ ((A âŠƒ B âŠƒ C) âŠƒ (A âŠƒ B) âŠƒ A âŠƒ C)
eSÂ² = Rğœ†Â² (Rğœ†Â² (Rğœ†Â² (Râˆ˜Â² (Râˆ˜Â² (RğœˆÂ² (S (S Z)))
                              (RğœˆÂ² Z))
                         (Râˆ˜Â² (RğœˆÂ² (S Z))
                              (RğœˆÂ² Z)))))


-- ------------------------------------------------------------------------------------------------

-- Example 1.1, p. 28 [1]

e11 : âˆ€{x y A}
    â†’ âŠ© ğœ† y ï¼ â‡“ ğœˆ y
        âˆ¶ (ğœˆ x âˆ¶ A âŠƒ A)
e11 = Rğœ† (Râ‡“ (Rğœˆ Z))


-- Example 1.2, p. 28 [1]

e12 : âˆ€{x y A}
    â†’ âŠ© ğœ† y ï¼ â‡‘ ğœˆ y
        âˆ¶ (ğœˆ x âˆ¶ A âŠƒ ! ğœˆ x âˆ¶ ğœˆ x âˆ¶ A)
e12 = Rğœ† (Râ‡‘ (Rğœˆ Z))


-- Example 1.3, p. 28 [1]

e13 : âˆ€{u x v y A B}
    â†’ âŠ© ğœ†Â² u ï¼ ğœ†Â² v ï¼ ğ‘Â²âŸ¨ ğœˆ u , ğœˆ v âŸ©
        âˆ¶ ğœ† x ï¼ ğœ† y ï¼ ğ‘âŸ¨ ğœˆ x , ğœˆ y âŸ©
          âˆ¶ (A âŠƒ B âŠƒ A âˆ§ B)
e13 = Rğœ†Â² (Rğœ†Â² (Rğ‘Â² (RğœˆÂ² (S Z))
                    (RğœˆÂ² Z)))


-- Example 1.4, p. 28 [1]

e14 : âˆ€{u x v y A B}
    â†’ âŠ© ğœ† u ï¼ ğœ† v ï¼ â‡‘ ğ‘Â²âŸ¨ ğœˆ u , ğœˆ v âŸ©
        âˆ¶ (ğœˆ x âˆ¶ A âŠƒ ğœˆ y âˆ¶ B âŠƒ ! ğ‘âŸ¨ ğœˆ x , ğœˆ y âŸ© âˆ¶ ğ‘âŸ¨ ğœˆ x , ğœˆ y âŸ© âˆ¶ (A âˆ§ B))
e14 = Rğœ† (Rğœ† (Râ‡‘ (Rğ‘Â² (Rğœˆ (S Z))
                      (Rğœˆ Z))))


-- Example 2, p. 31 [1]

e2 : âˆ€{xâ‚ƒ xâ‚‚ xâ‚ A}
   â†’ âŠ© ğœ†Â² xâ‚ƒ ï¼ â‡“Â² â‡‘Â² ğœˆ xâ‚ƒ
       âˆ¶ ğœ† xâ‚‚ ï¼ â‡“ â‡‘ ğœˆ xâ‚‚
         âˆ¶ (ğœˆ xâ‚ âˆ¶ A âŠƒ ğœˆ xâ‚ âˆ¶ A)
e2 = Rğœ†Â² (Râ‡“Â² (Râ‡‘Â² (RğœˆÂ² Z)))


-- Example 2, p. 32 [1]

e2â€² : âˆ€{xâ‚ƒ xâ‚‚ xâ‚ A}
    â†’ âŠ© ğœ†Â² xâ‚ƒ ï¼ ğœˆ xâ‚ƒ
        âˆ¶ ğœ† xâ‚‚ ï¼ ğœˆ xâ‚‚
          âˆ¶ (ğœˆ xâ‚ âˆ¶ A âŠƒ ğœˆ xâ‚ âˆ¶ A)
e2â€² = Rğœ†Â² (RğœˆÂ² Z)


-- ------------------------------------------------------------------------------------------------

-- Weakening

data _âŠ†_ : âˆ€{m mâ€²} â†’ Cx m â†’ Cx mâ€² â†’ Set where
  base : âˆ… âŠ† âˆ…

  keep : âˆ€{A m mâ€²} {Î“ : Cx m} {Î“â€² : Cx mâ€²}
       â†’ Î“ âŠ† Î“â€²
       â†’ (Î“ , A) âŠ† (Î“â€² , A)

  drop : âˆ€{A m mâ€²} {Î“ : Cx m} {Î“â€² : Cx mâ€²}
       â†’ Î“ âŠ† Î“â€²
       â†’ Î“ âŠ† (Î“â€² , A)


-- Weakening: Context membership

wkâˆˆ : âˆ€{A m mâ€²} {Î“ : Cx m} {Î“â€² : Cx mâ€²}
    â†’ Î“ âŠ† Î“â€²    â†’ A âˆˆ Î“
    â†’ A âˆˆ Î“â€²
wkâˆˆ base        ()
wkâˆˆ (keep P) Z     = Z
wkâˆˆ (keep P) (S i) = S (wkâˆˆ P i)
wkâˆˆ (drop P) i     = S (wkâˆˆ P i)


-- Weakening: Typing rules

wkâŠ¢ : âˆ€{A m mâ€²} {Î“ : Cx m} {Î“â€² : Cx mâ€²}
    â†’ Î“ âŠ† Î“â€²    â†’ Î“ âŠ¢ A
    â†’ Î“â€² âŠ¢ A
wkâŠ¢ P (Rğœˆâ¿  {ğ± = ğ±} i)             = Rğœˆâ¿  {ğ± = ğ±} (wkâˆˆ P i)
wkâŠ¢ P (Rğœ†â¿  {ğ± = ğ±} {ğ­ = ğ­} D)     = Rğœ†â¿  {ğ± = ğ±} {ğ­ = ğ­} (wkâŠ¢ (keep P) D)
wkâŠ¢ P (Râˆ˜â¿  {ğ­ = ğ­} {ğ¬ = ğ¬} Dâ‚œ Dâ‚›) = Râˆ˜â¿  {ğ­ = ğ­} {ğ¬ = ğ¬} (wkâŠ¢ P Dâ‚œ) (wkâŠ¢ P Dâ‚›)
wkâŠ¢ P (Rğ‘â¿  {ğ­ = ğ­} {ğ¬ = ğ¬} Dâ‚œ Dâ‚›) = Rğ‘â¿  {ğ­ = ğ­} {ğ¬ = ğ¬} (wkâŠ¢ P Dâ‚œ) (wkâŠ¢ P Dâ‚›)
wkâŠ¢ P (Rğœ‹â‚€â¿ {ğ­ = ğ­} D)             = Rğœ‹â‚€â¿ {ğ­ = ğ­} (wkâŠ¢ P D)
wkâŠ¢ P (Rğœ‹â‚â¿ {ğ­ = ğ­} D)             = Rğœ‹â‚â¿ {ğ­ = ğ­} (wkâŠ¢ P D)
wkâŠ¢ P (Râ‡‘â¿  {ğ­ = ğ­} D)             = Râ‡‘â¿  {ğ­ = ğ­} (wkâŠ¢ P D)
wkâŠ¢ P (Râ‡“â¿  {ğ­ = ğ­} D)             = Râ‡“â¿  {ğ­ = ğ­} (wkâŠ¢ P D)


-- ------------------------------------------------------------------------------------------------

-- Exchange

data _%_ : âˆ€{m} â†’ Cx m â†’ Cx m â†’ Set where
  base : âˆ… % âˆ…

  just : âˆ€{A m} {Î“ Î“â€² : Cx m}
       â†’ Î“ % Î“â€²
       â†’ (Î“ , A) % (Î“â€² , A)

  same : âˆ€{A B m} {Î“ Î“â€² : Cx m}
       â†’ Î“ % Î“â€²
       â†’ (Î“ , A , B) % (Î“â€² , A , B)

  diff : âˆ€{A B m} {Î“ Î“â€² : Cx m}
       â†’ Î“ % Î“â€²
       â†’ (Î“ , B , A) % (Î“â€² , A , B)


-- Exchange: Context membership

exâˆˆ : âˆ€{A m} {Î“ Î“â€² : Cx m}
    â†’ Î“ % Î“â€²    â†’ A âˆˆ Î“
    â†’ A âˆˆ Î“â€²
exâˆˆ base     i         = i
exâˆˆ (just P) Z         = Z
exâˆˆ (just P) (S i)     = S (exâˆˆ P i)
exâˆˆ (same P) Z         = Z
exâˆˆ (same P) (S Z)     = S Z
exâˆˆ (same P) (S (S i)) = S (S (exâˆˆ P i))
exâˆˆ (diff P) Z         = S Z
exâˆˆ (diff P) (S Z)     = Z
exâˆˆ (diff P) (S (S i)) = S (S (exâˆˆ P i))


-- Exchange: Typing rules

exâŠ¢ : âˆ€{A m} {Î“ Î“â€² : Cx m}
    â†’ Î“ % Î“â€²    â†’ Î“ âŠ¢ A
    â†’ Î“â€² âŠ¢ A
exâŠ¢ P (Rğœˆâ¿  {ğ± = ğ±} i)             = Rğœˆâ¿  {ğ± = ğ±} (exâˆˆ P i)
exâŠ¢ P (Rğœ†â¿  {ğ± = ğ±} {ğ­ = ğ­} D)     = Rğœ†â¿  {ğ± = ğ±} {ğ­ = ğ­} (exâŠ¢ (just P) D)
exâŠ¢ P (Râˆ˜â¿  {ğ­ = ğ­} {ğ¬ = ğ¬} Dâ‚œ Dâ‚›) = Râˆ˜â¿  {ğ­ = ğ­} {ğ¬ = ğ¬} (exâŠ¢ P Dâ‚œ) (exâŠ¢ P Dâ‚›)
exâŠ¢ P (Rğ‘â¿  {ğ­ = ğ­} {ğ¬ = ğ¬} Dâ‚œ Dâ‚›) = Rğ‘â¿  {ğ­ = ğ­} {ğ¬ = ğ¬} (exâŠ¢ P Dâ‚œ) (exâŠ¢ P Dâ‚›)
exâŠ¢ P (Rğœ‹â‚€â¿ {ğ­ = ğ­} D)             = Rğœ‹â‚€â¿ {ğ­ = ğ­} (exâŠ¢ P D)
exâŠ¢ P (Rğœ‹â‚â¿ {ğ­ = ğ­} D)             = Rğœ‹â‚â¿ {ğ­ = ğ­} (exâŠ¢ P D)
exâŠ¢ P (Râ‡‘â¿  {ğ­ = ğ­} D)             = Râ‡‘â¿  {ğ­ = ğ­} (exâŠ¢ P D)
exâŠ¢ P (Râ‡“â¿  {ğ­ = ğ­} D)             = Râ‡“â¿  {ğ­ = ğ­} (exâŠ¢ P D)


-- ------------------------------------------------------------------------------------------------

-- Theorem 1 (Internalisation principle), p. 29 [1]

{- â€œLet Î»âˆ derive
        Aâ‚, Aâ‚‚, â€¦, Aâ‚˜ âŠ¢ B.
    Then one can build a well-defined term t(xâ‚, xâ‚‚, â€¦, xâ‚˜) with fresh
    variables ğ± such that Î»âˆ also derives
        xâ‚ âˆ¶ Aâ‚, xâ‚‚ âˆ¶ Aâ‚‚, â€¦, xâ‚˜ âˆ¶ Aâ‚˜ âŠ¢ t(xâ‚, xâ‚‚, â€¦, xâ‚˜) âˆ¶ B.â€ -}

data ğœˆâ¿_âˆ¶_~_ : âˆ€{m} â†’ VVar m â†’ Cx m â†’ Cx m â†’ Set where
  base : ğœˆâ¿ âˆ… âˆ¶ âˆ… ~ âˆ…

  step : âˆ€{x A m} {ğ± : VVar m} {Î“ Î“â€² : Cx m}
       â†’ ğœˆâ¿ ğ± âˆ¶ Î“ ~ Î“â€²
       â†’ ğœˆâ¿ (x âˆ· ğ±) âˆ¶ (Î“ , A) ~ (Î“â€² , ğœˆ x âˆ¶ A)


-- Internalisation: Context membership

inâˆˆ : âˆ€{A m} {ğ± : VVar m} {Î“ Î“â€² : Cx m}
    â†’ ğœˆâ¿ ğ± âˆ¶ Î“ ~ Î“â€²    â†’ A âˆˆ Î“
    â†’ Î£ Var (Î» x â†’ ğœˆ x âˆ¶ A âˆˆ Î“â€²)

inâˆˆ base ()

inâˆˆ (step {x = x} P) Z
    = x âˆ™ Z

inâˆˆ (step P) (S i)
    = let x âˆ™ j = inâˆˆ P i
      in
        x âˆ™ S j


-- Internalisation: Typing rules

postulate fresh : Var    -- XXX: Fix this!

inâŠ¢ : âˆ€{B m} {ğ± : VVar m} {Î“ Î“â€² : Cx m}
    â†’ ğœˆâ¿ ğ± âˆ¶ Î“ ~ Î“â€²    â†’ Î“ âŠ¢ B
    â†’ Î£ (VVar m â†’ Tm) (Î» t â†’ Î“â€² âŠ¢ t ğ± âˆ¶ B)

inâŠ¢ P (Rğœˆâ¿ {ğ± = ğ²} i)
    = let x âˆ™ j = inâˆˆ P i
      in
        (Î» _ â†’ ğœˆ x)
      âˆ™ Rğœˆâ¿ {ğ± = x âˆ· ğ²} j

inâŠ¢ {ğ± = ğ±} P (Rğœ†â¿ {n} {ğ± = ğ²} {ğ­} {A} D)
    = let xâ‚˜â‚Šâ‚  = fresh
          s âˆ™ C = inâŠ¢ (step {x = xâ‚˜â‚Šâ‚} {A = ğœˆâ¿ ğ² âˆ¶ A} P) D
      in
        (Î» ğ± â†’ ğœ†^[ suc n ] xâ‚˜â‚Šâ‚ ï¼ s (xâ‚˜â‚Šâ‚ âˆ· ğ±))
      âˆ™ Rğœ†â¿ {ğ± = xâ‚˜â‚Šâ‚ âˆ· ğ²} {ğ­ = s (xâ‚˜â‚Šâ‚ âˆ· ğ±) âˆ· ğ­} C

inâŠ¢ {ğ± = ğ±} P (Râˆ˜â¿ {n} {ğ­} {ğ¬} Dâ‚œ Dâ‚›)
    = let sâ‚œ âˆ™ Câ‚œ = inâŠ¢ P Dâ‚œ
          sâ‚› âˆ™ Câ‚› = inâŠ¢ P Dâ‚›
      in
        (Î» ğ± â†’ sâ‚œ ğ± âˆ˜^[ suc n ] sâ‚› ğ±)
      âˆ™ Râˆ˜â¿ {ğ­ = sâ‚œ ğ± âˆ· ğ­} {ğ¬ = sâ‚› ğ± âˆ· ğ¬} Câ‚œ Câ‚›

inâŠ¢ {ğ± = ğ±} P (Rğ‘â¿ {n} {ğ­} {ğ¬} Dâ‚œ Dâ‚›)
    = let sâ‚œ âˆ™ Câ‚œ = inâŠ¢ P Dâ‚œ
          sâ‚› âˆ™ Câ‚› = inâŠ¢ P Dâ‚›
      in
        (Î» ğ± â†’ ğ‘^[ suc n ]âŸ¨ sâ‚œ ğ± , sâ‚› ğ± âŸ©)
      âˆ™ Rğ‘â¿ {ğ­ = sâ‚œ ğ± âˆ· ğ­} {ğ¬ = sâ‚› ğ± âˆ· ğ¬} Câ‚œ Câ‚›

inâŠ¢ {ğ± = ğ±} P (Rğœ‹â‚€â¿ {n} {ğ­} D)
    = let s âˆ™ C = inâŠ¢ P D
      in
        (Î» ğ± â†’ ğœ‹â‚€^[ suc n ] s ğ±)
      âˆ™ Rğœ‹â‚€â¿ {ğ­ = s ğ± âˆ· ğ­} C

inâŠ¢ {ğ± = ğ±} P (Rğœ‹â‚â¿ {n} {ğ­} D)
    = let s âˆ™ C = inâŠ¢ P D
      in
        (Î» ğ± â†’ ğœ‹â‚^[ suc n ] s ğ±)
      âˆ™ Rğœ‹â‚â¿ {ğ­ = s ğ± âˆ· ğ­} C

inâŠ¢ {ğ± = ğ±} P (Râ‡‘â¿ {n} {ğ­} D)
    = let s âˆ™ C = inâŠ¢ P D
      in
        (Î» ğ± â†’ â‡‘^[ suc n ] s ğ±)
      âˆ™ Râ‡‘â¿ {ğ­ = s ğ± âˆ· ğ­} C

inâŠ¢ {ğ± = ğ±} P (Râ‡“â¿ {n} {ğ­} D)
    = let s âˆ™ C = inâŠ¢ P D
      in
        (Î» ğ± â†’ â‡“^[ suc n ] s ğ±)
      âˆ™ Râ‡“â¿ {ğ­ = s ğ± âˆ· ğ­} C
