{-

An implementation of the Alt-ArtÃ«mov system Î»âˆ
==============================================

MiÃ«tek Bak  <mietek@bak.io>


Work in progress.  Checked with Agda 2.4.2.5.

For easy editing with Emacs agda-mode, add to your .emacs file:

'(agda-input-user-translations
   (quote
    (("N" "â„•")
     ("not" "Â¬") ("imp" "âŠƒ") ("iff" "âŠƒâŠ‚") ("ent" "âŠ¢") ("thm" "âŠ©")
     ("A" "ğ€") ("a" "ğš") ("s" "ğ¬") ("t" "ğ­") ("x" "ğ±") ("y" "ğ²")
     ("v" "ğœˆ") ("v0" "ğœˆâ°") ("v1" "ğœˆ") ("v2" "ğœˆÂ²") ("vn" "ğœˆâ¿")
     ("l" "ğœ†") ("l0" "ğœ†â°") ("l1" "ğœ†") ("l2" "ğœ†Â²") ("ln" "ğœ†â¿") ("." "ï¼")
     ("o" "âˆ˜") ("o0" "âˆ˜â°") ("o1" "âˆ˜") ("o2" "âˆ˜Â²") ("on" "âˆ˜â¿")
     ("p" "ğ‘") ("p0" "ğ‘â°") ("p1" "ğ‘") ("p2" "ğ‘Â²") ("pn" "ğ‘â¿")
     ("1" "ğœ‹â‚€") ("10" "ğœ‹â‚€â°") ("11" "ğœ‹â‚€") ("12" "ğœ‹â‚€Â²") ("1n" "ğœ‹â‚€â¿")
     ("2" "ğœ‹â‚") ("20" "ğœ‹â‚â°") ("21" "ğœ‹â‚") ("12" "ğœ‹â‚Â²") ("2n" "ğœ‹â‚â¿")
     ("u" "â‡‘") ("u0" "â‡‘â°") ("u1" "â‡‘") ("u2" "â‡‘Â²") ("un" "â‡‘â¿")
     ("d" "â‡“") ("d0" "â‡“â°") ("d1" "â‡“") ("d2" "â‡“Â²") ("dn" "â‡“â¿"))))


[1]: Alt, J., ArtÃ«mov, S. (2001) Reflective Î»-calculus, Proceedings of the
     2001 International Seminar on Proof Theory in Computer Science (PTCSâ€™01),
     Lecture Notes in Computer Science, vol. 2183, pp. 22â€“37.
     http://dx.doi.org/10.1007/3-540-45504-3_2

-}


module AltArtemov where

open import Data.Nat using (â„• ; zero ; suc)
open import Data.Product using (Î£ ; _Ã—_) renaming (_,_ to _âˆ™_)

infixl 9 !_ ğœˆ_
infixl 8 _âˆ˜_ _âˆ˜Â²_ _âˆ˜^[_]_
infixr 7 â‡‘_ â‡‘Â²_ â‡‘^[_]_ â‡“_ â‡“Â²_ â‡“^[_]_
infixr 6 ğœ†_ï¼_ ğœ†Â²_ï¼_ ğœ†^[_]_ï¼_
infixr 5 _âˆ¶_ _âˆ·_
infixr 4 Â¬_
infixl 3 _,_ _âˆ§_
infixr 2 _âŠƒ_ _âŠƒâŠ‚_
infixr 1 _âˆˆ_ _âŠ†_ _%_
infixr 0 _âŠ¢_ âŠ©_


mutual

  -- Variables

  data Var : Set where    -- XXX: Fix this!


  -- Term constructors

  data Tm : Set where
    ğœˆ_         : Var            â†’ Tm    -- Variable
    ğœ†^[_]_ï¼_   : â„•   â†’ Var â†’ Tm â†’ Tm    -- Abstraction
    _âˆ˜^[_]_    : Tm  â†’ â„•   â†’ Tm â†’ Tm    -- Application
    ğ‘^[_]âŸ¨_,_âŸ© : â„•   â†’ Tm  â†’ Tm â†’ Tm    -- Pairing
    ğœ‹â‚€^[_]_    : â„•   â†’ Tm       â†’ Tm    -- Left projection
    ğœ‹â‚^[_]_    : â„•   â†’ Tm       â†’ Tm    -- Right projection
    !_         : Tm             â†’ Tm    -- Proof checking
    â‡‘^[_]_     : â„•   â†’ Tm       â†’ Tm    -- Reification
    â‡“^[_]_     : â„•   â†’ Tm       â†’ Tm    -- Reflection


  -- Type constructors

  data Ty : Set where
    âŠ¥   :           Ty    -- Falsehood
    _âŠƒ_ : Ty â†’ Ty â†’ Ty    -- Implication
    _âˆ§_ : Ty â†’ Ty â†’ Ty    -- Conjunction
    _âˆ¶_ : Tm â†’ Ty â†’ Ty    -- Provability


-- Type examples

âŠ¤      : Ty               -- Truth
âŠ¤      = âŠ¥ âŠƒ âŠ¥

Â¬_     : Ty â†’ Ty          -- Negation
Â¬ A    = A âŠƒ âŠ¥

_âŠƒâŠ‚_   : Ty â†’ Ty â†’ Ty     -- Equivalence
A âŠƒâŠ‚ B = A âŠƒ B âˆ§ B âŠƒ A


-- ------------------------------------------------------------------------------------------------

-- Vectors

data Vec (X : Set) : â„• â†’ Set where
  âˆ…   :                      Vec X zero
  _âˆ·_ : âˆ€{n} â†’ X â†’ Vec X n â†’ Vec X (suc n)

foldl : âˆ€{n} {X Y : Set} â†’ (Y â†’ X â†’ Y) â†’ Y â†’ Vec X n â†’ Y
foldl f yâ‚€ âˆ…       = yâ‚€
foldl f yâ‚€ (x âˆ· ğ±) = f (foldl f yâ‚€ ğ±) x

foldr : âˆ€{n} {X Y : Set} â†’ (X â†’ Y â†’ Y) â†’ Vec X n â†’ Y â†’ Y
foldr f âˆ…       yâ‚€ = yâ‚€
foldr f (x âˆ· ğ±) yâ‚€ = f x (foldr f ğ± yâ‚€)

map# : âˆ€{n} {X Y : Set} â†’ (â„• â†’ X â†’ Y) â†’ Vec X n â†’ Vec Y n
map# {zero}  f âˆ…       = âˆ…
map# {suc n} f (x âˆ· ğ±) = f (suc n) x âˆ· map# f ğ±

map2# : âˆ€{n} {X Y Z : Set} â†’ (â„• â†’ X â†’ Y â†’ Z) â†’ Vec X n â†’ Vec Y n â†’ Vec Z n
map2# {zero}  f âˆ…       âˆ…       = âˆ…
map2# {suc n} f (x âˆ· ğ±) (y âˆ· ğ²) = f (suc n) x y âˆ· map2# f ğ± ğ²

map : âˆ€{n} {X Y : Set} â†’ (X â†’ Y) â†’ Vec X n â†’ Vec Y n
map f = map# (Î» _ x â†’ f x)

map2 : âˆ€{n} {X Y Z : Set} â†’ (X â†’ Y â†’ Z) â†’ Vec X n â†’ Vec Y n â†’ Vec Z n
map2 f = map2# (Î» _ x y â†’ f x y)


-- Vector notation

VVar : â„• â†’ Set
VVar = Vec Var

VTm  : â„• â†’ Set
VTm  = Vec Tm

VTy  : â„• â†’ Set
VTy  = Vec Ty

â‹†_âˆ¶_           : âˆ€{n} â†’ VTm n â†’ Ty â†’ Ty
â‹† ğ­ âˆ¶ A        = foldr _âˆ¶_ ğ­ A

ğœˆâ¿_âˆ¶_          : âˆ€{n} â†’ VVar n â†’ Ty â†’ Ty
ğœˆâ¿ ğ± âˆ¶ A       = â‹† (map ğœˆ_ ğ±) âˆ¶ A

ğœ†â¿_ï¼_âˆ¶_        : âˆ€{n} â†’ VVar n â†’ VTm n â†’ Ty â†’ Ty
ğœ†â¿ ğ± ï¼ ğ­ âˆ¶ A   = â‹† (map2# ğœ†^[_]_ï¼_ ğ± ğ­) âˆ¶ A

_âˆ˜â¿_âˆ¶_         : âˆ€{n} â†’ VTm n â†’ VTm n â†’ Ty â†’ Ty
ğ­ âˆ˜â¿ ğ¬ âˆ¶ A     = â‹† (map2# (Î» n t s â†’ t âˆ˜^[ n ] s) ğ­ ğ¬) âˆ¶ A

ğ‘â¿âŸ¨_,_âŸ©âˆ¶_      : âˆ€{n} â†’ VTm n â†’ VTm n â†’ Ty â†’ Ty
ğ‘â¿âŸ¨ ğ­ , ğ¬ âŸ©âˆ¶ A = â‹† (map2# ğ‘^[_]âŸ¨_,_âŸ© ğ­ ğ¬) âˆ¶ A

ğœ‹â‚€â¿_âˆ¶_         : âˆ€{n} â†’ VTm n â†’ Ty â†’ Ty
ğœ‹â‚€â¿ ğ­ âˆ¶ A      = â‹† (map# ğœ‹â‚€^[_]_ ğ­) âˆ¶ A

ğœ‹â‚â¿_âˆ¶_         : âˆ€{n} â†’ VTm n â†’ Ty â†’ Ty
ğœ‹â‚â¿ ğ­ âˆ¶ A      = â‹† (map# ğœ‹â‚^[_]_ ğ­) âˆ¶ A

â‡‘â¿_âˆ¶_          : âˆ€{n} â†’ VTm n â†’ Ty â†’ Ty
â‡‘â¿ ğ­ âˆ¶ A       = â‹† (map# â‡‘^[_]_ ğ­) âˆ¶ A

â‡“â¿_âˆ¶_          : âˆ€{n} â†’ VTm n â†’ Ty â†’ Ty
â‡“â¿ ğ­ âˆ¶ A       = â‹† (map# â‡“^[_]_ ğ­) âˆ¶ A


-- ------------------------------------------------------------------------------------------------

-- Lists

data List (X : Set) : Set where
  âˆ…   :              List X
  _,_ : List X â†’ X â†’ List X


-- List membership

data _âˆˆ_ {X : Set} (x : X) : List X â†’ Set where
  Z   : {Î“ : List X}                 â†’ x âˆˆ Î“ , x
  S   : {Î“ : List X} {y : X} â†’ x âˆˆ Î“ â†’ x âˆˆ Î“ , y


-- Typing contexts

Cx : Set
Cx = List Ty


-- Typing rules

data _âŠ¢_ (Î“ : Cx) : Ty â†’ Set where
  Rğœˆâ¿  : âˆ€{n k} {ğ± : VVar n} {ğš : VVar k} {A : Ty}
       â†’ ğœˆâ¿ ğ± âˆ¶ A âˆˆ Î“
       â†’ Î“ âŠ¢ ğœˆâ¿ ğš âˆ¶ ğœˆâ¿ ğ± âˆ¶ A

  Rğœ†â¿  : âˆ€{n} {ğ± : VVar n} {ğ­ : VTm n} {A B : Ty}
       â†’ Î“ , ğœˆâ¿ ğ± âˆ¶ A âŠ¢ â‹† ğ­ âˆ¶ B
       â†’ Î“ âŠ¢ ğœ†â¿ ğ± ï¼ ğ­ âˆ¶ (A âŠƒ B)

  Râˆ˜â¿  : âˆ€{n} {ğ­ ğ¬ : VTm n} {A B : Ty}
       â†’ Î“ âŠ¢ â‹† ğ­ âˆ¶ (A âŠƒ B)    â†’ Î“ âŠ¢ â‹† ğ¬ âˆ¶ A
       â†’ Î“ âŠ¢ ğ­ âˆ˜â¿ ğ¬ âˆ¶ B

  Rğ‘â¿  : âˆ€{n} {ğ­ ğ¬ : VTm n} {A B : Ty}
       â†’ Î“ âŠ¢ â‹† ğ­ âˆ¶ A    â†’ Î“ âŠ¢ â‹† ğ¬ âˆ¶ B
       â†’ Î“ âŠ¢ ğ‘â¿âŸ¨ ğ­ , ğ¬ âŸ©âˆ¶ (A âˆ§ B)

  Rğœ‹â‚€â¿ : âˆ€{n} {ğ­ : VTm n} {A B : Ty}
       â†’ Î“ âŠ¢ â‹† ğ­ âˆ¶ (A âˆ§ B)
       â†’ Î“ âŠ¢ ğœ‹â‚€â¿ ğ­ âˆ¶ A

  Rğœ‹â‚â¿ : âˆ€{n} {ğ­ : VTm n} {A B : Ty}
       â†’ Î“ âŠ¢ â‹† ğ­ âˆ¶ (A âˆ§ B)
       â†’ Î“ âŠ¢ ğœ‹â‚â¿ ğ­ âˆ¶ B

  Râ‡‘â¿  : âˆ€{n} {ğ­ : VTm n} {u : Tm} {A : Ty}
       â†’ Î“ âŠ¢ â‹† ğ­ âˆ¶ (u âˆ¶ A)
       â†’ Î“ âŠ¢ â‡‘â¿ ğ­ âˆ¶ (! u âˆ¶ u âˆ¶ A)

  Râ‡“â¿  : âˆ€{n} {ğ­ : VTm n} {u : Tm} {A : Ty}
       â†’ Î“ âŠ¢ â‹† ğ­ âˆ¶ (u âˆ¶ A)
       â†’ Î“ âŠ¢ â‡“â¿ ğ­ âˆ¶ A


-- Corollary of variable typing rule

{- â€œAs soon as we are able to establish that A is a type (â€¦), we are entitled
    to use variables of type A as new axioms.â€ (p. 27 [1]) -}

Rğœˆâ¿â€² : âˆ€{n A Î“} {ğ± : VVar n}
     â†’ A âˆˆ Î“
     â†’ Î“ âŠ¢ ğœˆâ¿ ğ± âˆ¶ A
Rğœˆâ¿â€² {ğ± = ğ±}
     = Rğœˆâ¿ {ğ± = âˆ…} {ğš = ğ±}


-- Theorems

âŠ©_  : Ty â†’ Set
âŠ© A = âˆ€{Î“} â†’ Î“ âŠ¢ A


-- ------------------------------------------------------------------------------------------------

-- Level 0: Simplified typing rules

Rğœˆâ°  : âˆ€{A Î“}
     â†’ A âˆˆ Î“
     â†’ Î“ âŠ¢ A
Rğœˆâ°  = Rğœˆâ¿ {ğ± = âˆ…} {ğš = âˆ…}

Rğœ†â°  : âˆ€{A B Î“}
     â†’ Î“ , A âŠ¢ B
     â†’ Î“ âŠ¢ A âŠƒ B
Rğœ†â°  = Rğœ†â¿ {ğ± = âˆ…} {ğ­ = âˆ…}

Râˆ˜â°  : âˆ€{A B Î“}
     â†’ Î“ âŠ¢ A âŠƒ B    â†’ Î“ âŠ¢ A
     â†’ Î“ âŠ¢ B
Râˆ˜â°  = Râˆ˜â¿ {ğ­ = âˆ…} {ğ¬ = âˆ…}

Rğ‘â°  : âˆ€{A B Î“}
     â†’ Î“ âŠ¢ A    â†’ Î“ âŠ¢ B
     â†’ Î“ âŠ¢ A âˆ§ B
Rğ‘â°  = Rğ‘â¿ {ğ­ = âˆ…} {ğ¬ = âˆ…}

Rğœ‹â‚€â° : âˆ€{A B Î“}
     â†’ Î“ âŠ¢ A âˆ§ B
     â†’ Î“ âŠ¢ A
Rğœ‹â‚€â° = Rğœ‹â‚€â¿ {ğ­ = âˆ…}

Rğœ‹â‚â° : âˆ€{A B Î“}
     â†’ Î“ âŠ¢ A âˆ§ B
     â†’ Î“ âŠ¢ B
Rğœ‹â‚â° = Rğœ‹â‚â¿ {ğ­ = âˆ…}


-- Level 0: Examples

eIâ° : âˆ€{A}
    â†’ âŠ© A âŠƒ A
eIâ° = Rğœ†â° (Rğœˆâ° Z)


eKâ° : âˆ€{A B}
    â†’ âŠ© A âŠƒ B âŠƒ A
eKâ° = Rğœ†â° (Rğœ†â° (Rğœˆâ° (S Z)))


eSâ° : âˆ€{A B C}
    â†’ âŠ© (A âŠƒ B âŠƒ C) âŠƒ (A âŠƒ B) âŠƒ A âŠƒ C
eSâ° = Rğœ†â° (Rğœ†â° (Rğœ†â° (Râˆ˜â° (Râˆ˜â° (Rğœˆâ° (S (S Z)))
                              (Rğœˆâ° Z))
                         (Râˆ˜â° (Rğœˆâ° (S Z))
                              (Rğœˆâ° Z)))))


-- ------------------------------------------------------------------------------------------------

-- Level 1: Simplified term constructors

ğœ†_ï¼_       : Var â†’ Tm â†’ Tm
ğœ† x ï¼ t    = ğœ†^[ 1 ] x ï¼ t

_âˆ˜_        : Tm â†’ Tm â†’ Tm
t âˆ˜ s      = t âˆ˜^[ 1 ] s

ğ‘âŸ¨_,_âŸ©     : Tm â†’ Tm â†’ Tm
ğ‘âŸ¨ t , s âŸ© = ğ‘^[ 1 ]âŸ¨ t , s âŸ©

ğœ‹â‚€_        : Tm â†’ Tm
ğœ‹â‚€ t       = ğœ‹â‚€^[ 1 ] t

ğœ‹â‚_        : Tm â†’ Tm
ğœ‹â‚ t       = ğœ‹â‚^[ 1 ] t

â‡‘_         : Tm â†’ Tm
â‡‘ t        = â‡‘^[ 1 ] t

â‡“_         : Tm â†’ Tm
â‡“ t        = â‡“^[ 1 ] t


-- Level 1: Simplified typing rules

Rğœˆ  : âˆ€{x A Î“}
    â†’ ğœˆ x âˆ¶ A âˆˆ Î“
    â†’ Î“ âŠ¢ ğœˆ x âˆ¶ A
Rğœˆ {x}
    = Rğœˆâ¿ {ğ± = x âˆ· âˆ…} {ğš = âˆ…}

Rğœ†  : âˆ€{x t A B Î“}
    â†’ Î“ , ğœˆ x âˆ¶ A âŠ¢ t âˆ¶ B
    â†’ Î“ âŠ¢ ğœ† x ï¼ t âˆ¶ (A âŠƒ B)
Rğœ† {x} {t}
    = Rğœ†â¿ {ğ± = x âˆ· âˆ…} {ğ­ = t âˆ· âˆ…}

Râˆ˜  : âˆ€{t s A B Î“}
    â†’ Î“ âŠ¢ t âˆ¶ (A âŠƒ B)    â†’ Î“ âŠ¢ s âˆ¶ A
    â†’ Î“ âŠ¢ t âˆ˜ s âˆ¶ B
Râˆ˜ {t} {s}
    = Râˆ˜â¿ {ğ­ = t âˆ· âˆ…} {ğ¬ = s âˆ· âˆ…}

Rğ‘  : âˆ€{t s A B Î“}
    â†’ Î“ âŠ¢ t âˆ¶ A    â†’ Î“ âŠ¢ s âˆ¶ B
    â†’ Î“ âŠ¢ ğ‘âŸ¨ t , s âŸ© âˆ¶ (A âˆ§ B)
Rğ‘ {t} {s}
    = Rğ‘â¿ {ğ­ = t âˆ· âˆ…} {ğ¬ = s âˆ· âˆ…}

Rğœ‹â‚€ : âˆ€{t A B Î“}
    â†’ Î“ âŠ¢ t âˆ¶ (A âˆ§ B)
    â†’ Î“ âŠ¢ ğœ‹â‚€ t âˆ¶ A
Rğœ‹â‚€ {t}
    = Rğœ‹â‚€â¿ {ğ­ = t âˆ· âˆ…}

Rğœ‹â‚ : âˆ€{t A B Î“}
    â†’ Î“ âŠ¢ t âˆ¶ (A âˆ§ B)
    â†’ Î“ âŠ¢ ğœ‹â‚ t âˆ¶ B
Rğœ‹â‚ {t}
    = Rğœ‹â‚â¿ {ğ­ = t âˆ· âˆ…}

Râ‡‘  : âˆ€{t u A Î“}
    â†’ Î“ âŠ¢ t âˆ¶ u âˆ¶ A
    â†’ Î“ âŠ¢ â‡‘ t âˆ¶ ! u âˆ¶ u âˆ¶ A
Râ‡‘ {t}
    = Râ‡‘â¿ {ğ­ = t âˆ· âˆ…}

Râ‡“  : âˆ€{t u A Î“}
    â†’ Î“ âŠ¢ t âˆ¶ u âˆ¶ A
    â†’ Î“ âŠ¢ â‡“ t âˆ¶ A
Râ‡“ {t}
    = Râ‡“â¿ {ğ­ = t âˆ· âˆ…}


-- Level 1: Examples

eI : âˆ€{x A}
   â†’ âŠ© ğœ† x ï¼ ğœˆ x
       âˆ¶ (A âŠƒ A)
eI = Rğœ† (Rğœˆ Z)


eK : âˆ€{x y A B}
   â†’ âŠ© ğœ† x ï¼ ğœ† y ï¼ ğœˆ x
       âˆ¶ (A âŠƒ B âŠƒ A)
eK = Rğœ† (Rğœ† (Rğœˆ (S Z)))


eS : âˆ€{f g x A B C}
   â†’ âŠ© ğœ† f ï¼ ğœ† g ï¼ ğœ† x ï¼ (ğœˆ f âˆ˜ ğœˆ x) âˆ˜ (ğœˆ g âˆ˜ ğœˆ x)
       âˆ¶ ((A âŠƒ B âŠƒ C) âŠƒ (A âŠƒ B) âŠƒ A âŠƒ C)
eS = Rğœ† (Rğœ† (Rğœ† (Râˆ˜ (Râˆ˜ (Rğœˆ (S (S Z)))
                        (Rğœˆ Z))
                    (Râˆ˜ (Rğœˆ (S Z))
                        (Rğœˆ Z)))))


-- ------------------------------------------------------------------------------------------------

-- Level 2: Simplified term constructors

ğœ†Â²_ï¼_       : Var â†’ Tm â†’ Tm
ğœ†Â² x ï¼ t    = ğœ†^[ 2 ] x ï¼ t

_âˆ˜Â²_        : Tm â†’ Tm â†’ Tm
t âˆ˜Â² s      = t âˆ˜^[ 2 ] s

ğ‘Â²âŸ¨_,_âŸ©     : Tm â†’ Tm â†’ Tm
ğ‘Â²âŸ¨ t , s âŸ© = ğ‘^[ 2 ]âŸ¨ t , s âŸ©

ğœ‹â‚€Â²_        : Tm â†’ Tm
ğœ‹â‚€Â² t       = ğœ‹â‚€^[ 2 ] t

ğœ‹â‚Â²_        : Tm â†’ Tm
ğœ‹â‚Â² t       = ğœ‹â‚^[ 2 ] t

â‡‘Â²_         : Tm â†’ Tm
â‡‘Â² t        = â‡‘^[ 2 ] t

â‡“Â²_         : Tm â†’ Tm
â‡“Â² t        = â‡“^[ 2 ] t


-- Level 2: Simplified typing rules

RğœˆÂ²  : âˆ€{xâ‚‚ xâ‚ A Î“}
     â†’ ğœˆ xâ‚‚ âˆ¶ ğœˆ xâ‚ âˆ¶ A âˆˆ Î“
     â†’ Î“ âŠ¢ ğœˆ xâ‚‚ âˆ¶ ğœˆ xâ‚ âˆ¶ A
RğœˆÂ² {xâ‚‚} {xâ‚}
     = Rğœˆâ¿ {ğ± = xâ‚‚ âˆ· xâ‚ âˆ· âˆ…} {ğš = âˆ…}

Rğœ†Â²  : âˆ€{xâ‚‚ xâ‚ tâ‚‚ tâ‚ A B Î“}
     â†’ Î“ , ğœˆ xâ‚‚ âˆ¶ ğœˆ xâ‚ âˆ¶ A âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ B
     â†’ Î“ âŠ¢ ğœ†Â² xâ‚‚ ï¼ tâ‚‚ âˆ¶ ğœ† xâ‚ ï¼ tâ‚ âˆ¶ (A âŠƒ B)
Rğœ†Â² {xâ‚‚} {xâ‚} {tâ‚‚} {tâ‚}
     = Rğœ†â¿ {ğ± = xâ‚‚ âˆ· xâ‚ âˆ· âˆ…} {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…}

Râˆ˜Â²  : âˆ€{tâ‚‚ tâ‚ sâ‚‚ sâ‚ A B Î“}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ (A âŠƒ B)    â†’ Î“ âŠ¢ sâ‚‚ âˆ¶ sâ‚ âˆ¶ A
     â†’ Î“ âŠ¢ tâ‚‚ âˆ˜Â² sâ‚‚ âˆ¶ tâ‚ âˆ˜ sâ‚ âˆ¶ B
Râˆ˜Â² {tâ‚‚} {tâ‚} {sâ‚‚} {sâ‚}
     = Râˆ˜â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…} {ğ¬ = sâ‚‚ âˆ· sâ‚ âˆ· âˆ…}

Rğ‘Â²  : âˆ€{tâ‚‚ tâ‚ sâ‚‚ sâ‚ A B Î“}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ A    â†’ Î“ âŠ¢ sâ‚‚ âˆ¶ sâ‚ âˆ¶ B
     â†’ Î“ âŠ¢ ğ‘Â²âŸ¨ tâ‚‚ , sâ‚‚ âŸ© âˆ¶ ğ‘âŸ¨ tâ‚ , sâ‚ âŸ© âˆ¶ (A âˆ§ B)
Rğ‘Â² {tâ‚‚} {tâ‚} {sâ‚‚} {sâ‚}
     = Rğ‘â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…} {ğ¬ = sâ‚‚ âˆ· sâ‚ âˆ· âˆ…}

Rğœ‹â‚€Â² : âˆ€{tâ‚‚ tâ‚ A B Î“}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ (A âˆ§ B)
     â†’ Î“ âŠ¢ ğœ‹â‚€Â² tâ‚‚ âˆ¶ ğœ‹â‚€ tâ‚ âˆ¶ A
Rğœ‹â‚€Â² {tâ‚‚} {tâ‚}
     = Rğœ‹â‚€â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…}

Rğœ‹â‚Â² : âˆ€{tâ‚‚ tâ‚ A B Î“}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ (A âˆ§ B)
     â†’ Î“ âŠ¢ ğœ‹â‚Â² tâ‚‚ âˆ¶ ğœ‹â‚ tâ‚ âˆ¶ B
Rğœ‹â‚Â² {tâ‚‚} {tâ‚}
     = Rğœ‹â‚â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…}

Râ‡‘Â²  : âˆ€{tâ‚‚ tâ‚ u A Î“}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ u âˆ¶ A
     â†’ Î“ âŠ¢ â‡‘Â² tâ‚‚ âˆ¶ â‡‘ tâ‚ âˆ¶ ! u âˆ¶ u âˆ¶ A
Râ‡‘Â² {tâ‚‚} {tâ‚}
     = Râ‡‘â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…}

Râ‡“Â²  : âˆ€{tâ‚‚ tâ‚ u A Î“}
     â†’ Î“ âŠ¢ tâ‚‚ âˆ¶ tâ‚ âˆ¶ u âˆ¶ A
     â†’ Î“ âŠ¢ â‡“Â² tâ‚‚ âˆ¶ â‡“ tâ‚ âˆ¶ A
Râ‡“Â² {tâ‚‚} {tâ‚}
     = Râ‡“â¿ {ğ­ = tâ‚‚ âˆ· tâ‚ âˆ· âˆ…}


-- Level 2: Examples

eIÂ² : âˆ€{u x A}
    â†’ âŠ© ğœ†Â² u ï¼ ğœˆ u
        âˆ¶ ğœ† x ï¼ ğœˆ x
          âˆ¶ (A âŠƒ A)
eIÂ² = Rğœ†Â² (RğœˆÂ² Z)


eKÂ² : âˆ€{u x v y A B}
    â†’ âŠ© ğœ†Â² u ï¼ ğœ†Â² v ï¼ ğœˆ u
        âˆ¶ ğœ† x ï¼ ğœ† y ï¼ ğœˆ x
          âˆ¶ (A âŠƒ B âŠƒ A)
eKÂ² = Rğœ†Â² (Rğœ†Â² (RğœˆÂ² (S Z)))


eSÂ² : âˆ€{f g x A B C}
    â†’ âŠ© ğœ†Â² f ï¼ ğœ†Â² g ï¼ ğœ†Â² x ï¼ (ğœˆ f âˆ˜Â² ğœˆ x) âˆ˜Â² (ğœˆ g âˆ˜Â² ğœˆ x)
        âˆ¶ ğœ† f ï¼ ğœ† g ï¼ ğœ† x ï¼ (ğœˆ f âˆ˜ ğœˆ x) âˆ˜ (ğœˆ g âˆ˜ ğœˆ x)
          âˆ¶ ((A âŠƒ B âŠƒ C) âŠƒ (A âŠƒ B) âŠƒ A âŠƒ C)
eSÂ² = Rğœ†Â² (Rğœ†Â² (Rğœ†Â² (Râˆ˜Â² (Râˆ˜Â² (RğœˆÂ² (S (S Z)))
                              (RğœˆÂ² Z))
                         (Râˆ˜Â² (RğœˆÂ² (S Z))
                              (RğœˆÂ² Z)))))


-- ------------------------------------------------------------------------------------------------

-- Example 1 (p. 28 [1])

e1a : âˆ€{x y A}
    â†’ âŠ© ğœ† y ï¼ â‡“ ğœˆ y
        âˆ¶ (ğœˆ x âˆ¶ A âŠƒ A)
e1a = Rğœ† (Râ‡“ (Rğœˆ Z))


e1b : âˆ€{x y A}
    â†’ âŠ© ğœ† y ï¼ â‡‘ ğœˆ y
        âˆ¶ (ğœˆ x âˆ¶ A âŠƒ ! ğœˆ x âˆ¶ ğœˆ x âˆ¶ A)
e1b = Rğœ† (Râ‡‘ (Rğœˆ Z))


e1c : âˆ€{u x v y A B}
    â†’ âŠ© ğœ†Â² u ï¼ ğœ†Â² v ï¼ ğ‘Â²âŸ¨ ğœˆ u , ğœˆ v âŸ©
        âˆ¶ ğœ† x ï¼ ğœ† y ï¼ ğ‘âŸ¨ ğœˆ x , ğœˆ y âŸ©
          âˆ¶ (A âŠƒ B âŠƒ A âˆ§ B)
e1c = Rğœ†Â² (Rğœ†Â² (Rğ‘Â² (RğœˆÂ² (S Z))
                    (RğœˆÂ² Z)))


e1d : âˆ€{u x v y A B}
    â†’ âŠ© ğœ† u ï¼ ğœ† v ï¼ â‡‘ ğ‘Â²âŸ¨ ğœˆ u , ğœˆ v âŸ©
        âˆ¶ (ğœˆ x âˆ¶ A âŠƒ ğœˆ y âˆ¶ B âŠƒ ! ğ‘âŸ¨ ğœˆ x , ğœˆ y âŸ© âˆ¶ ğ‘âŸ¨ ğœˆ x , ğœˆ y âŸ© âˆ¶ (A âˆ§ B))
e1d = Rğœ† (Rğœ† (Râ‡‘ (Rğ‘Â² (Rğœˆ (S Z))
                      (Rğœˆ Z))))


-- Example 2 (pp. 31â€“32 [1])

e2a : âˆ€{xâ‚ƒ xâ‚‚ xâ‚ A}
    â†’ âŠ© ğœ†Â² xâ‚ƒ ï¼ â‡“Â² â‡‘Â² ğœˆ xâ‚ƒ
        âˆ¶ ğœ† xâ‚‚ ï¼ â‡“ â‡‘ ğœˆ xâ‚‚
          âˆ¶ (ğœˆ xâ‚ âˆ¶ A âŠƒ ğœˆ xâ‚ âˆ¶ A)
e2a = Rğœ†Â² (Râ‡“Â² (Râ‡‘Â² (RğœˆÂ² Z)))


e2b : âˆ€{xâ‚ƒ xâ‚‚ xâ‚ A}
    â†’ âŠ© ğœ†Â² xâ‚ƒ ï¼ ğœˆ xâ‚ƒ
        âˆ¶ ğœ† xâ‚‚ ï¼ ğœˆ xâ‚‚
          âˆ¶ (ğœˆ xâ‚ âˆ¶ A âŠƒ ğœˆ xâ‚ âˆ¶ A)
e2b = Rğœ†Â² (RğœˆÂ² Z)


-- ------------------------------------------------------------------------------------------------

-- Weakening

data _âŠ†_ {X : Set} : List X â†’ List X â†’ Set where
  base : âˆ… âŠ† âˆ…

  keep : {Î“ F : List X} {x : X}
       â†’ Î“ âŠ† F
       â†’ Î“ , x âŠ† F , x

  drop : {Î“ F : List X} {x : X}
       â†’ Î“ âŠ† F
       â†’ Î“ âŠ† F , x


-- Weakening: List membership

wkâˆˆ : {X : Set} {Î“ F : List X} {x : X}
    â†’ Î“ âŠ† F    â†’ x âˆˆ Î“
    â†’ x âˆˆ F
wkâˆˆ (keep Î“âŠ†F) Z     = Z
wkâˆˆ (keep Î“âŠ†F) (S i) = S (wkâˆˆ Î“âŠ†F i)
wkâˆˆ (drop Î“âŠ†F) i     = S (wkâˆˆ Î“âŠ†F i)


-- Weakening: Typing rules

wkâŠ¢ : {Î“ F : Cx} {A : Ty}
    â†’ Î“ âŠ† F    â†’ Î“ âŠ¢ A
    â†’ F âŠ¢ A
wkâŠ¢ Î“âŠ†F (Rğœˆâ¿  {ğ± = ğ±} {ğš = ğš} i)     = Rğœˆâ¿  {ğ± = ğ±} {ğš = ğš} (wkâˆˆ Î“âŠ†F i)
wkâŠ¢ Î“âŠ†F (Rğœ†â¿  {ğ± = ğ±} {ğ­ = ğ­} D)     = Rğœ†â¿  {ğ± = ğ±} {ğ­ = ğ­} (wkâŠ¢ (keep Î“âŠ†F) D)
wkâŠ¢ Î“âŠ†F (Râˆ˜â¿  {ğ­ = ğ­} {ğ¬ = ğ¬} Dâ‚œ Dâ‚›) = Râˆ˜â¿  {ğ­ = ğ­} {ğ¬ = ğ¬} (wkâŠ¢ Î“âŠ†F Dâ‚œ) (wkâŠ¢ Î“âŠ†F Dâ‚›)
wkâŠ¢ Î“âŠ†F (Rğ‘â¿  {ğ­ = ğ­} {ğ¬ = ğ¬} Dâ‚œ Dâ‚›) = Rğ‘â¿  {ğ­ = ğ­} {ğ¬ = ğ¬} (wkâŠ¢ Î“âŠ†F Dâ‚œ) (wkâŠ¢ Î“âŠ†F Dâ‚›)
wkâŠ¢ Î“âŠ†F (Rğœ‹â‚€â¿ {ğ­ = ğ­} D)             = Rğœ‹â‚€â¿ {ğ­ = ğ­} (wkâŠ¢ Î“âŠ†F D)
wkâŠ¢ Î“âŠ†F (Rğœ‹â‚â¿ {ğ­ = ğ­} D)             = Rğœ‹â‚â¿ {ğ­ = ğ­} (wkâŠ¢ Î“âŠ†F D)
wkâŠ¢ Î“âŠ†F (Râ‡‘â¿  {ğ­ = ğ­} D)             = Râ‡‘â¿  {ğ­ = ğ­} (wkâŠ¢ Î“âŠ†F D)
wkâŠ¢ Î“âŠ†F (Râ‡“â¿  {ğ­ = ğ­} D)             = Râ‡“â¿  {ğ­ = ğ­} (wkâŠ¢ Î“âŠ†F D)


-- ------------------------------------------------------------------------------------------------

-- Exchange

data _%_ {X : Set} : List X â†’ List X â†’ Set where
  base : âˆ… % âˆ…

  weak : {Î“ F : List X} {x : X}
       â†’ Î“ % F
       â†’ Î“ , x % F , x

  same : {Î“ F : List X} {x y : X}
       â†’ Î“ % F
       â†’ Î“ , x , y % F , x , y

  diff : {Î“ F : List X} {x y : X}
       â†’ Î“ % F
       â†’ Î“ , y , x % F , x , y


-- Exchange: List membership

exâˆˆ : {X : Set} {Î“ F : List X} {x : X}
    â†’ Î“ % F    â†’ x âˆˆ Î“
    â†’ x âˆˆ F
exâˆˆ base       i         = i
exâˆˆ (weak Î“%F) Z         = Z
exâˆˆ (weak Î“%F) (S i)     = S (exâˆˆ Î“%F i)
exâˆˆ (same Î“%F) Z         = Z
exâˆˆ (same Î“%F) (S Z)     = S Z
exâˆˆ (same Î“%F) (S (S i)) = S (S (exâˆˆ Î“%F i))
exâˆˆ (diff Î“%F) Z         = S Z
exâˆˆ (diff Î“%F) (S Z)     = Z
exâˆˆ (diff Î“%F) (S (S i)) = S (S (exâˆˆ Î“%F i))


-- Exchange: Typing rules

exâŠ¢ : {Î“ F : Cx} {A : Ty}
    â†’ Î“ % F    â†’ Î“ âŠ¢ A
    â†’ F âŠ¢ A
exâŠ¢ Î“%F (Rğœˆâ¿  {ğ± = ğ±} {ğš = ğš} i)     = Rğœˆâ¿  {ğ± = ğ±} {ğš = ğš} (exâˆˆ Î“%F i)
exâŠ¢ Î“%F (Rğœ†â¿  {ğ± = ğ±} {ğ­ = ğ­} D)     = Rğœ†â¿  {ğ± = ğ±} {ğ­ = ğ­} (exâŠ¢ (weak Î“%F) D)
exâŠ¢ Î“%F (Râˆ˜â¿  {ğ­ = ğ­} {ğ¬ = ğ¬} Dâ‚œ Dâ‚›) = Râˆ˜â¿  {ğ­ = ğ­} {ğ¬ = ğ¬} (exâŠ¢ Î“%F Dâ‚œ) (exâŠ¢ Î“%F Dâ‚›)
exâŠ¢ Î“%F (Rğ‘â¿  {ğ­ = ğ­} {ğ¬ = ğ¬} Dâ‚œ Dâ‚›) = Rğ‘â¿  {ğ­ = ğ­} {ğ¬ = ğ¬} (exâŠ¢ Î“%F Dâ‚œ) (exâŠ¢ Î“%F Dâ‚›)
exâŠ¢ Î“%F (Rğœ‹â‚€â¿ {ğ­ = ğ­} D)             = Rğœ‹â‚€â¿ {ğ­ = ğ­} (exâŠ¢ Î“%F D)
exâŠ¢ Î“%F (Rğœ‹â‚â¿ {ğ­ = ğ­} D)             = Rğœ‹â‚â¿ {ğ­ = ğ­} (exâŠ¢ Î“%F D)
exâŠ¢ Î“%F (Râ‡‘â¿  {ğ­ = ğ­} D)             = Râ‡‘â¿  {ğ­ = ğ­} (exâŠ¢ Î“%F D)
exâŠ¢ Î“%F (Râ‡“â¿  {ğ­ = ğ­} D)             = Râ‡“â¿  {ğ­ = ğ­} (exâŠ¢ Î“%F D)


-- ------------------------------------------------------------------------------------------------

-- Work in progress

mk : âˆ€{n} â†’ Cx â†’ VTy n â†’ Cx
mk = foldl _,_

mk2 : âˆ€{n} â†’ Cx â†’ VVar n â†’ VTy n â†’ Cx
mk2 Î“ ğ± ğ€ = mk Î“ (map2 _âˆ¶_ (map ğœˆ_ ğ±) ğ€)

postulate    -- XXX: Fix this!
  fresh : âˆ€{n} â†’ VVar n â†’ Var

  lm1 : âˆ€{n A Î“}
     â†’ (ğ± : VVar n)    â†’ (ğ€ : VTy n)    â†’ A âˆˆ mk Î“ ğ€
     â†’ A âˆˆ mk2 Î“ ğ± ğ€


-- Theorem 1: Internalisation principle

{- â€œLet Î»âˆ derive
        Aâ‚, Aâ‚‚, â€¦, Aâ‚˜ âŠ¢ B.
    Then one can build a well-defined term t(xâ‚, xâ‚‚, â€¦, xâ‚˜) with fresh
    variables ğ± such that Î»âˆ also derives
        xâ‚ âˆ¶ Aâ‚, xâ‚‚ âˆ¶ Aâ‚‚, â€¦, xâ‚˜ âˆ¶ Aâ‚˜ âŠ¢ t(xâ‚, xâ‚‚, â€¦, xâ‚˜) âˆ¶ B.â€ -}

th1 : âˆ€{m} {B : Ty} {Î“ : Cx}
    â†’ (ğ€ : VTy m)    â†’ mk Î“ ğ€ âŠ¢ B
    â†’ Î£ (VVar m â†’ Tm)
        (Î» t â†’ {ğ± : VVar m} â†’ mk2 Î“ ğ± ğ€ âŠ¢ t ğ± âˆ¶ B)

th1 ğ€ (Rğœˆâ¿ {ğ± = ğ²} {ğš} {A} i)
    = (Î» ğ±   â†’ let xâ‚˜â‚Šâ‚ = fresh ğ± in ğœˆ xâ‚˜â‚Šâ‚)
    âˆ™ (Î» {ğ±} â†’ let xâ‚˜â‚Šâ‚ = fresh ğ± in
                 Rğœˆâ¿ {ğ± = ğ²} {ğš = xâ‚˜â‚Šâ‚ âˆ· ğš} (lm1 ğ± ğ€ i))

th1 ğ€ (Rğœ†â¿ {n} {ğ²} {ğ­} {A} D)
    = let s âˆ™ E = th1 (ğœˆâ¿ ğ² âˆ¶ A âˆ· ğ€) D
      in
        (Î» ğ±   â†’ let xâ‚˜â‚Šâ‚ = fresh ğ± in
                   ğœ†^[ suc n ] xâ‚˜â‚Šâ‚ ï¼ s (xâ‚˜â‚Šâ‚ âˆ· ğ±))
      âˆ™ (Î» {ğ±} â†’ let xâ‚˜â‚Šâ‚ = fresh ğ± in
                   Rğœ†â¿ {ğ± = xâ‚˜â‚Šâ‚ âˆ· ğ²} {ğ­ = s (xâ‚˜â‚Šâ‚ âˆ· ğ±) âˆ· ğ­} E)

th1 ğ€ (Râˆ˜â¿ {n} {ğ­} {ğ¬} Dâ‚œ Dâ‚›)
    = let sâ‚œ âˆ™ Eâ‚œ = th1 ğ€ Dâ‚œ
          sâ‚› âˆ™ Eâ‚› = th1 ğ€ Dâ‚›
      in
        (Î» ğ±   â†’ sâ‚œ ğ± âˆ˜^[ suc n ] sâ‚› ğ±)
      âˆ™ (Î» {ğ±} â†’ Râˆ˜â¿ {ğ­ = sâ‚œ ğ± âˆ· ğ­} {ğ¬ = sâ‚› ğ± âˆ· ğ¬} Eâ‚œ Eâ‚›)

th1 ğ€ (Rğ‘â¿ {n} {ğ­} {ğ¬} Dâ‚œ Dâ‚›)
    = let sâ‚œ âˆ™ Eâ‚œ = th1 ğ€ Dâ‚œ
          sâ‚› âˆ™ Eâ‚› = th1 ğ€ Dâ‚›
      in
        (Î» ğ±   â†’ ğ‘^[ suc n ]âŸ¨ sâ‚œ ğ± , sâ‚› ğ± âŸ©)
      âˆ™ (Î» {ğ±} â†’ Rğ‘â¿ {ğ­ = sâ‚œ ğ± âˆ· ğ­} {ğ¬ = sâ‚› ğ± âˆ· ğ¬} Eâ‚œ Eâ‚›)

th1 ğ€ (Rğœ‹â‚€â¿ {n} {ğ­} D)
    = let s âˆ™ E = th1 ğ€ D
      in
        (Î» ğ±   â†’ ğœ‹â‚€^[ suc n ] s ğ±)
      âˆ™ (Î» {ğ±} â†’ Rğœ‹â‚€â¿ {ğ­ = s ğ± âˆ· ğ­} E)

th1 ğ€ (Rğœ‹â‚â¿ {n} {ğ­} D)
    = let s âˆ™ E = th1 ğ€ D
      in
        (Î» ğ±   â†’ ğœ‹â‚^[ suc n ] s ğ±)
      âˆ™ (Î» {ğ±} â†’ Rğœ‹â‚â¿ {ğ­ = s ğ± âˆ· ğ­} E)

th1 ğ€ (Râ‡‘â¿ {n} {ğ­} D)
    = let s âˆ™ E = th1 ğ€ D
      in
        (Î» ğ±   â†’ â‡‘^[ suc n ] s ğ±)
      âˆ™ (Î» {ğ±} â†’ Râ‡‘â¿ {ğ­ = s ğ± âˆ· ğ­} E)

th1 ğ€ (Râ‡“â¿ {n} {ğ­} D)
    = let s âˆ™ E = th1 ğ€ D
      in
        (Î» ğ±   â†’ â‡“^[ suc n ] s ğ±)
      âˆ™ (Î» {ğ±} â†’ Râ‡“â¿ {ğ­ = s ğ± âˆ· ğ­} E)
